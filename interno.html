<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Consulta y Turno Clientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Librerías para exportación -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .hidden { display: none !important; }
        .selected-row { background-color: #e0f2fe !important; }
        .sticky-toolbar { position: sticky; top: 0; z-index: 40; }
        .calendar-day { cursor: pointer; }
        .calendar-day:hover { background-color: #e6f7ff; }
        .calendar-day.selected { background-color: #3b82f6; color: white; }
        .calendar-day.disabled { color: #d1d5db; cursor: not-allowed; }
        
        /* Login */
        .login-container {
            min-height: 100vh;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 420px;
            overflow: hidden;
        }
        
        .login-header {
            background: linear-gradient(to right, #1e3a8a, #3b82f6);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        .login-body {
            padding: 35px 30px;
        }
        
        .login-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .login-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        
        .login-btn {
            width: 100%;
            background: linear-gradient(to right, #1e3a8a, #3b82f6);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }
        
        /* Notificación */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            display: flex;
            align-items: center;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
        }
        
        .notification.warning {
            background: #f59e0b;
        }
        
        .notification.error {
            background: #ef4444;
        }

        /* Modal de Alerta Sincronización */
        .modal-sincronizacion {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 10001;
            display: none;
            align-items: center;
            animation: fadeInScale 0.3s ease-out;
            min-width: 300px;
            max-width: 400px;
            text-align: center;
            border-top: 5px solid #10b981;
        }
        
        .modal-sincronizacion.error {
            border-top-color: #ef4444;
        }
        
        .modal-sincronizacion.active {
            display: flex;
            flex-direction: column;
        }
        
        .modal-sincronizacion i {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .modal-sincronizacion.success i {
            color: #10b981;
        }
        
        .modal-sincronizacion.error i {
            color: #ef4444;
        }
        
        .modal-sincronizacion h3 {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #1f2937;
        }
        
        .modal-sincronizacion p {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 20px;
        }
        
        .modal-sincronizacion button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .modal-sincronizacion.error button {
            background: #ef4444;
        }
        
        @keyframes fadeInScale {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        /* Modal de Alerta Roja para Eliminar */
        .modal-danger {
            animation: dangerPulse 0.5s ease-in-out;
            border: 3px solid #ef4444;
        }
        
        @keyframes dangerPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        /* Historial de notas */
        .historial-item {
            border-left: 3px solid #3b82f6;
            padding-left: 12px;
            margin-bottom: 12px;
        }
        
        .historial-item.resuelto {
            border-left-color: #10b981;
        }
        
        .historial-item.derivado {
            border-left-color: #8b5cf6;
        }
        
        @media (max-width: 640px) {
            .modal > div { margin: 1rem; max-height: 90vh; overflow-y: auto; }
            .modal-content-grid { grid-template-columns: 1fr !important; }
            .modal-buttons { flex-direction: column; }
            .modal-buttons button { width: 100%; margin-bottom: 0.5rem; }
            .modal-sincronizacion {
                min-width: 250px;
                margin: 0 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-container" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1 class="text-2xl font-bold">Consultas y Turnos Clientes</h1>
                <p class="opacity-90 mt-1">Uso de Defensor-Secretarios</p>
            </div>
            <div class="login-body">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Usuario</label>
                        <select id="login-usuario" class="login-input">
                            <option value="">Seleccionar usuario...</option>
                            <option value="Defensor Titular">Defensor Titular</option>
                            <option value="Defensor Subrogante">Defensor Subrogante</option>
                            <option value="Sec Riveros">Sec Riveros</option>
                            <option value="Sec Corrales">Sec Corrales</option>
                            <option value="Sec Magnani">Sec Magnani</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Contraseña</label>
                        <input type="password" id="login-password" class="login-input" placeholder="Ingrese la contraseña">
                    </div>
                    
                    <div id="login-error" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span id="login-error-text">Usuario o contraseña incorrectos</span>
                    </div>
                    
                    <button id="btn-login" class="login-btn">
                        <i class="fas fa-sign-in-alt mr-2"></i> Ingresar al Sistema
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application (Hidden until login) -->
    <div id="app-container" class="hidden">
        <!-- Notificación flotante -->
        <div id="notification-container"></div>
        
        <!-- Modal de Alerta Sincronización -->
        <div id="modal-sincronizacion" class="modal-sincronizacion">
            <i id="sincronizacion-icon" class="fas fa-check-circle"></i>
            <h3 id="sincronizacion-titulo">Éxito</h3>
            <p id="sincronizacion-mensaje">Agenda sincronizada correctamente. Los cambios se reflejarán en el formulario público.</p>
            <button id="btn-cerrar-sincronizacion">Aceptar</button>
        </div>
        
        <!-- Configuración de sonido -->
        <audio id="notification-sound" preload="auto">
            <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.wav" type="audio/wav">
        </audio>

        <!-- Modal de Confirmación de Eliminación (Alerta Roja) -->
        <div id="modal-eliminar" class="modal">
            <div class="bg-white rounded-xl w-full max-w-md mx-4 overflow-hidden modal-danger">
                <div class="bg-red-700 text-white p-4 flex justify-between items-center font-bold">
                    <span class="text-sm sm:text-base"><i class="fas fa-exclamation-triangle mr-2"></i>Confirmar Eliminación</span>
                    <button id="btn-cerrar-eliminar" class="text-2xl leading-none hover:text-red-200">&times;</button>
                </div>
                <div class="p-4 sm:p-6">
                    <div class="mb-6 text-center">
                        <i class="fas fa-trash-alt text-5xl text-red-600 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">¿Eliminar definitivamente?</h3>
                        <p class="text-gray-600">Esta acción <span class="font-bold text-red-600">NO SE PUEDE DESHACER</span>. Se borrarán todos los datos de esta consulta permanentemente.</p>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                        <p id="eliminar-info" class="text-sm text-gray-700"></p>
                    </div>
                    
                    <div class="flex justify-end space-x-4">
                        <button id="btn-cancelar-eliminar" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg text-sm font-bold hover:bg-gray-400 transition">
                            Cancelar
                        </button>
                        <button id="btn-confirmar-eliminar" class="bg-red-600 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-red-700 transition">
                            <i class="fas fa-trash mr-2"></i> Eliminar Definitivamente
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Comprobante de Turno -->
        <div id="modal-comprobante" class="modal">
            <div class="bg-white rounded-xl w-full max-w-md mx-4 overflow-hidden">
                <div class="bg-blue-800 text-white p-4 flex justify-between items-center font-bold">
                    <span class="text-sm sm:text-base">Comprobante de Turno</span>
                    <button id="btn-cerrar-comprobante" class="text-2xl leading-none">&times;</button>
                </div>
                <div class="p-4 sm:p-6 space-y-4">
                    <div class="text-center mb-4">
                        <i class="fas fa-file-pdf text-5xl text-red-500 mb-2"></i>
                        <h3 class="text-xl font-bold text-gray-800">Turno Asignado</h3>
                        <p class="text-gray-600">Defensoría Civil y Comercial 6</p>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Ciudadano:</span>
                            <span id="comp-nombre"></span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">DNI:</span>
                            <span id="comp-dni"></span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Teléfono:</span>
                            <span id="comp-telefono"></span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Tipo de Consulta:</span>
                            <span id="comp-tipo"></span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Fecha y Hora:</span>
                            <span id="comp-fecha-hora"></span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Usuario Asignado:</span>
                            <span id="comp-usuario"></span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Responsable que asigna:</span>
                            <span id="comp-responsable"></span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Estado:</span>
                            <span id="comp-estado"></span>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <p class="text-sm text-gray-500 mb-4 text-center">Este comprobante puede ser presentado al asistir a la Defensoría.</p>
                        <button id="btn-descargar-comprobante" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition">
                            <i class="fas fa-file-pdf mr-2"></i> Descargar Comprobante (PDF)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <header class="bg-gradient-to-r from-blue-900 to-blue-800 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="flex items-center">
                    <div>
                        <h1 class="text-lg sm:text-xl font-bold">Panel de Gestión de Consultas y Turnos</h1>
                        <p class="text-blue-200 text-sm">Defensoria Civil y Comercial 6</p>
                        <p class="text-blue-300 text-xs mt-1"><i class="fas fa-user mr-1"></i> Usuario: <span id="current-user-display">-</span></p>
                    </div>
                </div>
                <div class="mt-3 md:mt-0 flex flex-col md:flex-row items-start md:items-center space-y-2 md:space-y-0 md:space-x-4">
                    <div class="text-sm text-blue-200 font-bold">
                        Acceso Exclusivo al Defensor Oficial y/o Secretarios
                    </div>
                    <div class="text-right">
                        <p class="text-sm opacity-90"><i class="fas fa-clock mr-2"></i>Actualizado: <span id="ultima-actualizacion">--:--</span></p>
                        <button id="btn-logout" class="text-xs bg-red-600 hover:bg-red-700 px-3 py-1 rounded mt-1 transition">
                            <i class="fas fa-sign-out-alt mr-1"></i> Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-8">
            <!-- Panel de Navegación -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">Panel de Gestión</h2>
                <div class="flex flex-wrap gap-2">
                    <!-- Botón para regresar al Reporte de Inicio -->
                    <button id="btn-volver-inicio" class="bg-blue-800 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-blue-900">
                        <i class="fas fa-home mr-1"></i> Reporte de Inicio
                    </button>
                    <button id="btn-ver-atenciones" class="bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-blue-800">
                        <i class="fas fa-list mr-1"></i> Atenciones
                    </button>
                    <button id="btn-ver-turnos" class="bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-blue-800">
                        <i class="fas fa-calendar-day mr-1"></i> Turnos Web
                    </button>
                    <button id="btn-ver-calendario" class="bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-blue-800">
                        <i class="fas fa-calendar-alt mr-1"></i> Calendario
                    </button>
                    <button id="btn-gestion-agenda" class="bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-blue-800">
                        <i class="fas fa-cog mr-1"></i> Configurar
                    </button>
                </div>
            </div>

            <!-- Reporte de Inicio con Gráficos (Solo en vista Reporte de Inicio) -->
            <div id="dashboard-stats" class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Reporte de Inicio Analítico</h2>
                    <button id="btn-refresh-charts" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition">
                        <i class="fas fa-sync-alt mr-2"></i>Actualizar Gráficos
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow p-4">
                        <h3 class="font-bold text-gray-700 mb-4">Distribución por Tipo de Trámite</h3>
                        <canvas id="chart-tipos-tramites" height="250"></canvas>
                    </div>
                    <div class="bg-white rounded-xl shadow p-4">
                        <h3 class="font-bold text-gray-700 mb-4">Evolución Mensual de Casos</h3>
                        <canvas id="chart-evolucion-mensual" height="250"></canvas>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow p-4 sm:p-5 border-l-4 border-yellow-400">
                        <p class="text-gray-500 text-sm font-bold">Atenciones (Total)</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-800" id="atenciones-count">0</p>
                        <p class="text-xs text-gray-500 mt-1">Registros de atención</p>
                    </div>
                    <div class="bg-white rounded-xl shadow p-4 sm:p-5 border-l-4 border-blue-500">
                        <p class="text-gray-500 text-sm font-bold">Consultas Web (Total)</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-800" id="consultas-web-count">0</p>
                        <p class="text-xs text-gray-500 mt-1">Registros web</p>
                    </div>
                    <div class="bg-white rounded-xl shadow p-4 sm:p-5 border-l-4 border-green-500">
                        <p class="text-gray-500 text-sm font-bold">Resueltas (Totales)</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-800" id="resueltas-count">0</p>
                        <p class="text-xs text-gray-500 mt-1">Casos resueltos</p>
                    </div>
                    <div class="bg-white rounded-xl shadow p-4 sm:p-5 border-l-4 border-purple-500">
                        <p class="text-gray-500 text-sm font-bold">Totales</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-800" id="total-count">0</p>
                        <p class="text-xs text-gray-500 mt-1">Suma de atenciones y consultas web</p>
                    </div>
                </div>
            </div>

            <!-- Vista Atenciones -->
            <div id="cont-atenciones" class="hidden">
                <!-- Barra de herramientas avanzada para Atenciones -->
                <div class="sticky-toolbar bg-white rounded-xl shadow mb-6 p-3 sm:p-4">
                    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between">
                        <div class="w-full md:w-1/3">
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                <input type="text" id="busqueda-global" placeholder="Buscar por nombre, DNI o teléfono..." 
                                       class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                            </div>
                            
                            <!-- Filtros Avanzados -->
                            <div class="flex flex-wrap gap-2 mt-2">
                                <div class="flex items-center space-x-2">
                                    <label class="text-xs text-gray-600">Desde:</label>
                                    <input type="date" id="filtro-fecha-inicio" class="border rounded p-1 text-xs">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label class="text-xs text-gray-600">Hasta:</label>
                                    <input type="date" id="filtro-fecha-fin" class="border rounded p-1 text-xs">
                                </div>
                                <select id="filtro-defensor" class="border rounded p-1 text-xs">
                                    <option value="">Todos los usuarios asignados</option>
                                </select>
                                <button id="btn-aplicar-filtros" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 transition">Aplicar</button>
                                <button id="btn-limpiar-filtros" class="bg-gray-300 text-gray-700 px-3 py-1 rounded text-xs hover:bg-gray-400 transition">Limpiar</button>
                                <button id="btn-refresh-filtros" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 transition">
                                    <i class="fas fa-sync-alt mr-1"></i>Actualizar
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 justify-center md:justify-start">
                            <button id="btn-nueva" class="bg-green-600 text-white px-3 sm:px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-green-700 transition">
                                <i class="fas fa-plus mr-1"></i> Nueva Consulta-Turno
                            </button>
                            
                            <!-- Botón Exportar -->
                            <div class="relative inline-block">
                                <button id="btn-exportar" class="bg-amber-600 text-white px-3 sm:px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-amber-700 transition">
                                    <i class="fas fa-file-export mr-1"></i> Exportar
                                </button>
                                <div id="menu-exportar" class="absolute right-0 mt-1 bg-white shadow-lg rounded-lg z-50 hidden min-w-[140px]">
                                    <button id="btn-exportar-excel" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm text-gray-800">
                                        <i class="fas fa-file-excel mr-2 text-green-600"></i> Excel
                                    </button>
                                    <button id="btn-exportar-pdf" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm text-gray-800">
                                        <i class="fas fa-file-pdf mr-2 text-red-600"></i> PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Paginación Superior -->
                    <div class="flex justify-between items-center mt-4">
                        <div class="text-sm text-gray-600" id="paginacion-info-superior">
                            Mostrando 0 de 0 registros
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="btn-prev" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300 transition" disabled>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <select id="select-pagina" class="px-2 py-1 border rounded">
                                <option value="1">Página 1</option>
                            </select>
                            <button id="btn-next" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300 transition" disabled>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Atenciones -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-50">
                            <tr>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Fecha/Hora</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Ciudadano</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Contacto</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Tipo</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Usuario asignado</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Estado</th>
                                <th class="px-4 sm:px-6 py-3 text-center text-xs font-bold text-blue-900 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body" class="divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                    <div id="tabla-vacia" class="hidden p-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>No hay registros que coincidan con los filtros</p>
                    </div>
                </div>

                <!-- Paginación Inferior -->
                <div class="flex justify-between items-center mt-4">
                    <div class="text-sm text-gray-600" id="paginacion-info-inferior">
                        Mostrando 0 de 0 registros
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="btn-prev-bottom" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300 transition" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <select id="select-pagina-bottom" class="px-2 py-1 border rounded">
                            <option value="1">Página 1</option>
                        </select>
                        <button id="btn-next-bottom" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300 transition" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Vista Turnos Web -->
            <div id="cont-turnos-web" class="hidden">
                <!-- Barra de herramientas para Turnos Web -->
                <div class="sticky-toolbar bg-white rounded-xl shadow mb-6 p-3 sm:p-4">
                    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between">
                        <div class="w-full">
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                <input type="text" id="busqueda-turnos" placeholder="Buscar turnos web por nombre, DNI o teléfono..." 
                                       class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 justify-center md:justify-start">
                            <button id="btn-nueva-turno" class="bg-green-600 text-white px-3 sm:px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-green-700 transition">
                                <i class="fas fa-plus mr-1"></i> Nuevo Turno Web
                            </button>
                            
                            <!-- Botón Exportar para Turnos Web -->
                            <div class="relative inline-block">
                                <button id="btn-exportar-turnos" class="bg-amber-600 text-white px-3 sm:px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-amber-700 transition">
                                    <i class="fas fa-file-export mr-1"></i> Exportar
                                </button>
                                <div id="menu-exportar-turnos" class="absolute right-0 mt-1 bg-white shadow-lg rounded-lg z-50 hidden min-w-[140px]">
                                    <button id="btn-exportar-excel-turnos" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm text-gray-800">
                                        <i class="fas fa-file-excel mr-2 text-green-600"></i> Excel
                                    </button>
                                    <button id="btn-exportar-pdf-turnos" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm text-gray-800">
                                        <i class="fas fa-file-pdf mr-2 text-red-600"></i> PDF
                                    </button>
                                </div>
                            </div>
                            
                            <button id="btn-refresh-turnos" class="bg-blue-600 text-white px-3 sm:px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition">
                                <i class="fas fa-sync-alt mr-1"></i> Actualizar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Turnos Web -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-50">
                            <tr>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Fecha Turno</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Hora</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Ciudadano</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">DNI</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Teléfono</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Tipo Consulta</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Usuario asignado</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Estado</th>
                                <th class="px-4 sm:px-6 py-3 text-center text-xs font-bold text-blue-900 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="turnos-body" class="divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                    <div id="turnos-web-vacia" class="hidden p-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>No hay turnos web registrados</p>
                    </div>
                </div>
            </div>

            <!-- Vista Calendario de Turnos -->
            <div id="cont-calendario" class="hidden">
                <!-- Barra de herramientas para Calendario -->
                <div class="sticky-toolbar bg-white rounded-xl shadow mb-6 p-3 sm:p-4">
                    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between">
                        <div class="w-full md:w-1/3">
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                <input type="text" id="busqueda-calendario" placeholder="Buscar por nombre, DNI o teléfono..." 
                                       class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                            </div>
                            
                            <!-- Filtros Avanzados -->
                            <div class="flex flex-wrap gap-2 mt-2">
                                <div class="flex items-center space-x-2">
                                    <label class="text-xs text-gray-600">Desde:</label>
                                    <input type="date" id="filtro-fecha-inicio-calendario" class="border rounded p-1 text-xs">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label class="text-xs text-gray-600">Hasta:</label>
                                    <input type="date" id="filtro-fecha-fin-calendario" class="border rounded p-1 text-xs">
                                </div>
                                <select id="filtro-defensor-calendario" class="border rounded p-1 text-xs">
                                    <option value="">Todos los usuarios asignados</option>
                                </select>
                                <button id="btn-aplicar-filtros-calendario" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 transition">Aplicar</button>
                                <button id="btn-limpiar-filtros-calendario" class="bg-gray-300 text-gray-700 px-3 py-1 rounded text-xs hover:bg-gray-400 transition">Limpiar</button>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 justify-center md:justify-start">
                            <!-- Botón Exportar para Calendario -->
                            <div class="relative inline-block">
                                <button id="btn-exportar-calendario" class="bg-amber-600 text-white px-3 sm:px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-amber-700 transition">
                                    <i class="fas fa-file-export mr-1"></i> Exportar
                                </button>
                                <div id="menu-exportar-calendario" class="absolute right-0 mt-1 bg-white shadow-lg rounded-lg z-50 hidden min-w-[140px]">
                                    <button id="btn-exportar-excel-calendario" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm text-gray-800">
                                        <i class="fas fa-file-excel mr-2 text-green-600"></i> Excel
                                    </button>
                                    <button id="btn-exportar-pdf-calendario" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm text-gray-800">
                                        <i class="fas fa-file-pdf mr-2 text-red-600"></i> PDF
                                    </button>
                                </div>
                            </div>
                            
                            <button id="btn-refresh-calendario" class="bg-green-600 text-white px-3 sm:px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-green-700 transition">
                                <i class="fas fa-sync-alt mr-1"></i>Actualizar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Calendario -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 overflow-x-auto">
                    <div class="p-4 border-b">
                        <h2 class="text-lg font-bold text-gray-800">Calendario de Turnos Asignados</h2>
                        <p class="text-sm text-gray-600">Todos los turnos web registrados por fecha y hora</p>
                    </div>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-50">
                            <tr>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Fecha Turno</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Hora</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Ciudadano</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">DNI</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Teléfono</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Tipo Consulta</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Usuario asignado</th>
                                <th class="px-4 sm:px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Estado</th>
                                <th class="px-4 sm:px-6 py-3 text-center text-xs font-bold text-blue-900 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="calendario-body" class="divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                    <div id="calendario-vacia" class="p-8 text-center text-gray-500">
                        <i class="fas fa-calendar-times text-4xl mb-4"></i>
                        <p>No hay turnos web registrados</p>
                        <p class="text-sm mt-2">Los turnos aparecerán aquí cuando los ciudadanos los soliciten desde el formulario web.</p>
                    </div>
                </div>
            </div>

            <!-- Vista Agenda (Configuración) -->
            <div id="cont-agenda" class="hidden">
                <!-- Contenido de Gestión de Agenda -->
                <div class="bg-white rounded-xl w-full overflow-hidden">
                    <div class="bg-indigo-800 text-white p-4 flex justify-between items-center font-bold sticky top-0 z-10">
                        <span class="text-sm sm:text-base">Gestión de Agenda - Días Inactivos y Capacidad</span>
                    </div>
                    <div class="p-4 sm:p-6 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Días Inactivos -->
                            <div class="border rounded-lg p-4">
                                <h3 class="font-bold text-lg text-gray-800 mb-3"><i class="fas fa-calendar-times mr-2"></i>Días Inactivos/Feriados</h3>
                                <p class="text-sm text-gray-600 mb-4">Seleccione las fechas que no estarán disponibles para turnos</p>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <input type="date" id="nueva-fecha-inactiva" class="border rounded p-2 flex-1 mr-2">
                                        <button id="btn-agregar-inactivo" class="bg-red-600 text-white px-4 py-2 rounded text-sm hover:bg-red-700 transition">Agregar</button>
                                    </div>
                                    <div id="lista-fechas-inactivas" class="max-h-40 overflow-y-auto">
                                        <!-- Lista de fechas inactivas se generará dinámicamente -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Configuración de Capacidad -->
                            <div class="border rounded-lg p-4">
                                <h3 class="font-bold text-lg text-gray-800 mb-3"><i class="fas fa-users mr-2"></i>Capacidad por Horario</h3>
                                <p class="text-sm text-gray-600 mb-4">Configure la cantidad máxima de turnos por bloque horario</p>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <select id="select-horario-capacidad" class="border rounded p-2 flex-1 mr-2">
                                            <!-- Horarios se llenarán dinámicamente -->
                                        </select>
                                        <input type="number" id="input-capacidad" min="1" max="10" value="2" class="w-20 border rounded p-2 text-center">
                                    </div>
                                    <button id="btn-guardar-capacidad" class="w-full bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 transition">Guardar Capacidad</button>
                                    <div id="lista-capacidades" class="mt-3">
                                        <!-- Lista de capacidades configuradas -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h4 class="font-bold text-gray-800 mb-2">Fechas Inactivas Configuradas</h4>
                            <div class="bg-gray-50 p-3 rounded text-sm">
                                <p class="text-gray-600" id="resumen-fechas-inactivas">No hay fechas inactivas configuradas</p>
                            </div>
                        </div>
                        
                        <button id="btn-sincronizar-agenda" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">
                            <i class="fas fa-sync-alt mr-2"></i> Sincronizar Cambios con Sistema
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal Registro -->
        <div id="modal-registro" class="modal">
            <div class="bg-white rounded-xl w-full max-w-2xl mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
                <div class="bg-blue-800 text-white p-4 flex justify-between items-center font-bold sticky top-0 z-10">
                    <span class="text-sm sm:text-base">Registrar Nueva Atención</span>
                    <button id="btn-cerrar-modal" class="text-2xl leading-none">&times;</button>
                </div>
                <form id="form-interno" class="p-4 sm:p-6 space-y-4 sm:space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 modal-content-grid">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Nombre Completo *</label>
                            <input type="text" id="m-name" placeholder="Ej: Juan Pérez" required 
                                   class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">DNI</label>
                            <input type="text" id="m-dni" placeholder="Ej: 12345678" maxlength="8" pattern="\d*"
                                   oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                   class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Teléfono/WhatsApp</label>
                            <input type="text" id="m-telefono" placeholder="Ej: 3764123456" maxlength="10" pattern="\d*"
                                   oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                   class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Tipo de Consulta *</label>
                            <select id="m-type" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                                <option value="Presencial">Presencial</option>
                                <option value="Telefónica">Telefónica</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Consulta Web: Alimentos">Consulta Web: Alimentos</option>
                                <option value="Consulta Web: Regimen Comunicación">Consulta Web: Régimen Comunicación</option>
                                <option value="Consulta Web: Cuidado Personal">Consulta Web: Cuidado Personal</option>
                                <option value="Consulta Web: Divorcio">Consulta Web: Divorcio</option>
                                <option value="Consulta Web: Otros">Consulta Web: Otros</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Descripción</label>
                        <textarea id="m-desc" placeholder="Detalles de la consulta..." 
                                  class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none h-20 sm:h-24 text-sm"></textarea>
                    </div>
                    
                    <!-- Sección de Calendario para Turnos -->
                    <div class="border-t pt-4">
                        <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-3"><i class="fas fa-calendar-alt mr-2"></i>Asignar Turno (Opcional)</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                            <!-- Calendario -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Seleccione Fecha</label>
                                <div class="bg-gray-50 p-3 sm:p-4 rounded-lg border">
                                    <div class="flex justify-between items-center mb-3 sm:mb-4">
                                        <button type="button" id="prev-month" class="p-2 hover:bg-gray-200 rounded">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <h4 id="current-month" class="font-bold text-gray-800 text-sm sm:text-base">Diciembre 2024</h4>
                                        <button type="button" id="next-month" class="p-2 hover:bg-gray-200 rounded">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-7 gap-1 mb-2">
                                        <div class="text-center text-xs font-bold text-gray-500">Lun</div>
                                        <div class="text-center text-xs font-bold text-gray-500">Mar</div>
                                        <div class="text-center text-xs font-bold text-gray-500">Mié</div>
                                        <div class="text-center text-xs font-bold text-gray-500">Jue</div>
                                        <div class="text-center text-xs font-bold text-gray-500">Vie</div>
                                        <div class="text-center text-xs font-bold text-gray-500">Sáb</div>
                                        <div class="text-center text-xs font-bold text-gray-500">Dom</div>
                                    </div>
                                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                                </div>
                                <input type="hidden" id="m-fecha-turno" value="">
                            </div>
                            
                            <!-- Horarios con capacidad -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Horarios Disponibles</label>
                                <div class="bg-gray-50 p-3 sm:p-4 rounded-lg border h-full">
                                    <div id="horarios-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                        <!-- Horarios se generan dinámicamente con información de capacidad -->
                                    </div>
                                    <div class="mt-4">
                                        <p id="info-capacidad" class="text-xs text-gray-600 mb-2">Cada horario tiene capacidad para 2 turnos simultáneos</p>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Horario Personalizado</label>
                                        <div class="flex gap-2">
                                            <input type="time" id="m-hora-personalizada" 
                                                   class="flex-1 border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                                   min="07:00" max="11:30">
                                            <button type="button" id="btn-usar-hora-personalizada" 
                                                    class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 whitespace-nowrap transition">
                                                Usar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="m-horario-turno" value="">
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <p id="turno-seleccionado" class="text-sm text-gray-700">
                                <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                                <span id="turno-texto">No se ha asignado turno</span>
                            </p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Usuario asignado</label>
                        <select id="m-user" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                            <option value="">Sin asignar</option>
                        </select>
                    </div>
                    
                    <!-- NUEVO CAMPO: Responsable que asigna tarea -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Responsable que asigna tarea</label>
                        <input type="text" id="m-responsable" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-gray-100" readonly>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition text-sm sm:text-base">
                        <i class="fas fa-save mr-2"></i> Guardar en Sistema
                    </button>
                </form>
            </div>
        </div>

        <!-- Modal Detalles y Gestión (VER) -->
        <div id="modal-gestion" class="modal">
            <div class="bg-white rounded-xl w-full max-w-2xl mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
                <div class="bg-blue-800 text-white p-4 flex justify-between items-center font-bold sticky top-0 z-10">
                    <span class="text-sm sm:text-base"><i class="fas fa-eye mr-2"></i>Detalles Completos de la Consulta</span>
                    <button id="btn-cerrar-gestion" class="text-2xl leading-none">&times;</button>
                </div>
                <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Ciudadano</label>
                            <p id="det-nombre" class="p-2 bg-gray-50 rounded text-sm font-medium"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">DNI</label>
                            <p id="det-dni" class="p-2 bg-gray-50 rounded text-sm"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Teléfono</label>
                            <p id="det-telefono" class="p-2 bg-gray-50 rounded text-sm flex items-center justify-between">
                                <span id="det-telefono-texto"></span>
                                <button id="btn-whatsapp-detalle" class="text-green-600 hover:text-green-800 ml-2">
                                    <i class="fab fa-whatsapp text-lg"></i>
                                </button>
                            </p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Tipo de Consulta</label>
                            <p id="det-tipo" class="p-2 bg-gray-50 rounded text-sm font-bold text-blue-600"></p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Descripción Inicial</label>
                        <p id="det-desc" class="p-2 bg-gray-50 rounded min-h-20 text-sm"></p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Fecha/Hora Registro</th>
                            <p id="det-fecha" class="p-2 bg-gray-50 rounded text-sm"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Fecha/Hora Turno</th>
                            <p id="det-turno" class="p-2 bg-gray-50 rounded text-sm"></p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Usuario asignado</th>
                            <p id="det-usuario" class="p-2 bg-gray-50 rounded text-sm"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Estado Actual</th>
                            <p id="det-estado" class="p-2 bg-gray-50 rounded text-sm">
                                <span id="det-estado-texto" class="px-2 py-1 rounded-full text-[10px] font-bold"></span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Historial de Notas y Observaciones -->
                    <div class="pt-4 border-t">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-semibold text-gray-700">Historial de Observaciones</label>
                            <span class="text-xs text-gray-500" id="contador-notas">0 observaciones</span>
                        </div>
                        <div id="historial-notas" class="mb-4 max-h-48 overflow-y-auto p-3 bg-gray-50 rounded">
                            <!-- Las notas se cargarán aquí dinámicamente -->
                        </div>
                        <div class="flex gap-2">
                            <textarea id="nueva-nota" placeholder="Añadir una nueva observación, seguimiento o avance del caso..." 
                                      class="flex-1 border p-2 rounded text-sm" rows="3"></textarea>
                            <button id="btn-agregar-nota" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 self-end transition">
                                Agregar
                            </button>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Gestión del Caso</label>
                        <div class="flex flex-wrap gap-2 mb-4 modal-buttons">
                            <button id="btn-estado-pendiente" class="bg-yellow-500 text-white px-3 sm:px-4 py-2 rounded text-sm hover:bg-yellow-600 transition">
                                <i class="fas fa-clock mr-1"></i> Pendiente
                            </button>
                            <button id="btn-estado-proceso" class="bg-blue-500 text-white px-3 sm:px-4 py-2 rounded text-sm hover:bg-blue-600 transition">
                                <i class="fas fa-spinner mr-1"></i> En Proceso
                            </button>
                            <button id="btn-estado-resuelta" class="bg-green-500 text-white px-3 sm:px-4 py-2 rounded text-sm hover:bg-green-600 transition">
                                <i class="fas fa-check mr-1"></i> Resuelta
                            </button>
                            <button id="btn-estado-derivada" class="bg-purple-500 text-white px-3 sm:px-4 py-2 rounded text-sm hover:bg-purple-600 transition">
                                <i class="fas fa-share mr-1"></i> Derivada
                            </button>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center gap-3 sm:gap-4">
                            <select id="select-asignar" class="flex-1 border p-2 rounded text-sm w-full sm:w-auto">
                                <option value="">Usuario asignado...</option>
                            </select>
                            <button id="btn-asignar-caso" class="bg-blue-600 text-white px-3 sm:px-4 py-2 rounded text-sm hover:bg-blue-700 w-full sm:w-auto transition">
                                <i class="fas fa-user-plus mr-1"></i> Asignar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, set, remove, get } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDgxLS98sk6GkLrjMu3BVS2cmZ9exdh4dY",
            authDomain: "atencion-publico-def6.firebaseapp.com",
            databaseURL: "https://atencion-publico-def6-default-rtdb.firebaseio.com",
            projectId: "atencion-publico-def6"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const baseRef = ref(db, "atencion");
        const configRef = ref(db, "config");

        // Variables de estado de la aplicación
        let rawData = [];
        let vistaActual = 'dashboard';
        let filtroBusqueda = '';
        let filtroBusquedaTurnos = '';
        let filtroBusquedaCalendario = '';
        let filtroFechaInicio = '';
        let filtroFechaFin = '';
        let filtroDefensor = '';
        let filtroFechaInicioCalendario = '';
        let filtroFechaFinCalendario = '';
        let filtroDefensorCalendario = '';
        let casoActualId = null;
        let casoAEliminarId = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let selectedTime = null;
        let diasInactivos = [];
        let capacidadHoraria = {};
        let charts = {};
        let ultimaConsultaWebId = null;
        let notificacionesActivas = true;
        
        // Variables para paginación
        let paginaActual = 1;
        const registrosPorPagina = 10;
        let totalRegistros = 0;
        let totalPaginas = 1;
        
        // Variables de autenticación
        let usuarioLogueado = null;
        const usuariosAutorizados = ["Defensor Titular", "Defensor Subrogante", "Sec Riveros", "Sec Corrales", "Sec Magnani"];
        
        // CAMBIO: Contraseñas específicas para cada usuario
        const CONTRASENAS = {
            "Defensor Titular": "ramos123",
            "Defensor Subrogante": "subroga123",
            "Sec Riveros": "riveros123",
            "Sec Corrales": "corrales123",
            "Sec Magnani": "magnani123"
        };

        // Lista de usuarios disponibles para asignación (todos los defensores y secretarios)
        // IMPORTANTE: Debe coincidir exactamente con los nombres en asignados.html
        const users = [
            "Bazante Nadia Romina", "Boillat Cesar Enrique", "Cardozo Maria Raquel", 
            "Cedron Noelia Aurora", "Corrales Alicia Mariela", "Escobar Monica Graciela", 
            "Fioravante Romulo", "Gonzalez Alberto Misael", "Gonzalez Juan Jose", 
            "Gudiño Natalia Esther", "Magnani Enzo Luciano", "Pablos Patricia", 
            "Palacios Ana Gabriela", "Ortega Lucia Noemi", "Ramos Marcelo Gustavo", 
            "Riveros Patricia Soledad", "Sosa Rita Cecilia"
        ];

        // ========== LISTA DE FERIADOS 2026 (Extraída de b.html) ==========
        const feriados2026 = [
            '2026-01-01', // 1 de enero - Año Nuevo
            '2026-02-16', // 16 de febrero - Carnaval
            '2026-02-17', // 17 de febrero - Carnaval
            '2026-03-24', // 24 de marzo - Día Nacional de la Memoria por la Verdad y la Justicia
            '2026-04-02', // 2 de abril - Día del Veterano y de los Caídos en la Guerra de Malvinas
            '2026-04-03', // 3 de abril - Viernes Santo
            '2026-05-01', // 1 de mayo - Día del Trabajador
            '2026-05-25', // 25 de mayo - Día de la Revolución de Mayo
            '2026-06-20', // 20 de junio - Paso a la Inmortalidad del Gral. Manuel Belgrano
            '2026-07-09', // 9 de julio - Día de la Independencia
            '2026-12-08', // 8 de diciembre - Día de la Inmaculada Concepción de María
            '2026-12-25', // 25 de diciembre - Navidad
            '2026-06-15', // 15 de junio - Paso a la Inmortalidad del Gral. Martín Miguel de Güemes
            '2026-08-17', // 17 de agosto - Paso a la Inmortalidad del Gral. José de San Martín
            '2026-10-12', // 12 de octubre - Día del Respeto a la Diversidad Cultural
            '2026-11-23', // 23 de noviembre - Día de la Soberanía Nacional
            '2026-03-23', // 23 de marzo - Puente previo al feriado del 24 de marzo
            '2026-07-10', // 10 de julio - Puente posterior al feriado del 9 de julio
            '2026-12-07'  // 7 de diciembre - Puente previo al feriado del 8 de diciembre
        ];

        // ========== FUNCIÓN PARA VERIFICAR DÍAS NO LABORABLES ==========
        function esDiaNoLaborable() {
            const hoy = new Date();
            const diaSemana = hoy.getDay(); // 0: Domingo, 6: Sábado
            const fechaString = hoy.toISOString().split('T')[0]; // Formato YYYY-MM-DD
            
            // Verificar si es fin de semana (Sábado o Domingo)
            if (diaSemana === 0 || diaSemana === 6) {
                return true;
            }
            
            // Verificar si es feriado (usando la lista de feriados 2026)
            if (feriados2026.includes(fechaString)) {
                return true;
            }
            
            return false;
        }

        // ========== INICIALIZACIÓN DE ELEMENTOS DOM ==========
        const uSel = document.getElementById('m-user');
        const selectAsignar = document.getElementById('select-asignar');
        const filtroDefensorSelect = document.getElementById('filtro-defensor');
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthElement = document.getElementById('current-month');
        const horariosContainer = document.getElementById('horarios-container');
        const turnoTexto = document.getElementById('turno-texto');
        const btnExportar = document.getElementById('btn-exportar');
        const menuExportar = document.getElementById('menu-exportar');
        const btnExportarExcel = document.getElementById('btn-exportar-excel');
        const btnExportarPDF = document.getElementById('btn-exportar-pdf');
        const btnAgregarNota = document.getElementById('btn-agregar-nota');
        const nuevaNotaInput = document.getElementById('nueva-nota');
        const historialNotas = document.getElementById('historial-notas');
        
        // Elementos para eliminación
        const modalEliminar = document.getElementById('modal-eliminar');
        const btnCerrarEliminar = document.getElementById('btn-cerrar-eliminar');
        const btnCancelarEliminar = document.getElementById('btn-cancelar-eliminar');
        const btnConfirmarEliminar = document.getElementById('btn-confirmar-eliminar');
        const eliminarInfo = document.getElementById('eliminar-info');
        
        // Elementos de paginación
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        const btnPrevBottom = document.getElementById('btn-prev-bottom');
        const btnNextBottom = document.getElementById('btn-next-bottom');
        const selectPagina = document.getElementById('select-pagina');
        const selectPaginaBottom = document.getElementById('select-pagina-bottom');
        const paginacionInfoSuperior = document.getElementById('paginacion-info-superior');
        const paginacionInfoInferior = document.getElementById('paginacion-info-inferior');
        
        // Elementos para modal de sincronización
        const modalSincronizacion = document.getElementById('modal-sincronizacion');
        const sincronizacionIcon = document.getElementById('sincronizacion-icon');
        const sincronizacionTitulo = document.getElementById('sincronizacion-titulo');
        const sincronizacionMensaje = document.getElementById('sincronizacion-mensaje');
        const btnCerrarSincronizacion = document.getElementById('btn-cerrar-sincronizacion');
        
        // Elementos de login
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginUsuario = document.getElementById('login-usuario');
        const loginPassword = document.getElementById('login-password');
        const btnLogin = document.getElementById('btn-login');
        const loginError = document.getElementById('login-error');
        const loginErrorText = document.getElementById('login-error-text');
        const currentUserDisplay = document.getElementById('current-user-display');
        const btnLogout = document.getElementById('btn-logout');
        
        // Elementos para modal de comprobante
        const modalComprobante = document.getElementById('modal-comprobante');
        const btnCerrarComprobante = document.getElementById('btn-cerrar-comprobante');
        const btnDescargarComprobante = document.getElementById('btn-descargar-comprobante');
        let comprobanteActualId = null;
        
        // ========== FUNCIONES DE AUTENTICACIÓN ==========
        
        /**
         * Maneja el proceso de login
         */
        function manejarLogin() {
            const usuario = loginUsuario.value;
            const contrasena = loginPassword.value;
            
            if (!usuario) {
                mostrarErrorLogin('Por favor seleccione un usuario');
                return;
            }
            
            if (!contrasena) {
                mostrarErrorLogin('Por favor ingrese la contraseña');
                return;
            }
            
            // CAMBIO: Verificar contraseña específica para cada usuario
            const contrasenaCorrecta = CONTRASENAS[usuario];
            if (!contrasenaCorrecta || contrasena !== contrasenaCorrecta) {
                mostrarErrorLogin('Contraseña incorrecta');
                return;
            }
            
            if (!usuariosAutorizados.includes(usuario)) {
                mostrarErrorLogin('Usuario no autorizado');
                return;
            }
            
            // Login exitoso
            usuarioLogueado = usuario;
            loginError.classList.add('hidden');
            loginContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            currentUserDisplay.textContent = usuario;
            
            // Actualizar campo "Responsable" con el usuario logueado
            actualizarSelectsUsuarioLogueado();
            
            mostrarAlertaSincronizacion(true, `Bienvenido/a ${usuario}`);
        }
        
        /**
         * Maneja el logout
         */
        function manejarLogout() {
            usuarioLogueado = null;
            appContainer.classList.add('hidden');
            loginContainer.classList.remove('hidden');
            loginUsuario.value = '';
            loginPassword.value = '';
            loginError.classList.add('hidden');
        }
        
        /**
         * Muestra error en el login
         * @param {string} mensaje - Mensaje de error
         */
        function mostrarErrorLogin(mensaje) {
            loginErrorText.textContent = mensaje;
            loginError.classList.remove('hidden');
        }
        
        /**
         * Actualiza el campo "Responsable" con el usuario logueado
         */
        function actualizarSelectsUsuarioLogueado() {
            if (!usuarioLogueado) return;
            
            // Solo establecer el valor del campo Responsable (que es de solo lectura)
            document.getElementById('m-responsable').value = usuarioLogueado;
            
            // NO modificar el select de usuario asignado (uSel) para que siga teniendo todos los usuarios
            // Los demás selects (filtros, asignación en modal de gestión) mantienen todos los usuarios
        }
        
        // ========== EVENT LISTENERS DE AUTENTICACIÓN ==========
        
        btnLogin.addEventListener('click', manejarLogin);
        
        loginPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                manejarLogin();
            }
        });
        
        btnLogout.addEventListener('click', manejarLogout);
        
        // ========== FUNCIONES AUXILIARES ==========
        
        /**
         * Parsea una fecha local en formato 'YYYY-MM-DD'
         * @param {string} dateStr - Fecha en formato 'YYYY-MM-DD'
         * @returns {Date} Fecha en zona horaria local
         */
        function parseLocalDate(dateStr) {
            if (!dateStr) return null;
            
            // Manejar tanto formatos con '-' como con '/' para compatibilidad
            const separator = dateStr.includes('-') ? '-' : '/';
            const parts = dateStr.split(separator).map(Number);
            
            if (parts.length !== 3) return null;
            
            // Determinar qué formato tenemos: YYYY-MM-DD o DD/MM/YYYY
            if (parts[0] > 31) {
                // Primer elemento es mayor a 31, debe ser año (YYYY-MM-DD)
                const [year, month, day] = parts;
                return new Date(year, month - 1, day);
            } else {
                // Asumimos DD/MM/YYYY (compatibilidad con datos antiguos)
                const [day, month, year] = parts;
                return new Date(year, month - 1, day);
            }
        }
        
        /**
         * Normaliza una fecha a las 00:00:00 para comparaciones exactas
         * @param {Date} date - Fecha a normalizar
         * @returns {Date} Fecha normalizada
         */
        function normalizeDate(date) {
            if (!date) return null;
            const normalized = new Date(date);
            normalized.setHours(0, 0, 0, 0);
            return normalized;
        }
        
        /**
         * Formatea fecha en formato 'YYYY-MM-DD' (consistente con cliente)
         * @param {Date} date - Fecha a formatear
         * @returns {string} Fecha formateada como 'YYYY-MM-DD'
         */
        function formatDateLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        /**
         * Formatea fecha para mostrar en formato argentino
         * @param {Date|string} date - Fecha a formatear
         * @returns {string} Fecha formateada
         */
        function formatDateForDisplay(date) {
            if (!date) return '';
            
            const fecha = typeof date === 'string' ? parseLocalDate(date) : date;
            if (!fecha) return '';
            
            return new Intl.DateTimeFormat('es-AR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                timeZone: 'America/Argentina/Buenos_Aires'
            }).format(fecha);
        }
        
        /**
         * Formatea fecha y hora para mostrar
         * @param {Date|string} date - Fecha a formatear
         * @returns {string} Fecha y hora formateadas
         */
        function formatDateTimeForDisplay(date) {
            if (!date) return '';
            
            const fecha = typeof date === 'string' ? new Date(date) : date;
            
            // CAMBIO: Agregar hour12: false para formato 24 horas
            return new Intl.DateTimeFormat('es-AR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false, // Formato 24 horas
                timeZone: 'America/Argentina/Buenos_Aires'
            }).format(fecha);
        }
        
        /**
         * Formatea fecha corta para mostrar (DD/MM/YYYY)
         * @param {Date|string} date - Fecha a formatear
         * @returns {string} Fecha formateada corta
         */
        function formatShortDateForDisplay(date) {
            if (!date) return '';
            
            const fecha = typeof date === 'string' ? parseLocalDate(date) : date;
            if (!fecha) return '';
            
            return new Intl.DateTimeFormat('es-AR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                timeZone: 'America/Argentina/Buenos_Aires'
            }).format(fecha);
        }
        
        /**
         * Determina el origen de un registro (web o interno)
         * @param {Object} registro - Registro a evaluar
         * @returns {string} 'web' o 'interno'
         */
        function obtenerOrigenRegistro(registro) {
            // Si ya tiene el campo origen, usarlo
            if (registro.origen) {
                return registro.origen;
            }
            
            // Para compatibilidad con registros antiguos, inferir por tipo
            if (registro.type && registro.type.includes('Consulta Web:')) {
                return 'web';
            }
            return 'interno';
        }
        
        /**
         * Determina si un registro es una consulta web
         * @param {Object} registro - Registro a evaluar
         * @returns {boolean} True si es consulta web
         */
        function esConsultaWeb(registro) {
            return obtenerOrigenRegistro(registro) === 'web';
        }
        
        /**
         * Muestra alerta de sincronización
         * @param {boolean} exito - Indica si fue exitosa
         * @param {string} mensaje - Mensaje personalizado
         */
        function mostrarAlertaSincronizacion(exito, mensaje = null) {
            if (exito) {
                modalSincronizacion.classList.remove('error');
                modalSincronizacion.classList.add('success');
                sincronizacionIcon.className = 'fas fa-check-circle';
                sincronizacionTitulo.textContent = 'Éxito';
                sincronizacionMensaje.textContent = mensaje || 'Agenda sincronizada correctamente. Los cambios se reflejarán en el formulario público.';
            } else {
                modalSincronizacion.classList.remove('success');
                modalSincronizacion.classList.add('error');
                sincronizacionIcon.className = 'fas fa-exclamation-circle';
                sincronizacionTitulo.textContent = 'Error';
                sincronizacionMensaje.textContent = mensaje || 'No se pudo sincronizar la agenda. Por favor, intente nuevamente.';
            }
            
            modalSincronizacion.classList.add('active');
            
            // Auto-cerrar después de 5 segundos
            setTimeout(() => {
                modalSincronizacion.classList.remove('active');
            }, 5000);
        }
        
        /**
         * Muestra notificación push
         * @param {Object} registro - Registro para la notificación
         */
        function mostrarNotificacion(registro) {
            const notificationContainer = document.getElementById('notification-container');
            const sound = document.getElementById('notification-sound');
            
            const notification = document.createElement('div');
            notification.className = 'notification pulse-animation';
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-xl"></i>
                    </div>
                    <div class="ml-3 w-0 flex-1">
                        <p class="text-sm font-medium">Nueva Consulta Web Recibida</p>
                        <p class="mt-1 text-sm">
                            <strong>${registro.personName || 'Sin nombre'}</strong><br>
                            Tipo: ${registro.type || 'Sin tipo'}<br>
                            ${registro.telefono ? `Tel: ${registro.telefono}` : ''}
                        </p>
                        <p class="mt-2 text-xs">${new Date().toLocaleTimeString()}</p>
                    </div>
                    <div class="ml-4 flex-shrink-0 flex">
                        <button class="close-notification bg-transparent rounded-md text-white hover:text-gray-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Reproducir sonido
            try {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("Error al reproducir sonido: ", e));
            } catch (error) {
                console.error("Error con el sonido:", error);
            }
            
            // Auto-eliminar después de 10 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.remove('pulse-animation');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 10000);
            
            // Cerrar notificación al hacer clic
            notification.querySelector('.close-notification').addEventListener('click', () => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            });
        }
        
        /**
         * Verifica si una fecha está dentro del período de feria
         * @param {Date} fecha - Fecha a verificar
         * @returns {boolean} True si está en período de feria
         */
        function esFechaDeFeria(fecha) {
            if (!fecha) return false;
            
            const mes = fecha.getMonth() + 1; // 1-12
            const dia = fecha.getDate();
            const año = fecha.getFullYear();
            
            // Período 1: Del 26/12 al 31/01
            // Verificar si estamos entre el 26 de diciembre y el 31 de enero
            if ((mes === 12 && dia >= 26) || (mes === 1 && dia <= 31)) {
                return true;
            }
            
            // Período 2: Del 13/07 al 24/07
            if (mes === 7 && dia >= 13 && dia <= 24) {
                return true;
            }
            
            return false;
        }
        
        // ========== CONFIGURACIÓN INICIAL ==========
        
        // Llenar selects de usuarios con TODOS los usuarios disponibles
        users.forEach(u => {
            // Llenar select en modal de registro (uSel)
            uSel.innerHTML += `<option value="${u}">${u}</option>`;
            
            // Llenar select en modal de gestión
            selectAsignar.innerHTML += `<option value="${u}">${u}</option>`;
            
            // Llenar filtros
            filtroDefensorSelect.innerHTML += `<option value="${u}">${u}</option>`;
            
            const filtroDefensorCalendarioSelect = document.getElementById('filtro-defensor-calendario');
            filtroDefensorCalendarioSelect.innerHTML += `<option value="${u}">${u}</option>`;
        });

        // Configurar modal de eliminación
        btnCerrarEliminar.addEventListener('click', () => {
            modalEliminar.classList.remove('active');
            casoAEliminarId = null;
        });
        
        btnCancelarEliminar.addEventListener('click', () => {
            modalEliminar.classList.remove('active');
            casoAEliminarId = null;
        });
        
        btnConfirmarEliminar.addEventListener('click', async () => {
            if (casoAEliminarId) {
                try {
                    const casoRef = ref(db, `atencion/${casoAEliminarId}`);
                    await remove(casoRef);
                    mostrarAlertaSincronizacion(true, 'Registro eliminado permanentemente');
                    modalEliminar.classList.remove('active');
                    casoAEliminarId = null;
                } catch (error) {
                    console.error('Error al eliminar registro:', error);
                    mostrarAlertaSincronizacion(false, `Error al eliminar el registro: ${error.message}`);
                }
            }
        });

        // Event listener para cerrar modal de sincronización
        btnCerrarSincronizacion.addEventListener('click', () => {
            modalSincronizacion.classList.remove('active');
        });
        
        // Event listener para cerrar modal de comprobante
        btnCerrarComprobante.addEventListener('click', () => {
            modalComprobante.classList.remove('active');
        });
        
        // Event listener para descargar comprobante
        btnDescargarComprobante.addEventListener('click', descargarComprobantePDF);
        
        // ========== GESTIÓN DE AGENDA Y CALENDARIO ==========
        
        /**
         * Carga la configuración de agenda desde Firebase
         */
        async function cargarConfiguracionAgenda() {
            try {
                // Cargar días inactivos
                onValue(ref(db, "config/diasInactivos"), (snap) => {
                    diasInactivos = snap.val() || [];
                    renderCalendario();
                    actualizarListaFechasInactivas();
                }, (error) => {
                    console.error("Error cargando días inactivos:", error);
                });
                
                // Cargar capacidad horaria
                onValue(ref(db, "config/capacidadHoraria"), (snap) => {
                    capacidadHoraria = snap.val() || {};
                    if (Object.keys(capacidadHoraria).length === 0) {
                        // Configuración por defecto
                        const horariosDefault = {};
                        for (let hour = 7; hour <= 11; hour++) {
                            for (let minute = 0; minute < 60; minute += 30) {
                                if (hour === 11 && minute > 30) break;
                                const hora = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                                horariosDefault[hora] = 2;
                            }
                        }
                        try {
                            set(ref(db, "config/capacidadHoraria"), horariosDefault);
                            capacidadHoraria = horariosDefault;
                        } catch (error) {
                            console.error("Error estableciendo capacidad horaria por defecto:", error);
                        }
                    }
                    actualizarListaCapacidades();
                    actualizarHorariosEnSelect();
                    actualizarHorariosDisponibles();
                }, (error) => {
                    console.error("Error cargando capacidad horaria:", error);
                });
            } catch (error) {
                console.error("Error en cargarConfiguracionAgenda:", error);
            }
        }

        /**
         * Actualiza select de horarios en configuración de capacidad
         */
        function actualizarHorariosEnSelect() {
            const selectHorarioCapacidad = document.getElementById('select-horario-capacidad');
            selectHorarioCapacidad.innerHTML = '<option value="">Seleccionar horario</option>';
            Object.keys(capacidadHoraria).forEach(hora => {
                selectHorarioCapacidad.innerHTML += `<option value="${hora}">${hora}</option>`;
            });
        }

        /**
         * Inicializa calendario con gestión de días inactivos
         */
        function inicializarCalendario() {
            renderCalendario();
            actualizarHorariosDisponibles();
        }
        
        /**
         * Actualiza horarios disponibles en el modal de registro
         */
        function actualizarHorariosDisponibles() {
            horariosContainer.innerHTML = '';
            
            let horarios = [];
            
            if (selectedDate && esFechaDeFeria(selectedDate)) {
                // PERÍODO DE FERIA: solo de 08:00 a 10:00
                for (let hour = 8; hour <= 10; hour++) {
                    for (let minute = 0; minute < 60; minute += 30) {
                        if (hour === 10 && minute > 0) break;
                        const hora = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        horarios.push({ hora, capacidad: 2 });
                    }
                }
                
                // Actualizar texto informativo
                document.getElementById('info-capacidad').textContent = 
                    'PERÍODO DE FERIA: Horarios de 08:00 a 10:00 hs. Capacidad: 2 turnos por horario.';
            } else {
                // Horarios normales de capacidadHoraria
                Object.keys(capacidadHoraria).forEach(hora => {
                    const capacidad = capacidadHoraria[hora] || 2;
                    horarios.push({ hora, capacidad });
                });
                
                // Actualizar texto informativo
                document.getElementById('info-capacidad').textContent = 
                    'Horarios de 7:00 a 11:30 hs. Cada horario tiene capacidad para 2 turnos simultáneos.';
            }
            
            horarios.forEach(({ hora, capacidad }) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'bg-white border border-gray-300 p-2 rounded text-sm hover:bg-blue-50 transition flex flex-col items-center justify-center';
                btn.innerHTML = `
                    <span>${hora}</span>
                    <span class="text-xs text-gray-500">(${capacidad} cupos)</span>
                `;
                btn.dataset.hora = hora;
                btn.addEventListener('click', () => seleccionarHorario(hora));
                horariosContainer.appendChild(btn);
            });
        }
        
        /**
         * Renderiza calendario con días inactivos
         */
        function renderCalendario() {
            calendarGrid.innerHTML = '';
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const firstDayIndex = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
            
            // Nombre del mes actual
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                              "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            currentMonthElement.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Días vacíos al inicio
            for (let i = 0; i < firstDayIndex; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'h-8';
                calendarGrid.appendChild(emptyDiv);
            }
            
            // Días del mes
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day h-8 flex items-center justify-center text-sm rounded';
                
                const date = new Date(currentYear, currentMonth, day);
                const dateString = formatDateLocal(date);
                const dayOfWeek = date.getDay();
                
                const isToday = date.getDate() === today.getDate() && 
                               date.getMonth() === today.getMonth() && 
                               date.getFullYear() === today.getFullYear();
                
                const isPast = date < today && !isToday;
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isInactivo = diasInactivos.includes(dateString);
                
                // Verificar si este día está seleccionado
                const isSelected = selectedDate && 
                                  selectedDate.getFullYear() === currentYear &&
                                  selectedDate.getMonth() === currentMonth &&
                                  selectedDate.getDate() === day;
                
                if (isToday) {
                    dayElement.classList.add('bg-blue-100', 'text-blue-700', 'font-bold');
                }
                
                if (isSelected) {
                    dayElement.classList.add('selected');
                }
                
                // Deshabilitar días pasados, fines de semana y días inactivos
                if (isPast || isWeekend || isInactivo) {
                    dayElement.classList.add('disabled', 'text-gray-300');
                    if (isInactivo) {
                        dayElement.title = 'Día no laborable';
                        dayElement.innerHTML = `<span class="line-through">${day}</span>`;
                    } else {
                        dayElement.textContent = day;
                    }
                } else {
                    dayElement.textContent = day;
                    dayElement.addEventListener('click', () => seleccionarDia(day));
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }
        
        /**
         * Selecciona un día en el calendario
         * @param {number} day - Día seleccionado
         */
        function seleccionarDia(day) {
            const date = new Date(currentYear, currentMonth, day);
            // GUARDAR EN FORMATO 'YYYY-MM-DD' (consistente con cliente)
            const dateString = formatDateLocal(date);
            
            // Verificar que no sea día inactivo
            if (diasInactivos.includes(dateString)) {
                mostrarAlertaSincronizacion(false, 'Este día está marcado como no laborable');
                return;
            }
            
            selectedDate = date;
            document.getElementById('m-fecha-turno').value = dateString;
            
            renderCalendario();
            actualizarHorariosDisponibles();
            actualizarTextoSeleccionTurno();
        }
        
        /**
         * Selecciona un horario
         * @param {string} hora - Horario seleccionado
         */
        function seleccionarHorario(hora) {
            selectedTime = hora;
            document.getElementById('m-horario-turno').value = hora;
            
            // Resaltar el botón seleccionado
            document.querySelectorAll('#horarios-container button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-white', 'text-gray-800');
            });
            
            const btnSeleccionado = document.querySelector(`button[data-hora="${hora}"]`);
            if (btnSeleccionado) {
                btnSeleccionado.classList.remove('bg-white', 'text-gray-800');
                btnSeleccionado.classList.add('bg-blue-600', 'text-white');
            }
            
            actualizarTextoSeleccionTurno();
        }
        
        /**
         * Actualiza texto de selección de turno
         */
        function actualizarTextoSeleccionTurno() {
            if (selectedDate && selectedTime) {
                const fechaFormateada = formatDateForDisplay(selectedDate);
                turnoTexto.textContent = `Turno asignado: ${fechaFormateada} a las ${selectedTime} hs`;
                turnoTexto.parentElement.classList.remove('bg-blue-50');
                turnoTexto.parentElement.classList.add('bg-green-50', 'border-green-200');
            } else if (selectedDate) {
                const fechaFormateada = formatDateForDisplay(selectedDate);
                turnoTexto.textContent = `Fecha seleccionada: ${fechaFormateada}. Falta seleccionar horario.`;
                turnoTexto.parentElement.classList.add('bg-blue-50', 'border-blue-200');
            } else {
                turnoTexto.textContent = 'No se ha asignado turno';
                turnoTexto.parentElement.classList.remove('bg-green-50', 'border-green-200');
                turnoTexto.parentElement.classList.add('bg-blue-50', 'border-blue-200');
            }
        }
        
        // ========== GESTIÓN DE VISTAS ==========
        
        // Elementos de vista
        const contDashboard = document.getElementById('dashboard-stats');
        const contAtenciones = document.getElementById('cont-atenciones');
        const contTurnosWeb = document.getElementById('cont-turnos-web');
        const contCalendario = document.getElementById('cont-calendario');
        const contAgenda = document.getElementById('cont-agenda');
        
        /**
         * Cambia la vista actual
         * @param {string} vista - Nombre de la vista
         */
        function cambiarVista(vista) {
            // Ocultar todas las vistas
            contDashboard.classList.add('hidden');
            contAtenciones.classList.add('hidden');
            contTurnosWeb.classList.add('hidden');
            contCalendario.classList.add('hidden');
            contAgenda.classList.add('hidden');
            
            // Resetear paginación
            paginaActual = 1;
            
            // Actualizar estilos de botones de navegación
            const botonesNavegacion = [
                'btn-volver-inicio',
                'btn-ver-atenciones', 
                'btn-ver-turnos', 
                'btn-ver-calendario', 
                'btn-gestion-agenda'
            ];
            
            // Resetear todos los botones
            botonesNavegacion.forEach(id => {
                const btn = document.getElementById(id);
                btn.classList.remove('bg-blue-800', 'text-white');
                btn.classList.add('bg-blue-700', 'text-white');
            });
            
            // Mostrar solo la vista seleccionada
            switch(vista) {
                case 'dashboard':
                    contDashboard.classList.remove('hidden');
                    document.getElementById('btn-volver-inicio').classList.add('bg-blue-800', 'text-white');
                    break;
                case 'atenciones':
                    contAtenciones.classList.remove('hidden');
                    document.getElementById('btn-ver-atenciones').classList.add('bg-blue-800', 'text-white');
                    break;
                case 'turnos-web':
                    contTurnosWeb.classList.remove('hidden');
                    document.getElementById('btn-ver-turnos').classList.add('bg-blue-800', 'text-white');
                    break;
                case 'calendario':
                    contCalendario.classList.remove('hidden');
                    document.getElementById('btn-ver-calendario').classList.add('bg-blue-800', 'text-white');
                    break;
                case 'agenda':
                    contAgenda.classList.remove('hidden');
                    document.getElementById('btn-gestion-agenda').classList.add('bg-blue-800', 'text-white');
                    break;
            }
            
            vistaActual = vista;
            render();
        }
        
        // Botones de navegación
        document.getElementById('btn-volver-inicio').addEventListener('click', () => cambiarVista('dashboard'));
        document.getElementById('btn-ver-atenciones').addEventListener('click', () => cambiarVista('atenciones'));
        document.getElementById('btn-ver-turnos').addEventListener('click', () => cambiarVista('turnos-web'));
        document.getElementById('btn-ver-calendario').addEventListener('click', () => cambiarVista('calendario'));
        document.getElementById('btn-gestion-agenda').addEventListener('click', () => cambiarVista('agenda'));

        // ========== GESTIÓN DE AGENDA ==========
        
        // Agregar fecha inactiva
        document.getElementById('btn-agregar-inactivo').addEventListener('click', async () => {
            const fechaInput = document.getElementById('nueva-fecha-inactiva');
            let fecha = fechaInput.value;
            
            if (!fecha) {
                mostrarAlertaSincronizacion(false, 'Por favor seleccione una fecha');
                return;
            }
            
            if (!diasInactivos.includes(fecha)) {
                diasInactivos.push(fecha);
                diasInactivos.sort();
                try {
                    await set(ref(db, "config/diasInactivos"), diasInactivos);
                    fechaInput.value = '';
                    actualizarListaFechasInactivas();
                    renderCalendario();
                    mostrarAlertaSincronizacion(true, 'Fecha inactiva agregada correctamente');
                } catch (error) {
                    console.error("Error agregando fecha inactiva:", error);
                    mostrarAlertaSincronizacion(false, `Error al agregar fecha: ${error.message}`);
                }
            } else {
                mostrarAlertaSincronizacion(false, 'Esta fecha ya está marcada como inactiva');
            }
        });
        
        // Configurar capacidad
        document.getElementById('btn-guardar-capacidad').addEventListener('click', async () => {
            const horarioSelect = document.getElementById('select-horario-capacidad');
            const capacidadInput = document.getElementById('input-capacidad');
            
            const horario = horarioSelect.value;
            const capacidad = parseInt(capacidadInput.value);
            
            if (!horario || isNaN(capacidad) || capacidad < 1) {
                mostrarAlertaSincronizacion(false, 'Por favor complete todos los campos correctamente');
                return;
            }
            
            capacidadHoraria[horario] = capacidad;
            try {
                await set(ref(db, "config/capacidadHoraria"), capacidadHoraria);
                actualizarListaCapacidades();
                actualizarHorariosDisponibles();
                mostrarAlertaSincronizacion(true, `Capacidad para ${horario} actualizada a ${capacidad} turnos`);
            } catch (error) {
                console.error("Error guardando capacidad:", error);
                mostrarAlertaSincronizacion(false, `Error al guardar capacidad: ${error.message}`);
            }
        });
        
        /**
         * Actualiza lista de fechas inactivas
         */
        function actualizarListaFechasInactivas() {
            const lista = document.getElementById('lista-fechas-inactivas');
            const resumen = document.getElementById('resumen-fechas-inactivas');
            
            lista.innerHTML = '';
            
            if (diasInactivos.length === 0) {
                resumen.textContent = 'No hay fechas inactivas configuradas';
                return;
            }
            
            resumen.textContent = `${diasInactivos.length} fecha(s) inactiva(s) configurada(s)`;
            
            diasInactivos.forEach(fecha => {
                const fechaObj = parseLocalDate(fecha);
                const fechaFormateada = formatDateForDisplay(fechaObj);
                
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
                div.innerHTML = `
                    <span>${fechaFormateada}</span>
                    <button class="text-red-500 hover:text-red-700 eliminar-inactivo" data-fecha="${fecha}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                lista.appendChild(div);
            });
            
            // Agregar event listeners a botones de eliminar
            document.querySelectorAll('.eliminar-inactivo').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const fecha = e.target.closest('button').dataset.fecha;
                    diasInactivos = diasInactivos.filter(d => d !== fecha);
                    try {
                        await set(ref(db, "config/diasInactivos"), diasInactivos);
                        actualizarListaFechasInactivas();
                        renderCalendario();
                        mostrarAlertaSincronizacion(true, 'Fecha inactiva eliminada correctamente');
                    } catch (error) {
                        console.error("Error eliminando fecha inactiva:", error);
                        mostrarAlertaSincronizacion(false, `Error al eliminar fecha: ${error.message}`);
                    }
                });
            });
        }
        
        /**
         * Actualiza lista de capacidades configuradas
         */
        function actualizarListaCapacidades() {
            const lista = document.getElementById('lista-capacidades');
            lista.innerHTML = '<p class="text-sm text-gray-600">Capacidades configuradas:</p>';
            
            Object.entries(capacidadHoraria).forEach(([hora, capacidad]) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between text-sm mt-1';
                div.innerHTML = `<span>${hora}</span><span class="font-bold">${capacidad} turnos</span>`;
                lista.appendChild(div);
            });
        }
        
        // Sincronizar agenda
        document.getElementById('btn-sincronizar-agenda').addEventListener('click', () => {
            mostrarAlertaSincronizacion(true, 'Agenda sincronizada correctamente. Los cambios se reflejarán en el formulario público.');
        });
        
        // ========== GESTIÓN DE MODALES ==========
        
        // Modal de registro
        const modalRegistro = document.getElementById('modal-registro');
        
        // Función para abrir modal con validación de día laborable
        function abrirModalRegistro() {
            // Validar si es día no laborable
            if (esDiaNoLaborable()) {
                mostrarAlertaSincronizacion(false, 'No se pueden registrar consultas en días no laborables (Sábados, Domingos y Feriados).');
                return;
            }
            
            // Verificar que el usuario esté logueado
            if (!usuarioLogueado) {
                mostrarAlertaSincronizacion(false, 'Debe iniciar sesión para crear una consulta');
                return;
            }
            
            // CAMBIO: Fijar el nombre del usuario logueado en el campo "Responsable que asigna tarea"
            document.getElementById('m-responsable').value = usuarioLogueado;
            
            // Reiniciar selección de turno
            selectedDate = null;
            selectedTime = null;
            document.getElementById('m-fecha-turno').value = '';
            document.getElementById('m-horario-turno').value = '';
            document.getElementById('m-hora-personalizada').value = '';
            actualizarTextoSeleccionTurno();
            renderCalendario();
            
            // Resetear botones de horario
            document.querySelectorAll('#horarios-container button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-white', 'text-gray-800');
            });
            
            modalRegistro.classList.add('active');
        }
        
        document.getElementById('btn-nueva').addEventListener('click', abrirModalRegistro);
        document.getElementById('btn-nueva-turno').addEventListener('click', abrirModalRegistro);
        
        document.getElementById('btn-cerrar-modal').addEventListener('click', () => {
            modalRegistro.classList.remove('active');
        });
        
        // Botones de navegación del calendario
        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendario();
        });
        
        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendario();
        });
        
        // Botón para usar hora personalizada
        document.getElementById('btn-usar-hora-personalizada').addEventListener('click', () => {
            const horaPersonalizada = document.getElementById('m-hora-personalizada').value;
            if (horaPersonalizada) {
                const hora = horaPersonalizada.substring(0, 5);
                const horaNum = parseInt(hora.substring(0, 2));
                const minuto = parseInt(hora.substring(3, 5));
                
                // Validar según feria o no
                let horaMinima, horaMaxima, minutoMaximo;
                if (selectedDate && esFechaDeFeria(selectedDate)) {
                    horaMinima = 8;
                    horaMaxima = 10;
                    minutoMaximo = 0; // Hasta las 10:00 inclusive
                } else {
                    horaMinima = 7;
                    horaMaxima = 11;
                    minutoMaximo = 30; // Hasta las 11:30 inclusive
                }
                
                if (horaNum < horaMinima || horaNum > horaMaxima || (horaNum === horaMaxima && minuto > minutoMaximo)) {
                    mostrarAlertaSincronizacion(false, `Los horarios permitidos son de ${horaMinima}:00 a ${horaMaxima}:${minutoMaximo.toString().padStart(2, '0')}`);
                    return;
                }
                
                seleccionarHorario(hora);
            } else {
                mostrarAlertaSincronizacion(false, 'Por favor ingrese una hora válida');
            }
        });
        
        // Modal de gestión (VER)
        const modalGestion = document.getElementById('modal-gestion');
        document.getElementById('btn-cerrar-gestion').addEventListener('click', () => {
            modalGestion.classList.remove('active');
        });
        
        // ========== GESTIÓN DE CASOS ==========
        
        // Botones de estado en modal de gestión
        document.getElementById('btn-estado-pendiente').addEventListener('click', () => cambiarEstadoActual('pendiente'));
        document.getElementById('btn-estado-proceso').addEventListener('click', () => cambiarEstadoActual('en_proceso'));
        document.getElementById('btn-estado-resuelta').addEventListener('click', () => cambiarEstadoActual('resuelta'));
        document.getElementById('btn-estado-derivada').addEventListener('click', () => cambiarEstadoActual('derivada'));
        document.getElementById('btn-asignar-caso').addEventListener('click', asignarCasoActual);
        
        // Agregar nota al historial
        btnAgregarNota.addEventListener('click', agregarNota);
        nuevaNotaInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                agregarNota();
            }
        });
        
        // Menú de exportación para Atenciones
        btnExportar.addEventListener('click', (e) => {
            e.stopPropagation();
            menuExportar.classList.toggle('hidden');
        });
        
        // Menú de exportación para Turnos Web
        document.getElementById('btn-exportar-turnos').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('menu-exportar-turnos').classList.toggle('hidden');
        });
        
        // Menú de exportación para Calendario
        document.getElementById('btn-exportar-calendario').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('menu-exportar-calendario').classList.toggle('hidden');
        });
        
        // Cerrar menús al hacer clic fuera
        document.addEventListener('click', () => {
            menuExportar.classList.add('hidden');
            document.getElementById('menu-exportar-turnos').classList.add('hidden');
            document.getElementById('menu-exportar-calendario').classList.add('hidden');
        });
        
        // Prevenir que el clic en los menús los cierre
        menuExportar.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        document.getElementById('menu-exportar-turnos').addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        document.getElementById('menu-exportar-calendario').addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // Exportar a Excel (Atenciones)
        btnExportarExcel.addEventListener('click', exportarExcel);
        
        // Exportar a PDF (Atenciones)
        btnExportarPDF.addEventListener('click', exportarPDF);
        
        // Exportar a Excel (Turnos Web)
        document.getElementById('btn-exportar-excel-turnos').addEventListener('click', exportarExcelTurnosWeb);
        
        // Exportar a PDF (Turnos Web)
        document.getElementById('btn-exportar-pdf-turnos').addEventListener('click', exportarPDFTurnosWeb);
        
        // Exportar a Excel (Calendario)
        document.getElementById('btn-exportar-excel-calendario').addEventListener('click', exportarExcelCalendario);
        
        // Exportar a PDF (Calendario)
        document.getElementById('btn-exportar-pdf-calendario').addEventListener('click', exportarPDFCalendario);
        
        // ========== FILTROS Y BÚSQUEDA ==========
        
        // Debounce para búsqueda global
        let debounceTimer;
        document.getElementById('busqueda-global').addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                filtroBusqueda = e.target.value.toLowerCase();
                paginaActual = 1;
                render();
            }, 300);
        });

        // Filtro para Turnos Web
        document.getElementById('busqueda-turnos').addEventListener('input', (e) => {
            filtroBusquedaTurnos = e.target.value.toLowerCase();
            render();
        });
        
        document.getElementById('filtro-fecha-inicio').addEventListener('change', (e) => {
            filtroFechaInicio = e.target.value;
            paginaActual = 1;
        });
        
        document.getElementById('filtro-fecha-fin').addEventListener('change', (e) => {
            filtroFechaFin = e.target.value;
            paginaActual = 1;
        });
        
        document.getElementById('filtro-defensor').addEventListener('change', (e) => {
            filtroDefensor = e.target.value;
            paginaActual = 1;
        });
        
        document.getElementById('btn-aplicar-filtros').addEventListener('click', () => {
            paginaActual = 1;
            render();
        });
        
        document.getElementById('btn-limpiar-filtros').addEventListener('click', () => {
            document.getElementById('filtro-fecha-inicio').value = '';
            document.getElementById('filtro-fecha-fin').value = '';
            document.getElementById('filtro-defensor').value = '';
            filtroFechaInicio = '';
            filtroFechaFin = '';
            filtroDefensor = '';
            paginaActual = 1;
            render();
        });
        
        // Botón de actualizar filtros
        document.getElementById('btn-refresh-filtros').addEventListener('click', () => {
            render();
            mostrarAlertaSincronizacion(true, 'Filtros actualizados');
        });
        
        // Filtros para Calendario
        document.getElementById('busqueda-calendario').addEventListener('input', (e) => {
            filtroBusquedaCalendario = e.target.value.toLowerCase();
            render();
        });
        
        document.getElementById('filtro-fecha-inicio-calendario').addEventListener('change', (e) => {
            filtroFechaInicioCalendario = e.target.value;
        });
        
        document.getElementById('filtro-fecha-fin-calendario').addEventListener('change', (e) => {
            filtroFechaFinCalendario = e.target.value;
        });
        
        document.getElementById('filtro-defensor-calendario').addEventListener('change', (e) => {
            filtroDefensorCalendario = e.target.value;
        });
        
        document.getElementById('btn-aplicar-filtros-calendario').addEventListener('click', () => {
            render();
        });
        
        document.getElementById('btn-limpiar-filtros-calendario').addEventListener('click', () => {
            document.getElementById('filtro-fecha-inicio-calendario').value = '';
            document.getElementById('filtro-fecha-fin-calendario').value = '';
            document.getElementById('filtro-defensor-calendario').value = '';
            filtroFechaInicioCalendario = '';
            filtroFechaFinCalendario = '';
            filtroDefensorCalendario = '';
            render();
        });
        
        // Botón de actualizar calendario
        document.getElementById('btn-refresh-calendario').addEventListener('click', () => {
            render();
            mostrarAlertaSincronizacion(true, 'Calendario actualizado');
        });
        
        // Botón de actualizar turnos web
        document.getElementById('btn-refresh-turnos').addEventListener('click', () => {
            render();
            mostrarAlertaSincronizacion(true, 'Turnos web actualizados');
        });
        
        // ========== FORMULARIOS ==========
        
        // Formulario de registro
        document.getElementById('form-interno').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const nuevoRegistro = {
                    personName: document.getElementById('m-name').value.trim(),
                    dni: document.getElementById('m-dni').value.trim() || null,
                    telefono: document.getElementById('m-telefono').value.trim() || null,
                    type: document.getElementById('m-type').value,
                    assignedUser: document.getElementById('m-user').value || null,
                    responsable: document.getElementById('m-responsable').value || null, // Nuevo campo
                    description: document.getElementById('m-desc').value.trim(),
                    estado: 'pendiente',
                    timestamp: new Date().toISOString(),
                    notas: []
                };
                
                // Determinar origen basado en el tipo de consulta
                let origen = 'interno';
                if (nuevoRegistro.type && nuevoRegistro.type.includes('Consulta Web:')) {
                    origen = 'web';
                }
                nuevoRegistro.origen = origen;
                
                // Agregar turno si fue seleccionado - GUARDAR EN FORMATO 'YYYY-MM-DD'
                const fechaTurno = document.getElementById('m-fecha-turno').value;
                const horarioTurno = document.getElementById('m-horario-turno').value;
                
                if (fechaTurno) {
                    nuevoRegistro.fechaTurno = fechaTurno; // Ya está en formato 'YYYY-MM-DD'
                }
                
                if (horarioTurno) {
                    nuevoRegistro.horarioTurno = horarioTurno;
                }
                
                await push(baseRef, nuevoRegistro);
                
                modalRegistro.classList.remove('active');
                e.target.reset();
                
                // Limpiar selección de turno
                selectedDate = null;
                selectedTime = null;
                actualizarTextoSeleccionTurno();
                
                mostrarAlertaSincronizacion(true, 'Registro guardado exitosamente');
            } catch (error) {
                console.error('Error guardando registro:', error);
                mostrarAlertaSincronizacion(false, `Error al guardar el registro: ${error.message}`);
            }
        });
        
        // ========== FIREBASE LISTENERS ==========
        
        // Listener Firebase para datos principales
        onValue(baseRef, (snap) => {
            try {
                const data = snap.val();
                const nuevosDatos = data ? Object.entries(data).reverse().map(([id, r]) => ({id, ...r})) : [];
                
                // Detectar nuevas consultas web para notificación
                if (rawData.length > 0 && notificacionesActivas) {
                    const nuevosIds = nuevosDatos.map(r => r.id);
                    const viejosIds = rawData.map(r => r.id);
                    const idsNuevos = nuevosIds.filter(id => !viejosIds.includes(id));
                    
                    idsNuevos.forEach(id => {
                        const nuevoRegistro = nuevosDatos.find(r => r.id === id);
                        if (nuevoRegistro && esConsultaWeb(nuevoRegistro)) {
                            mostrarNotificacion(nuevoRegistro);
                            ultimaConsultaWebId = id;
                        }
                    });
                }
                
                rawData = nuevosDatos;
                render();
                
                // ACTUALIZAR KPIs Y GRÁFICOS EN TIEMPO REAL
                actualizarKPIs();
                actualizarGraficos();
                
                document.getElementById('ultima-actualizacion').textContent = formatDateTimeForDisplay(new Date());
            } catch (error) {
                console.error('Error procesando datos de Firebase:', error);
            }
        }, (error) => {
            console.error('Error en listener de Firebase:', error);
        });

        // ========== FUNCIONES DE INTERFAZ ==========
        
        /**
         * Actualiza los KPIs en el dashboard
         */
        function actualizarKPIs() {
            let atencionesCount = 0;
            let consultasWebCount = 0;
            let resueltasCount = 0;
            
            rawData.forEach(r => {
                if (esConsultaWeb(r)) {
                    consultasWebCount++;
                } else {
                    atencionesCount++;
                }
                
                if (r.estado === 'resuelta') {
                    resueltasCount++;
                }
            });
            
            const totalCount = atencionesCount + consultasWebCount;
            
            document.getElementById('atenciones-count').textContent = atencionesCount;
            document.getElementById('consultas-web-count').textContent = consultasWebCount;
            document.getElementById('resueltas-count').textContent = resueltasCount;
            document.getElementById('total-count').textContent = totalCount;
        }

        /**
         * Actualiza los gráficos del dashboard
         */
        function actualizarGraficos() {
            // Destruir gráficos existentes
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            // Gráfico 1: Tipos de trámites
            const tiposTramites = {};
            rawData.forEach(r => {
                let tipo = r.type || 'No especificado';
                if (esConsultaWeb(r)) {
                    tipo = tipo.replace('Consulta Web: ', '');
                }
                tiposTramites[tipo] = (tiposTramites[tipo] || 0) + 1;
            });
            
            const ctx1 = document.getElementById('chart-tipos-tramites').getContext('2d');
            charts.tiposTramites = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(tiposTramites),
                    datasets: [{
                        data: Object.values(tiposTramites),
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
                            '#ec4899', '#14b8a6', '#f97316', '#84cc16', '#06b6d4'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
            
            // Gráfico 2: Evolución mensual
            const evolucion = {};
            rawData.forEach(r => {
                if (r.timestamp) {
                    const fecha = new Date(r.timestamp);
                    const mes = fecha.getMonth() + 1;
                    const año = fecha.getFullYear();
                    const key = `${mes}/${año}`;
                    evolucion[key] = (evolucion[key] || 0) + 1;
                }
            });
            
            // Ordenar por fecha
            const labelsEvolucion = Object.keys(evolucion).sort((a, b) => {
                const [mesA, añoA] = a.split('/').map(Number);
                const [mesB, añoB] = b.split('/').map(Number);
                return new Date(añoA, mesA - 1) - new Date(añoB, mesB - 1);
            });
            
            const dataEvolucion = labelsEvolucion.map(label => evolucion[label]);
            
            const ctx2 = document.getElementById('chart-evolucion-mensual').getContext('2d');
            charts.evolucionMensual = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: labelsEvolucion,
                    datasets: [{
                        label: 'Casos registrados',
                        data: dataEvolucion,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#374151'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#374151'
                            },
                            grid: {
                                color: '#e5e7eb'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#374151'
                            },
                            grid: {
                                color: '#e5e7eb'
                            }
                        }
                    }
                }
            });
        }
        
        // Botón para refrescar gráficos
        document.getElementById('btn-refresh-charts').addEventListener('click', () => {
            actualizarGraficos();
            mostrarAlertaSincronizacion(true, 'Gráficos actualizados');
        });

        // ========== PAGINACIÓN ==========
        
        /**
         * Actualiza la información de paginación
         * @param {number} totalRegistros - Total de registros
         */
        function actualizarPaginacion(totalRegistros) {
            totalPaginas = Math.ceil(totalRegistros / registrosPorPagina);
            
            // Actualizar selects de página
            selectPagina.innerHTML = '';
            selectPaginaBottom.innerHTML = '';
            
            for (let i = 1; i <= totalPaginas; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Página ${i}`;
                if (i === paginaActual) option.selected = true;
                selectPagina.appendChild(option);
                
                const optionBottom = option.cloneNode(true);
                selectPaginaBottom.appendChild(optionBottom);
            }
            
            // Actualizar información de paginación
            const inicio = Math.min((paginaActual - 1) * registrosPorPagina + 1, totalRegistros);
            const fin = Math.min(paginaActual * registrosPorPagina, totalRegistros);
            
            const infoTexto = totalRegistros === 0 ? 
                'No hay registros' : 
                `Mostrando ${inicio}-${fin} de ${totalRegistros} registros`;
            
            paginacionInfoSuperior.textContent = infoTexto;
            paginacionInfoInferior.textContent = infoTexto;
            
            // Actualizar estado de botones
            const isFirstPage = paginaActual === 1;
            const isLastPage = paginaActual === totalPaginas || totalPaginas === 0;
            
            btnPrev.disabled = isFirstPage;
            btnNext.disabled = isLastPage;
            btnPrevBottom.disabled = isFirstPage;
            btnNextBottom.disabled = isLastPage;
        }

        // Event listeners para paginación
        btnPrev.addEventListener('click', () => {
            if (paginaActual > 1) {
                paginaActual--;
                render();
            }
        });
        
        btnNext.addEventListener('click', () => {
            if (paginaActual < totalPaginas) {
                paginaActual++;
                render();
            }
        });
        
        btnPrevBottom.addEventListener('click', () => {
            if (paginaActual > 1) {
                paginaActual--;
                render();
            }
        });
        
        btnNextBottom.addEventListener('click', () => {
            if (paginaActual < totalPaginas) {
                paginaActual++;
                render();
            }
        });
        
        selectPagina.addEventListener('change', (e) => {
            paginaActual = parseInt(e.target.value);
            selectPaginaBottom.value = paginaActual;
            render();
        });
        
        selectPaginaBottom.addEventListener('change', (e) => {
            paginaActual = parseInt(e.target.value);
            selectPagina.value = paginaActual;
            render();
        });

        // ========== RENDERIZADO PRINCIPAL ==========
        
        /**
         * Renderiza la vista actual según los filtros
         */
        function render() {
            const tbody = document.getElementById('tabla-body');
            const turnosBody = document.getElementById('turnos-body');
            const calendarioBody = document.getElementById('calendario-body');
            const tablaVacia = document.getElementById('tabla-vacia');
            const turnosWebVacia = document.getElementById('turnos-web-vacia');
            const calendarioVacia = document.getElementById('calendario-vacia');
            const calendarioTabla = document.querySelector('#cont-calendario > div.bg-white.rounded-xl.shadow-md');
            
            tbody.innerHTML = '';
            turnosBody.innerHTML = '';
            calendarioBody.innerHTML = '';
            
            // Aplicar filtros según la vista actual
            let filtrados = rawData.filter(r => {
                if (vistaActual === 'calendario') {
                    // Solo mostrar registros con fechaTurno en calendario
                    if (!r.fechaTurno) return false;
                    
                    // Solo mostrar turnos web en calendario
                    if (!esConsultaWeb(r)) return false;
                    
                    // Filtro de búsqueda para calendario
                    const coincideBusqueda = !filtroBusquedaCalendario || 
                        (r.personName && r.personName.toLowerCase().includes(filtroBusquedaCalendario)) || 
                        (r.dni && r.dni.includes(filtroBusquedaCalendario)) || 
                        (r.telefono && r.telefono.includes(filtroBusquedaCalendario));
                    
                    // Filtro por defensor para calendario
                    const coincideDefensor = !filtroDefensorCalendario || r.assignedUser === filtroDefensorCalendario;
                    
                    // Filtro por fecha para calendario (basado en fechaTurno)
                    let coincideFecha = true;
                    if (filtroFechaInicioCalendario || filtroFechaFinCalendario) {
                        if (r.fechaTurno) {
                            const fechaTurno = parseLocalDate(r.fechaTurno);
                            if (!fechaTurno) return false;
                            
                            const fechaInicio = filtroFechaInicioCalendario ? parseLocalDate(filtroFechaInicioCalendario) : null;
                            const fechaFin = filtroFechaFinCalendario ? parseLocalDate(filtroFechaFinCalendario) : null;
                            
                            if (fechaInicio && fechaTurno < fechaInicio) coincideFecha = false;
                            if (fechaFin && fechaTurno > fechaFin) coincideFecha = false;
                        } else {
                            coincideFecha = false;
                        }
                    }
                    
                    return coincideBusqueda && coincideDefensor && coincideFecha;
                } 
                else if (vistaActual === 'turnos-web') {
                    // Solo mostrar turnos web
                    if (!esConsultaWeb(r)) return false;
                    
                    // Filtro de búsqueda para turnos web
                    const coincideBusqueda = !filtroBusquedaTurnos || 
                        (r.personName && r.personName.toLowerCase().includes(filtroBusquedaTurnos)) || 
                        (r.dni && r.dni.includes(filtroBusquedaTurnos)) || 
                        (r.telefono && r.telefono.includes(filtroBusquedaTurnos));
                    
                    return coincideBusqueda;
                }
                else if (vistaActual === 'atenciones') {
                    // Solo mostrar atenciones (no turnos web)
                    if (esConsultaWeb(r)) return false;
                    
                    // Filtro de búsqueda para atenciones
                    const coincideBusqueda = !filtroBusqueda || 
                        (r.personName && r.personName.toLowerCase().includes(filtroBusqueda)) || 
                        (r.dni && r.dni.includes(filtroBusqueda)) || 
                        (r.telefono && r.telefono.includes(filtroBusqueda));
                    
                    // Filtro por defensor para atenciones
                    const coincideDefensor = !filtroDefensor || r.assignedUser === filtroDefensor;
                    
                    // Filtro por fecha para atenciones (basado en timestamp)
                    let coincideFecha = true;
                    if (filtroFechaInicio || filtroFechaFin) {
                        if (r.timestamp) {
                            const fechaRegistro = normalizeDate(new Date(r.timestamp));
                            const fechaInicio = filtroFechaInicio ? parseLocalDate(filtroFechaInicio) : null;
                            const fechaFin = filtroFechaFin ? parseLocalDate(filtroFechaFin) : null;
                            
                            if (fechaInicio && fechaRegistro < fechaInicio) coincideFecha = false;
                            if (fechaFin && fechaRegistro > fechaFin) coincideFecha = false;
                        } else {
                            coincideFecha = false;
                        }
                    }
                    
                    return coincideBusqueda && coincideDefensor && coincideFecha;
                }
                
                return true;
            });
            
            // Renderizar según la vista actual
            if (vistaActual === 'calendario') {
                if (filtrados.length === 0) {
                    calendarioTabla.classList.add('hidden');
                    calendarioVacia.classList.remove('hidden');
                } else {
                    calendarioTabla.classList.remove('hidden');
                    calendarioVacia.classList.add('hidden');
                    renderCalendarioTurnos(calendarioBody, filtrados);
                }
            } else if (vistaActual === 'turnos-web') {
                if (filtrados.length === 0) {
                    turnosWebVacia.classList.remove('hidden');
                    turnosBody.innerHTML = '';
                } else {
                    turnosWebVacia.classList.add('hidden');
                    renderTablaTurnosWeb(turnosBody, filtrados);
                }
            } else if (vistaActual === 'atenciones') {
                totalRegistros = filtrados.length;
                
                // Actualizar paginación
                actualizarPaginacion(totalRegistros);
                
                if (filtrados.length === 0) {
                    tbody.innerHTML = '';
                    tablaVacia.classList.remove('hidden');
                } else {
                    tablaVacia.classList.add('hidden');
                    
                    // Calcular registros para la página actual
                    const inicio = (paginaActual - 1) * registrosPorPagina;
                    const fin = Math.min(inicio + registrosPorPagina, filtrados.length);
                    const registrosPagina = filtrados.slice(inicio, fin);
                    
                    renderTablaPrincipal(tbody, registrosPagina);
                }
            }
        }
        
        /**
         * Renderiza la tabla principal de atenciones
         * @param {HTMLElement} tbody - Elemento tbody
         * @param {Array} datos - Datos a renderizar
         */
        function renderTablaPrincipal(tbody, datos) {
            datos.forEach(r => {
                const fecha = r.timestamp ? formatDateTimeForDisplay(new Date(r.timestamp)) : '--';
                const estado = r.estado || 'pendiente';
                const badgeColor = getBadgeColor(estado);
                
                const tieneTurno = r.fechaTurno && r.horarioTurno;
                const fechaTurnoFormateada = r.fechaTurno ? formatShortDateForDisplay(r.fechaTurno) : '';
                const infoTurno = tieneTurno ? `<br><span class="text-xs text-blue-600">Turno: ${fechaTurnoFormateada} ${r.horarioTurno}</span>` : '';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition';
                row.innerHTML = `
                    <td class="px-4 sm:px-6 py-4 text-xs">${fecha}</td>
                    <td class="px-4 sm:px-6 py-4 font-semibold">
                        ${r.personName || 'Sin nombre'} 
                        ${r.dni ? `<br><span class="text-xs text-gray-500">DNI: ${r.dni}</span>` : ''}
                        ${infoTurno}
                    </td>
                    <td class="px-4 sm:px-6 py-4 text-xs">
                        <div class="flex items-center justify-between">
                            <span>${r.telefono || 'No registrado'}</span>
                            ${r.telefono ? `
                                <button class="btn-whatsapp text-green-600 hover:text-green-800 ml-2" data-telefono="${r.telefono}" data-nombre="${r.personName}">
                                    <i class="fab fa-whatsapp text-lg"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                    <td class="px-4 sm:px-6 py-4 text-xs font-bold text-blue-600 uppercase">${(r.type || '').replace('Consulta Web: ', '')}</td>
                    <td class="px-4 sm:px-6 py-4 text-xs">${r.assignedUser || 'Sin asignar'}</td>
                    <td class="px-4 sm:px-6 py-4"><span class="px-2 py-1 rounded-full text-[10px] font-bold ${badgeColor}">${estado.toUpperCase()}</span></td>
                    <td class="px-4 sm:px-6 py-4 text-center space-x-2">
                        <button class="btn-ver-detalles text-blue-500 hover:text-blue-700" data-id="${r.id}" title="Ver detalles">
                            <i class="fas fa-eye text-lg"></i>
                        </button>
                        ${r.fechaTurno && r.horarioTurno ? `
                            <button class="btn-comprobante text-red-500 hover:text-red-700" data-id="${r.id}" title="Comprobante PDF">
                                <i class="fas fa-file-pdf text-lg"></i>
                            </button>
                        ` : ''}
                        ${(!r.assignedUser || r.assignedUser === 'Sin asignar') ? `
                            <button class="btn-asignar text-orange-500 hover:text-orange-700" data-id="${r.id}" title="Asignarse caso">
                                <i class="fas fa-user-plus text-lg"></i>
                            </button>
                        ` : ''}
                    </td>
                `;
                
                tbody.appendChild(row);
                
                // Event listeners
                const btnWhatsapp = row.querySelector('.btn-whatsapp');
                if (btnWhatsapp) {
                    btnWhatsapp.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const telefono = btnWhatsapp.dataset.telefono;
                        const nombre = btnWhatsapp.dataset.nombre || 'ciudadano';
                        const mensaje = `Hola ${nombre}, nos comunicamos de la Defensoría Civil y Comercial 6 respecto a su turno. Por favor confirme su disponibilidad.`;
                        window.open(`https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`, '_blank');
                    });
                }
                
                row.querySelector('.btn-ver-detalles').addEventListener('click', (e) => {
                    e.stopPropagation();
                    verDetalles(r.id);
                });
                
                row.querySelector('.btn-comprobante')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    mostrarComprobante(r.id);
                });
                
                row.querySelector('.btn-asignar')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    asignarDirecto(r.id);
                });
            });
        }

        /**
         * Renderiza tabla de turnos web
         * @param {HTMLElement} turnosBody - Elemento tbody
         * @param {Array} datos - Datos a renderizar
         */
        function renderTablaTurnosWeb(turnosBody, datos) {
            // ORDENAR: Más recientes primero
            datos.sort((a, b) => {
                const fechaA = a.timestamp ? new Date(a.timestamp) : new Date(0);
                const fechaB = b.timestamp ? new Date(b.timestamp) : new Date(0);
                return fechaB - fechaA;
            });
            
            datos.forEach(r => {
                const estado = r.estado || 'pendiente';
                const badgeColor = getBadgeColor(estado);
                
                const fechaTurnoFormateada = r.fechaTurno ? formatShortDateForDisplay(r.fechaTurno) : '--';
                const fechaRegistro = r.timestamp ? formatShortDateForDisplay(new Date(r.timestamp)) : '--';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition';
                row.innerHTML = `
                    <td class="px-4 sm:px-6 py-4 font-semibold">${fechaTurnoFormateada}</td>
                    <td class="px-4 sm:px-6 py-4 font-bold">${r.horarioTurno || '--'}</td>
                    <td class="px-4 sm:px-6 py-4">
                        ${r.personName || 'Sin nombre'}
                        <br><span class="text-xs text-gray-500">Reg: ${fechaRegistro}</span>
                    </td>
                    <td class="px-4 sm:px-6 py-4">${r.dni || '--'}</td>
                    <td class="px-4 sm:px-6 py-4">
                        <div class="flex items-center justify-between">
                            <span>${r.telefono || '--'}</span>
                            ${r.telefono ? `
                                <button class="btn-whatsapp-turno text-green-600 hover:text-green-800 ml-2" data-telefono="${r.telefono}" data-nombre="${r.personName}">
                                    <i class="fab fa-whatsapp text-sm"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                    <td class="px-4 sm:px-6 py-4 font-bold ${r.type && r.type.includes('Alimentos') ? 'text-red-600' : 'text-blue-600'}">
                        ${(r.type || '').replace('Consulta Web: ', '')}
                    </td>
                    <td class="px-4 sm:px-6 py-4">${r.assignedUser || 'Sin asignar'}</td>
                    <td class="px-4 sm:px-6 py-4"><span class="px-2 py-1 rounded-full text-[10px] font-bold ${badgeColor}">${estado.toUpperCase()}</span></td>
                    <td class="px-4 sm:px-6 py-4 text-center space-x-2">
                        <button class="btn-ver-detalles text-blue-500 hover:text-blue-700" data-id="${r.id}" title="Ver detalles">
                            <i class="fas fa-eye text-lg"></i>
                        </button>
                        <button class="btn-comprobante text-red-500 hover:text-red-700" data-id="${r.id}" title="Comprobante PDF">
                            <i class="fas fa-file-pdf text-lg"></i>
                        </button>
                        <button class="btn-eliminar-consulta-web text-red-500 hover:text-red-700" data-id="${r.id}" data-nombre="${r.personName}" data-fecha="${fechaTurnoFormateada}" data-hora="${r.horarioTurno}" title="Eliminar consulta web">
                            <i class="fas fa-trash text-lg"></i>
                        </button>
                    </td>
                `;
                
                turnosBody.appendChild(row);
                
                // Event listeners
                const btnWhatsappTurno = row.querySelector('.btn-whatsapp-turno');
                if (btnWhatsappTurno) {
                    btnWhatsappTurno.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const telefono = btnWhatsappTurno.dataset.telefono;
                        const nombre = btnWhatsappTurno.dataset.nombre || 'ciudadano';
                        const mensaje = `Hola ${nombre}, nos comunicamos de la Defensoría Civil y Comercial 6 respecto a su turno. Por favor confirme su disponibilidad.`;
                        window.open(`https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`, '_blank');
                    });
                }
                
                row.querySelector('.btn-ver-detalles').addEventListener('click', (e) => {
                    e.stopPropagation();
                    verDetalles(r.id);
                });
                
                row.querySelector('.btn-comprobante').addEventListener('click', (e) => {
                    e.stopPropagation();
                    mostrarComprobante(r.id);
                });
                
                row.querySelector('.btn-eliminar-consulta-web').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const btn = e.target.closest('.btn-eliminar-consulta-web');
                    casoAEliminarId = btn.dataset.id;
                    eliminarInfo.textContent = `¿Eliminar consulta web de ${btn.dataset.nombre || 'ciudadano sin nombre'} para el ${btn.dataset.fecha} a las ${btn.dataset.hora}?`;
                    modalEliminar.classList.add('active');
                });
            });
        }
        
        /**
         * Renderiza calendario de turnos
         * @param {HTMLElement} calendarioBody - Elemento tbody
         * @param {Array} datos - Datos a renderizar
         */
        function renderCalendarioTurnos(calendarioBody, datos) {
            // Ordenar por fecha de turno
            const turnosWeb = datos.sort((a,b) => {
                if (!a.fechaTurno || !b.fechaTurno) return 0;
                const fechaA = parseLocalDate(a.fechaTurno);
                const fechaB = parseLocalDate(b.fechaTurno);
                if (!fechaA || !fechaB) return 0;
                return fechaA - fechaB;
            });
            
            turnosWeb.forEach(r => {
                const estado = r.estado || 'pendiente';
                const badgeColor = getBadgeColor(estado);
                
                const fechaTurnoFormateada = r.fechaTurno ? formatShortDateForDisplay(r.fechaTurno) : '';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition';
                row.innerHTML = `
                    <td class="px-4 sm:px-6 py-4 font-semibold">${fechaTurnoFormateada}</td>
                    <td class="px-4 sm:px-6 py-4 font-bold">${r.horarioTurno || '--'}</td>
                    <td class="px-4 sm:px-6 py-4">${r.personName || 'Sin nombre'}</td>
                    <td class="px-4 sm:px-6 py-4">${r.dni || '--'}</td>
                    <td class="px-4 sm:px-6 py-4">${r.telefono || '--'}</td>
                    <td class="px-4 sm:px-6 py-4 font-bold ${r.type && r.type.includes('Alimentos') ? 'text-red-600' : 'text-blue-600'}">
                        ${(r.type || '').replace('Consulta Web: ', '')}
                    </td>
                    <td class="px-4 sm:px-6 py-4">${r.assignedUser || 'Sin asignar'}</td>
                    <td class="px-4 sm:px-6 py-4"><span class="px-2 py-1 rounded-full text-[10px] font-bold ${badgeColor}">${estado.toUpperCase()}</span></td>
                    <td class="px-4 sm:px-6 py-4 text-center space-x-2">
                        <button class="btn-ver-detalles text-blue-500 hover:text-blue-700" data-id="${r.id}" title="Ver detalles">
                            <i class="fas fa-eye text-lg"></i>
                        </button>
                        <button class="btn-comprobante text-red-500 hover:text-red-700" data-id="${r.id}" title="Comprobante PDF">
                            <i class="fas fa-file-pdf text-lg"></i>
                        </button>
                        <button class="btn-eliminar-consulta-web text-red-500 hover:text-red-700" data-id="${r.id}" data-nombre="${r.personName}" data-fecha="${fechaTurnoFormateada}" data-hora="${r.horarioTurno}" title="Eliminar consulta web">
                            <i class="fas fa-trash text-lg"></i>
                        </button>
                    </td>
                `;
                
                calendarioBody.appendChild(row);
                
                // Event listeners
                row.querySelector('.btn-ver-detalles').addEventListener('click', (e) => {
                    e.stopPropagation();
                    verDetalles(r.id);
                });
                
                row.querySelector('.btn-comprobante').addEventListener('click', (e) => {
                    e.stopPropagation();
                    mostrarComprobante(r.id);
                });
                
                row.querySelector('.btn-eliminar-consulta-web').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const btn = e.target.closest('.btn-eliminar-consulta-web');
                    casoAEliminarId = btn.dataset.id;
                    eliminarInfo.textContent = `¿Eliminar consulta web de ${btn.dataset.nombre || 'ciudadano sin nombre'} para el ${btn.dataset.fecha} a las ${btn.dataset.hora}?`;
                    modalEliminar.classList.add('active');
                });
            });
        }
        
        /**
         * Obtiene el color del badge según el estado
         * @param {string} estado - Estado del caso
         * @returns {string} Clases CSS para el badge
         */
        function getBadgeColor(estado) {
            const colores = {
                'resuelta': 'bg-green-100 text-green-700',
                'en_proceso': 'bg-blue-100 text-blue-700',
                'derivada': 'bg-purple-100 text-purple-700',
                'pendiente': 'bg-yellow-100 text-yellow-700'
            };
            return colores[estado] || 'bg-gray-100 text-gray-700';
        }
        
        // ========== FUNCIONES DE GESTIÓN DE CASOS ==========
        
        /**
         * Muestra los detalles de un caso
         * @param {string} id - ID del caso
         */
        function verDetalles(id) {
            const caso = rawData.find(r => r.id === id);
            if (!caso) return;
            
            casoActualId = id;
            
            document.getElementById('det-nombre').textContent = caso.personName || 'No registrado';
            document.getElementById('det-dni').textContent = caso.dni || 'No registrado';
            document.getElementById('det-telefono-texto').textContent = caso.telefono || 'No registrado';
            document.getElementById('det-tipo').textContent = caso.type || 'No especificado';
            document.getElementById('det-desc').textContent = caso.description || 'Sin descripción';
            
            // Formatear fechas para mostrar
            const fechaRegistro = caso.timestamp ? new Date(caso.timestamp) : null;
            document.getElementById('det-fecha').textContent = fechaRegistro ? 
                formatDateTimeForDisplay(fechaRegistro) : 'No registrada';
            
            const fechaTurno = caso.fechaTurno;
            const fechaTurnoFormateada = fechaTurno ? formatDateForDisplay(fechaTurno) : '';
            document.getElementById('det-turno').textContent = fechaTurno ? 
                `${fechaTurnoFormateada} ${caso.horarioTurno || ''}` : 'No tiene turno asignado';
            
            // Mostrar usuario asignado
            document.getElementById('det-usuario').textContent = caso.assignedUser || 'Sin asignar';
            
            // Mostrar estado con el color adecuado
            const estado = caso.estado || 'pendiente';
            const badgeColor = getBadgeColor(estado);
            const detEstadoTexto = document.getElementById('det-estado-texto');
            detEstadoTexto.textContent = estado.toUpperCase();
            detEstadoTexto.className = `px-2 py-1 rounded-full text-[10px] font-bold ${badgeColor}`;
            
            // Cargar historial de notas
            cargarHistorialNotas(caso);
            
            // Configurar botón de WhatsApp en detalles
            const btnWhatsappDetalle = document.getElementById('btn-whatsapp-detalle');
            if (caso.telefono) {
                btnWhatsappDetalle.style.display = 'inline-block';
                btnWhatsappDetalle.onclick = () => {
                    const mensaje = `Hola ${caso.personName || 'ciudadano'}, nos comunicamos de la Defensoría Civil y Comercial 6 respecto a su turno.`;
                    window.open(`https://wa.me/${caso.telefono}?text=${encodeURIComponent(mensaje)}`, '_blank');
                };
            } else {
                btnWhatsappDetalle.style.display = 'none';
            }
            
            modalGestion.classList.add('active');
        }
        
        /**
         * Muestra el modal de comprobante
         * @param {string} id - ID del caso
         */
        function mostrarComprobante(id) {
            const caso = rawData.find(r => r.id === id);
            if (!caso) return;

            comprobanteActualId = id;

            document.getElementById('comp-nombre').textContent = caso.personName || 'No registrado';
            document.getElementById('comp-dni').textContent = caso.dni || 'No registrado';
            document.getElementById('comp-telefono').textContent = caso.telefono || 'No registrado';
            document.getElementById('comp-tipo').textContent = caso.type || 'No especificado';
            
            const fechaTurnoFormateada = caso.fechaTurno ? formatShortDateForDisplay(caso.fechaTurno) : '';
            document.getElementById('comp-fecha-hora').textContent = caso.fechaTurno && caso.horarioTurno ? 
                `${fechaTurnoFormateada} ${caso.horarioTurno}` : 'No asignado';
            
            document.getElementById('comp-usuario').textContent = caso.assignedUser || 'Sin asignar';
            document.getElementById('comp-responsable').textContent = caso.responsable || 'No registrado';
            document.getElementById('comp-estado').textContent = caso.estado || 'pendiente';

            modalComprobante.classList.add('active');
        }
        
        /**
         * Descarga el comprobante en PDF
         */
        function descargarComprobantePDF() {
            if (!comprobanteActualId) return;

            const caso = rawData.find(r => r.id === comprobanteActualId);
            if (!caso) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            // Encabezado
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 128);
            doc.text('Defensoría Civil y Comercial 6', 105, 20, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('COMPROBANTE DE TURNO', 105, 30, { align: 'center' });

            // Línea separadora
            doc.setDrawColor(0, 0, 128);
            doc.setLineWidth(0.5);
            doc.line(20, 35, 190, 35);

            // Datos del turno
            doc.setFontSize(12);
            let y = 50;

            const datos = [
                { label: 'Ciudadano:', value: caso.personName || 'No registrado' },
                { label: 'DNI:', value: caso.dni || 'No registrado' },
                { label: 'Teléfono:', value: caso.telefono || 'No registrado' },
                { label: 'Tipo de Consulta:', value: caso.type || 'No especificado' },
                { label: 'Fecha y Hora:', value: caso.fechaTurno && caso.horarioTurno ? 
                    `${formatShortDateForDisplay(caso.fechaTurno)} ${caso.horarioTurno}` : 'No asignado' },
                { label: 'Usuario Asignado:', value: caso.assignedUser || 'Sin asignar' },
                { label: 'Responsable que asigna:', value: caso.responsable || 'No registrado' },
                { label: 'Estado:', value: caso.estado || 'pendiente' }
            ];

            datos.forEach(dato => {
                doc.setFont('helvetica', 'bold');
                doc.text(dato.label, 20, y);
                doc.setFont('helvetica', 'normal');
                doc.text(dato.value, 80, y);
                y += 10;
            });

            // Pie de página
            const fechaGeneracion = formatDateTimeForDisplay(new Date());
            doc.setFontSize(10);
            doc.text(`Comprobante generado el: ${fechaGeneracion}`, 105, 150, { align: 'center' });
            doc.text('Documento oficial - Defensoría Civil y Comercial 6 - Ministerio Público', 105, 160, { align: 'center' });

            // Código de barras (simulado con texto)
            doc.setFontSize(8);
            doc.text(`ID: ${comprobanteActualId}`, 105, 170, { align: 'center' });

            // Descargar
            const nombreArchivo = `Comprobante_${caso.personName || 'Turno'}_${caso.fechaTurno || ''}.pdf`;
            doc.save(nombreArchivo);
        }
        
        /**
         * Carga el historial de notas de un caso
         * @param {Object} caso - Caso del que cargar notas
         */
        function cargarHistorialNotas(caso) {
            historialNotas.innerHTML = '';
            
            // Incluir la descripción original como primera nota
            if (caso.description) {
                const descItem = document.createElement('div');
                descItem.className = 'historial-item mb-3';
                descItem.innerHTML = `
                    <p class="text-xs text-gray-500 mb-1">
                        <i class="fas fa-file-alt mr-1"></i> Descripción inicial - ${caso.timestamp ? formatDateForDisplay(new Date(caso.timestamp)) : 'Sin fecha'}
                    </p>
                    <p class="text-sm">${caso.description}</p>
                `;
                historialNotas.appendChild(descItem);
            }
            
            // Cargar notas adicionales
            const notas = caso.notas || [];
            notas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            notas.forEach((nota) => {
                const notaItem = document.createElement('div');
                notaItem.className = 'historial-item mb-3';
                
                if (nota.tipo === 'resuelto') notaItem.classList.add('resuelto');
                if (nota.tipo === 'derivado') notaItem.classList.add('derivado');
                
                const fechaNota = nota.fecha ? formatDateTimeForDisplay(new Date(nota.fecha)) : 'Sin fecha';
                
                notaItem.innerHTML = `
                    <p class="text-xs text-gray-500 mb-1">
                        <i class="fas fa-sticky-note mr-1"></i> ${nota.autor || 'Sistema'} - ${fechaNota}
                        ${nota.tipo ? `<span class="ml-2 px-2 py-0.5 rounded text-xs ${getBadgeColor(nota.tipo)}">${nota.tipo.toUpperCase()}</span>` : ''}
                    </p>
                    <p class="text-sm">${nota.texto}</p>
                `;
                historialNotas.appendChild(notaItem);
            });
            
            // Actualizar contador de notas
            const totalNotas = notas.length + (caso.description ? 1 : 0);
            document.getElementById('contador-notas').textContent = `${totalNotas} observaciones`;
            
            if (totalNotas === 0) {
                historialNotas.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No hay observaciones registradas</p>';
            }
        }
        
        /**
         * Agrega una nueva nota al caso actual
         */
        async function agregarNota() {
            const texto = nuevaNotaInput.value.trim();
            if (!texto || !casoActualId) {
                mostrarAlertaSincronizacion(false, 'Por favor ingrese una observación');
                return;
            }
            
            try {
                const casoRef = ref(db, `atencion/${casoActualId}`);
                const caso = rawData.find(r => r.id === casoActualId);
                const notasActuales = caso.notas || [];
                
                const nuevaNota = {
                    texto: texto,
                    fecha: new Date().toISOString(),
                    autor: 'Usuario actual',
                    tipo: 'nota'
                };
                
                const notasActualizadas = [...notasActuales, nuevaNota];
                await update(casoRef, { notas: notasActualizadas });
                
                nuevaNotaInput.value = '';
                verDetalles(casoActualId);
                mostrarAlertaSincronizacion(true, 'Observación agregada correctamente');
            } catch (error) {
                console.error('Error agregando nota:', error);
                mostrarAlertaSincronizacion(false, `Error al agregar la observación: ${error.message}`);
            }
        }
        
        /**
         * Cambia el estado del caso actual
         * @param {string} nuevoEstado - Nuevo estado
         */
        async function cambiarEstadoActual(nuevoEstado) {
            if (!casoActualId) return;
            
            try {
                const casoRef = ref(db, `atencion/${casoActualId}`);
                const caso = rawData.find(r => r.id === casoActualId);
                const notasActuales = caso.notas || [];
                
                const notaEstado = {
                    texto: `Estado cambiado a: ${nuevoEstado}`,
                    fecha: new Date().toISOString(),
                    autor: 'Sistema',
                    tipo: nuevoEstado
                };
                
                const notasActualizadas = [...notasActuales, notaEstado];
                
                await update(casoRef, { 
                    estado: nuevoEstado,
                    notas: notasActualizadas 
                });
                
                modalGestion.classList.remove('active');
                mostrarAlertaSincronizacion(true, `Estado cambiado a: ${nuevoEstado}`);
            } catch (error) {
                console.error('Error cambiando estado:', error);
                mostrarAlertaSincronizacion(false, `Error al cambiar estado: ${error.message}`);
            }
        }
        
        /**
         * Asigna el caso actual a un usuario
         */
        async function asignarCasoActual() {
            if (!casoActualId) return;
            const usuario = document.getElementById('select-asignar').value;
            if (!usuario) {
                mostrarAlertaSincronizacion(false, 'Seleccione un usuario para asignar');
                return;
            }
            
            try {
                const casoRef = ref(db, `atencion/${casoActualId}`);
                const caso = rawData.find(r => r.id === casoActualId);
                const notasActuales = caso.notas || [];
                
                const notaAsignacion = {
                    texto: `Caso asignado a: ${usuario}`,
                    fecha: new Date().toISOString(),
                    autor: 'Sistema',
                    tipo: 'en_proceso'
                };
                
                const notasActualizadas = [...notasActuales, notaAsignacion];
                
                // ACTUALIZAR CAMPO assignedUser EN FIREBASE
                await update(casoRef, { 
                    assignedUser: usuario,
                    estado: 'en_proceso',
                    notas: notasActualizadas
                });
                
                modalGestion.classList.remove('active');
                mostrarAlertaSincronizacion(true, `Caso asignado a ${usuario}`);
            } catch (error) {
                console.error('Error asignando caso:', error);
                mostrarAlertaSincronizacion(false, `Error al asignar caso: ${error.message}`);
            }
        }
        
        /**
         * Asigna directamente un caso
         * @param {string} id - ID del caso
         */
        async function asignarDirecto(id) {
            const usuario = prompt("Ingrese su nombre para asignarse el caso:");
            if (usuario && users.includes(usuario)) {
                try {
                    const casoRef = ref(db, `atencion/${id}`);
                    const caso = rawData.find(r => r.id === id);
                    const notasActuales = caso.notas || [];
                    
                    const notaAsignacion = {
                        texto: `Caso auto-asignado a: ${usuario}`,
                        fecha: new Date().toISOString(),
                        autor: 'Sistema',
                        tipo: 'en_proceso'
                    };
                    
                    const notasActualizadas = [...notasActuales, notaAsignacion];
                    
                    // ACTUALIZAR CAMPO assignedUser EN FIREBASE
                    await update(casoRef, {
                        assignedUser: usuario,
                        estado: 'en_proceso',
                        notas: notasActualizadas
                    });
                    
                    mostrarAlertaSincronizacion(true, `Caso asignado a ${usuario}`);
                } catch (error) {
                    console.error('Error en asignación directa:', error);
                    mostrarAlertaSincronizacion(false, `Error al asignar caso: ${error.message}`);
                }
            } else if (usuario) {
                mostrarAlertaSincronizacion(false, "Usuario no válido. Debe seleccionar de la lista: " + users.join(', '));
            }
        }
        
        // ========== EXPORTACIÓN ==========
        
        /**
         * Exporta datos de Atenciones a Excel
         */
        function exportarExcel() {
            let datosExportar = [];
            
            if (vistaActual === 'atenciones') {
                datosExportar = rawData.filter(r => {
                    if (esConsultaWeb(r)) return false;
                    
                    const coincideBusqueda = !filtroBusqueda || 
                        (r.personName && r.personName.toLowerCase().includes(filtroBusqueda)) || 
                        (r.dni && r.dni.includes(filtroBusqueda)) || 
                        (r.telefono && r.telefono.includes(filtroBusqueda));
                    
                    const coincideDefensor = !filtroDefensor || r.assignedUser === filtroDefensor;
                    
                    let coincideFecha = true;
                    if (filtroFechaInicio || filtroFechaFin) {
                        if (r.timestamp) {
                            const fechaRegistro = normalizeDate(new Date(r.timestamp));
                            const fechaInicio = filtroFechaInicio ? parseLocalDate(filtroFechaInicio) : null;
                            const fechaFin = filtroFechaFin ? parseLocalDate(filtroFechaFin) : null;
                            
                            if (fechaInicio && fechaRegistro < fechaInicio) coincideFecha = false;
                            if (fechaFin && fechaRegistro > fechaFin) coincideFecha = false;
                        } else {
                            coincideFecha = false;
                        }
                    }
                    
                    return coincideBusqueda && coincideDefensor && coincideFecha;
                });
            }
            
            if (datosExportar.length === 0) {
                mostrarAlertaSincronizacion(false, 'No hay datos para exportar con los filtros actuales');
                return;
            }
            
            // Preparar datos para Excel
            const datosFormateados = datosExportar.map(r => {
                return {
                    'Fecha Registro': r.timestamp ? formatDateTimeForDisplay(new Date(r.timestamp)) : '',
                    'Nombre Ciudadano': r.personName || '',
                    'DNI': r.dni || '',
                    'Teléfono': r.telefono || '',
                    'Tipo Consulta': r.type || '',
                    'Descripción': r.description || '',
                    'Usuario asignado': r.assignedUser || '',
                    'Responsable que asigna': r.responsable || '', // Nuevo campo
                    'Estado': r.estado || 'pendiente',
                    'Fecha Turno': r.fechaTurno ? formatShortDateForDisplay(r.fechaTurno) : '',
                    'Horario Turno': r.horarioTurno || '',
                    'Origen': obtenerOrigenRegistro(r),
                    'Notas': (r.notas || []).map(n => `${formatDateTimeForDisplay(new Date(n.fecha))}: ${n.texto}`).join('; ')
                };
            });
            
            // Crear hoja de cálculo
            const ws = XLSX.utils.json_to_sheet(datosFormateados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Atenciones');
            
            // Generar nombre de archivo
            const fecha = new Date().toISOString().split('T')[0];
            const nombreArchivo = `Atenciones_Defensoria_${fecha}.xlsx`;
            
            // Descargar archivo
            XLSX.writeFile(wb, nombreArchivo);
            
            // Cerrar menú
            menuExportar.classList.add('hidden');
        }
        
        /**
         * Exporta datos de Atenciones a PDF
         */
        function exportarPDF() {
            let datosExportar = [];
            
            if (vistaActual === 'atenciones') {
                datosExportar = rawData.filter(r => {
                    if (esConsultaWeb(r)) return false;
                    
                    const coincideBusqueda = !filtroBusqueda || 
                        (r.personName && r.personName.toLowerCase().includes(filtroBusqueda)) || 
                        (r.dni && r.dni.includes(filtroBusqueda)) || 
                        (r.telefono && r.telefono.includes(filtroBusqueda));
                    
                    const coincideDefensor = !filtroDefensor || r.assignedUser === filtroDefensor;
                    
                    let coincideFecha = true;
                    if (filtroFechaInicio || filtroFechaFin) {
                        if (r.timestamp) {
                            const fechaRegistro = normalizeDate(new Date(r.timestamp));
                            const fechaInicio = filtroFechaInicio ? parseLocalDate(filtroFechaInicio) : null;
                            const fechaFin = filtroFechaFin ? parseLocalDate(filtroFechaFin) : null;
                            
                            if (fechaInicio && fechaRegistro < fechaInicio) coincideFecha = false;
                            if (fechaFin && fechaRegistro > fechaFin) coincideFecha = false;
                        } else {
                            coincideFecha = false;
                        }
                    }
                    
                    return coincideBusqueda && coincideDefensor && coincideFecha;
                });
            }
            
            if (datosExportar.length === 0) {
                mostrarAlertaSincronizacion(false, 'No hay datos para exportar con los filtros actuales');
                return;
            }
            
            // Usar jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Encabezado
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 128);
            doc.text('Defensoría Civil y Comercial 6', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('Reporte de Atenciones', 105, 22, { align: 'center' });
            doc.text(`Generado: ${formatDateTimeForDisplay(new Date())}`, 105, 28, { align: 'center' });
            
            // Información de filtros
            let infoFiltros = 'Todos los registros';
            if (filtroBusqueda || filtroFechaInicio || filtroFechaFin || filtroDefensor) {
                infoFiltros = 'Filtros aplicados: ';
                const filtros = [];
                if (filtroBusqueda) filtros.push(`Búsqueda: "${filtroBusqueda}"`);
                if (filtroFechaInicio) filtros.push(`Desde: ${filtroFechaInicio}`);
                if (filtroFechaFin) filtros.push(`Hasta: ${filtroFechaFin}`);
                if (filtroDefensor) filtros.push(`Usuario asignado: ${filtroDefensor}`);
                infoFiltros += filtros.join(', ');
            }
            
            doc.setFontSize(10);
            doc.text(infoFiltros, 105, 35, { align: 'center' });
            
            // Preparar datos para la tabla
            const datosTabla = datosExportar.map(r => [
                r.timestamp ? formatShortDateForDisplay(new Date(r.timestamp)) : '',
                r.personName?.substring(0, 20) || '',
                r.dni || '',
                (r.type || '').substring(0, 15),
                r.assignedUser?.substring(0, 15) || '',
                r.responsable?.substring(0, 15) || '', // Nuevo campo
                r.estado || ''
            ]);
            
            // Crear tabla
            doc.autoTable({
                head: [['Fecha', 'Nombre', 'DNI', 'Tipo', 'Usuario asignado', 'Responsable', 'Estado']],
                body: datosTabla,
                startY: 45,
                margin: { left: 10, right: 10 },
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [59, 130, 246], textColor: 255 },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 30 },
                    4: { cellWidth: 35 },
                    5: { cellWidth: 35 },
                    6: { cellWidth: 20 }
                }
            });
            
            // Pie de página
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Página ${i} de ${pageCount} - ${datosExportar.length} registros`, 105, 285, { align: 'center' });
                doc.text('Documento oficial - Defensoría Civil y Comercial 6 - Ministerio Público', 105, 290, { align: 'center' });
            }
            
            // Generar nombre de archivo
            const fecha = new Date().toISOString().split('T')[0];
            const nombreArchivo = `Reporte_Atenciones_${fecha}.pdf`;
            
            // Descargar PDF
            doc.save(nombreArchivo);
            
            // Cerrar menú
            menuExportar.classList.add('hidden');
        }
        
        /**
         * Exporta datos de Turnos Web a Excel
         */
        function exportarExcelTurnosWeb() {
            let datosExportar = rawData.filter(r => esConsultaWeb(r));
            
            // Aplicar filtros de búsqueda de turnos web
            const filtrados = datosExportar.filter(r => {
                const coincideBusqueda = !filtroBusquedaTurnos || 
                    (r.personName && r.personName.toLowerCase().includes(filtroBusquedaTurnos)) || 
                    (r.dni && r.dni.includes(filtroBusquedaTurnos)) || 
                    (r.telefono && r.telefono.includes(filtroBusquedaTurnos));
                return coincideBusqueda;
            });
            
            if (filtrados.length === 0) {
                mostrarAlertaSincronizacion(false, 'No hay datos para exportar con los filtros actuales');
                return;
            }
            
            // Preparar datos para Excel
            const datosFormateados = filtrados.map(r => {
                return {
                    'Fecha Registro': r.timestamp ? formatDateTimeForDisplay(new Date(r.timestamp)) : '',
                    'Nombre Ciudadano': r.personName || '',
                    'DNI': r.dni || '',
                    'Teléfono': r.telefono || '',
                    'Tipo Consulta': r.type || '',
                    'Descripción': r.description || '',
                    'Usuario asignado': r.assignedUser || '',
                    'Responsable que asigna': r.responsable || '', // Nuevo campo
                    'Estado': r.estado || 'pendiente',
                    'Fecha Turno': r.fechaTurno ? formatShortDateForDisplay(r.fechaTurno) : '',
                    'Horario Turno': r.horarioTurno || '',
                    'Origen': obtenerOrigenRegistro(r),
                    'Notas': (r.notas || []).map(n => `${formatDateTimeForDisplay(new Date(n.fecha))}: ${n.texto}`).join('; ')
                };
            });
            
            // Crear hoja de cálculo
            const ws = XLSX.utils.json_to_sheet(datosFormateados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Turnos Web');
            
            // Generar nombre de archivo
            const fecha = new Date().toISOString().split('T')[0];
            const nombreArchivo = `Turnos_Web_${fecha}.xlsx`;
            
            // Descargar archivo
            XLSX.writeFile(wb, nombreArchivo);
            
            // Cerrar menú
            document.getElementById('menu-exportar-turnos').classList.add('hidden');
        }
        
        /**
         * Exporta datos de Turnos Web a PDF
         */
        function exportarPDFTurnosWeb() {
            let datosExportar = rawData.filter(r => esConsultaWeb(r));
            
            // Aplicar filtros de búsqueda de turnos web
            const filtrados = datosExportar.filter(r => {
                const coincideBusqueda = !filtroBusquedaTurnos || 
                    (r.personName && r.personName.toLowerCase().includes(filtroBusquedaTurnos)) || 
                    (r.dni && r.dni.includes(filtroBusquedaTurnos)) || 
                    (r.telefono && r.telefono.includes(filtroBusquedaTurnos));
                return coincideBusqueda;
            });
            
            if (filtrados.length === 0) {
                mostrarAlertaSincronizacion(false, 'No hay datos para exportar con los filtros actuales');
                return;
            }
            
            // Usar jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Encabezado
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 128);
            doc.text('Defensoría Civil y Comercial 6', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('Reporte de Turnos Web', 105, 22, { align: 'center' });
            doc.text(`Generado: ${formatDateTimeForDisplay(new Date())}`, 105, 28, { align: 'center' });
            
            // Información de filtros
            let infoFiltros = 'Todos los registros';
            if (filtroBusquedaTurnos) {
                infoFiltros = `Filtro aplicado: Búsqueda: "${filtroBusquedaTurnos}"`;
            }
            
            doc.setFontSize(10);
            doc.text(infoFiltros, 105, 35, { align: 'center' });
            
            // Preparar datos para la tabla
            const datosTabla = filtrados.map(r => [
                r.fechaTurno ? formatShortDateForDisplay(r.fechaTurno) : '',
                r.horarioTurno || '',
                r.personName?.substring(0, 20) || '',
                r.dni || '',
                r.telefono || '',
                (r.type || '').substring(0, 15),
                r.assignedUser?.substring(0, 15) || '',
                r.responsable?.substring(0, 15) || '', // Nuevo campo
                r.estado || ''
            ]);
            
            // Crear tabla
            doc.autoTable({
                head: [['Fecha Turno', 'Horario', 'Nombre', 'DNI', 'Teléfono', 'Tipo', 'Usuario asignado', 'Responsable', 'Estado']],
                body: datosTabla,
                startY: 45,
                margin: { left: 10, right: 10 },
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [59, 130, 246], textColor: 255 },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 15 },
                    2: { cellWidth: 30 },
                    3: { cellWidth: 20 },
                    4: { cellWidth: 20 },
                    5: { cellWidth: 25 },
                    6: { cellWidth: 25 },
                    7: { cellWidth: 25 },
                    8: { cellWidth: 15 }
                }
            });
            
            // Pie de página
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Página ${i} de ${pageCount} - ${filtrados.length} registros`, 105, 285, { align: 'center' });
                doc.text('Documento oficial - Defensoría Civil y Comercial 6 - Ministerio Público', 105, 290, { align: 'center' });
            }
            
            // Generar nombre de archivo
            const fecha = new Date().toISOString().split('T')[0];
            const nombreArchivo = `Reporte_Turnos_Web_${fecha}.pdf`;
            
            // Descargar PDF
            doc.save(nombreArchivo);
            
            // Cerrar menú
            document.getElementById('menu-exportar-turnos').classList.add('hidden');
        }
        
        /**
         * Exporta datos de Calendario a Excel
         */
        function exportarExcelCalendario() {
            let datosExportar = rawData.filter(r => esConsultaWeb(r) && r.fechaTurno);
            
            // Aplicar filtros de calendario
            const filtrados = datosExportar.filter(r => {
                const coincideBusqueda = !filtroBusquedaCalendario || 
                    (r.personName && r.personName.toLowerCase().includes(filtroBusquedaCalendario)) || 
                    (r.dni && r.dni.includes(filtroBusquedaCalendario)) || 
                    (r.telefono && r.telefono.includes(filtroBusquedaCalendario));
                
                const coincideDefensor = !filtroDefensorCalendario || r.assignedUser === filtroDefensorCalendario;
                
                let coincideFecha = true;
                if (filtroFechaInicioCalendario || filtroFechaFinCalendario) {
                    if (r.fechaTurno) {
                        const fechaTurno = parseLocalDate(r.fechaTurno);
                        if (!fechaTurno) return false;
                        
                        const fechaInicio = filtroFechaInicioCalendario ? parseLocalDate(filtroFechaInicioCalendario) : null;
                        const fechaFin = filtroFechaFinCalendario ? parseLocalDate(filtroFechaFinCalendario) : null;
                        
                        if (fechaInicio && fechaTurno < fechaInicio) coincideFecha = false;
                        if (fechaFin && fechaTurno > fechaFin) coincideFecha = false;
                    } else {
                        coincideFecha = false;
                    }
                }
                
                return coincideBusqueda && coincideDefensor && coincideFecha;
            });
            
            if (filtrados.length === 0) {
                mostrarAlertaSincronizacion(false, 'No hay datos para exportar con los filtros actuales');
                return;
            }
            
            // Preparar datos para Excel
            const datosFormateados = filtrados.map(r => {
                return {
                    'Fecha Turno': r.fechaTurno ? formatShortDateForDisplay(r.fechaTurno) : '',
                    'Horario Turno': r.horarioTurno || '',
                    'Nombre Ciudadano': r.personName || '',
                    'DNI': r.dni || '',
                    'Teléfono': r.telefono || '',
                    'Tipo Consulta': r.type || '',
                    'Usuario asignado': r.assignedUser || '',
                    'Responsable que asigna': r.responsable || '', // Nuevo campo
                    'Estado': r.estado || 'pendiente',
                    'Fecha Registro': r.timestamp ? formatDateTimeForDisplay(new Date(r.timestamp)) : '',
                    'Descripción': r.description || '',
                    'Notas': (r.notas || []).map(n => `${formatDateTimeForDisplay(new Date(n.fecha))}: ${n.texto}`).join('; ')
                };
            });
            
            // Crear hoja de cálculo
            const ws = XLSX.utils.json_to_sheet(datosFormateados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Calendario');
            
            // Generar nombre de archivo
            const fecha = new Date().toISOString().split('T')[0];
            const nombreArchivo = `Calendario_Turnos_${fecha}.xlsx`;
            
            // Descargar archivo
            XLSX.writeFile(wb, nombreArchivo);
            
            // Cerrar menú
            document.getElementById('menu-exportar-calendario').classList.add('hidden');
        }
        
        /**
         * Exporta datos de Calendario a PDF
         */
        function exportarPDFCalendario() {
            let datosExportar = rawData.filter(r => esConsultaWeb(r) && r.fechaTurno);
            
            // Aplicar filtros de calendario
            const filtrados = datosExportar.filter(r => {
                const coincideBusqueda = !filtroBusquedaCalendario || 
                    (r.personName && r.personName.toLowerCase().includes(filtroBusquedaCalendario)) || 
                    (r.dni && r.dni.includes(filtroBusquedaCalendario)) || 
                    (r.telefono && r.telefono.includes(filtroBusquedaCalendario));
                
                const coincideDefensor = !filtroDefensorCalendario || r.assignedUser === filtroDefensorCalendario;
                
                let coincideFecha = true;
                if (filtroFechaInicioCalendario || filtroFechaFinCalendario) {
                    if (r.fechaTurno) {
                        const fechaTurno = parseLocalDate(r.fechaTurno);
                        if (!fechaTurno) return false;
                        
                        const fechaInicio = filtroFechaInicioCalendario ? parseLocalDate(filtroFechaInicioCalendario) : null;
                        const fechaFin = filtroFechaFinCalendario ? parseLocalDate(filtroFechaFinCalendario) : null;
                        
                        if (fechaInicio && fechaTurno < fechaInicio) coincideFecha = false;
                        if (fechaFin && fechaTurno > fechaFin) coincideFecha = false;
                    } else {
                        coincideFecha = false;
                    }
                }
                
                return coincideBusqueda && coincideDefensor && coincideFecha;
            });
            
            if (filtrados.length === 0) {
                mostrarAlertaSincronizacion(false, 'No hay datos para exportar con los filtros actuales');
                return;
            }
            
            // Usar jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Encabezado
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 128);
            doc.text('Defensoría Civil y Comercial 6', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('Calendario de Turnos Web', 105, 22, { align: 'center' });
            doc.text(`Generado: ${formatDateTimeForDisplay(new Date())}`, 105, 28, { align: 'center' });
            
            // Información de filtros
            let infoFiltros = 'Todos los registros';
            const filtros = [];
            if (filtroBusquedaCalendario) filtros.push(`Búsqueda: "${filtroBusquedaCalendario}"`);
            if (filtroFechaInicioCalendario) filtros.push(`Desde: ${filtroFechaInicioCalendario}`);
            if (filtroFechaFinCalendario) filtros.push(`Hasta: ${filtroFechaFinCalendario}`);
            if (filtroDefensorCalendario) filtros.push(`Usuario asignado: ${filtroDefensorCalendario}`);
            
            if (filtros.length > 0) {
                infoFiltros = 'Filtros aplicados: ' + filtros.join(', ');
            }
            
            doc.setFontSize(10);
            doc.text(infoFiltros, 105, 35, { align: 'center' });
            
            // Preparar datos para la tabla
            const datosTabla = filtrados.map(r => [
                r.fechaTurno ? formatShortDateForDisplay(r.fechaTurno) : '',
                r.horarioTurno || '',
                r.personName?.substring(0, 20) || '',
                r.dni || '',
                r.telefono || '',
                (r.type || '').substring(0, 15),
                r.assignedUser?.substring(0, 15) || '',
                r.responsable?.substring(0, 15) || '', // Nuevo campo
                r.estado || ''
            ]);
            
            // Crear tabla
            doc.autoTable({
                head: [['Fecha Turno', 'Horario', 'Nombre', 'DNI', 'Teléfono', 'Tipo', 'Usuario asignado', 'Responsable', 'Estado']],
                body: datosTabla,
                startY: 45,
                margin: { left: 10, right: 10 },
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [59, 130, 246], textColor: 255 },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 15 },
                    2: { cellWidth: 30 },
                    3: { cellWidth: 20 },
                    4: { cellWidth: 20 },
                    5: { cellWidth: 25 },
                    6: { cellWidth: 25 },
                    7: { cellWidth: 25 },
                    8: { cellWidth: 15 }
                }
            });
            
            // Pie de página
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Página ${i} de ${pageCount} - ${filtrados.length} registros`, 105, 285, { align: 'center' });
                doc.text('Documento oficial - Defensoría Civil y Comercial 6 - Ministerio Público', 105, 290, { align: 'center' });
            }
            
            // Generar nombre de archivo
            const fecha = new Date().toISOString().split('T')[0];
            const nombreArchivo = `Calendario_Turnos_${fecha}.pdf`;
            
            // Descargar PDF
            doc.save(nombreArchivo);
            
            // Cerrar menú
            document.getElementById('menu-exportar-calendario').classList.add('hidden');
        }
        
        // ========== INICIALIZACIÓN ==========
        
        // Inicializar aplicación
        cargarConfiguracionAgenda();
        inicializarCalendario();
        render();
        cambiarVista('dashboard');
        
        // Actualizar gráficos después de un breve retraso
        setTimeout(actualizarGraficos, 1000);
    </script>
</body>
</html>
