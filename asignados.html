<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Casos Asignados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* ---------------------------------------------------- */
        /* ESTILOS GENERALES Y MODALES                          */
        /* ---------------------------------------------------- */
        
        .modal-feriado-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(5px); z-index: 99999; display: flex;
            align-items: center; justify-content: center; padding: 1rem;
            animation: fadeInOverlay 0.3s ease-out;
        }

        .modal-feriado {
            background: white; width: 100%; max-width: 480px;
            border-radius: 16px; border: 1px solid #fecaca;
            box-shadow: 0 20px 25px -5px rgba(220, 38, 38, 0.15);
            animation: floatUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-feriado-header {
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
            color: white; padding: 20px 24px; display: flex;
            align-items: center; justify-content: space-between;
        }

        .modal-feriado-header h3 { font-size: 1.25rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 12px; }
        .modal-feriado-body { padding: 32px 24px; text-align: center; background: #fff; }
        .modal-feriado-footer { padding: 16px 24px; background: #fef2f2; border-top: 1px solid #fee2e2; text-align: center; }
        
        .login-container { min-height: 100vh; background: white; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); width: 100%; max-width: 420px; overflow: hidden; }
        .login-header { background: linear-gradient(to right, #1e3a8a, #3b82f6); color: white; padding: 25px 30px; text-align: center; }
        .login-body { padding: 35px 30px; }
        
        .login-input { width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s; }
        .login-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none; }
        
        .login-btn { width: 100%; background: linear-gradient(to right, #1e3a8a, #3b82f6); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3); }

        .estado-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; display: inline-block; }
        .estado-pendiente { background: #fef3c7; color: #92400e; }
        .estado-proceso { background: #dbeafe; color: #1e40af; }
        .estado-resuelto { background: #d1fae5; color: #065f46; }
        .estado-derivado { background: #f3e8ff; color: #5b21b6; }
        .respuesta-pendiente { background: #fee2e2; color: #dc2626; }
        .respuesta-enviada { background: #d1fae5; color: #065f46; }

        .hidden { display: none !important; }
        .pulse-new { animation: pulseNew 2s infinite; }
        @keyframes pulseNew { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        @keyframes floatUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }
        
        /* Modales */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal:not(.hidden) { display: flex !important; }
        
        /* Estilos Calendario (Importados de Interno) */
        .calendar-day { cursor: pointer; }
        .calendar-day:hover { background-color: #e6f7ff; }
        .calendar-day.selected { background-color: #3b82f6; color: white; }
        .calendar-day.disabled { color: #d1d5db; cursor: not-allowed; }
        
        /* Tiempo Transcurrido Estilos */
        .tiempo-transcurrido { padding: 12px; border-radius: 10px; font-weight: bold; text-align: center; transition: all 0.3s; margin-bottom: 20px; }
        .tiempo-normal { background-color: #dbeafe; color: #1e40af; border: 2px solid #93c5fd; }
        .tiempo-medio { background-color: #fef3c7; color: #92400e; border: 2px solid #fbbf24; }
        .tiempo-alto { background-color: #fee2e2; color: #991b1b; border: 2px solid #fca5a5; }
        
        /* Historial */
        .historial-item { border-left: 3px solid #3b82f6; padding-left: 12px; margin-bottom: 12px; }
        .historial-item.resuelto { border-left-color: #10b981; }
        .historial-item.derivado { border-left-color: #8b5cf6; }

        /* Plantillas Rápidas */
        .plantilla-rapida { cursor: pointer; transition: all 0.2s; }
        .plantilla-rapida:hover { transform: translateY(-1px); }

        /* Paginación */
        .pagination-container { display: flex; flex-direction: column; align-items: center; padding: 1rem; border-top: 1px solid #e5e7eb; background-color: #f9fafb; }
        .pagination-controls { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .pagination-btn { padding: 0.375rem 0.75rem; border: 1px solid #d1d5db; background: white; border-radius: 0.375rem; cursor: pointer; }
        .pagination-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        @media (max-width: 768px) { .table-responsive { overflow-x: auto; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <div id="system-unavailable-overlay" class="modal-feriado-overlay hidden">
        <div class="modal-feriado">
            <div class="modal-feriado-header">
                <h3><i class="fas fa-calendar-times"></i> Atención: Día Inhábil</h3>
                <button id="modal-feriado-close" class="text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-feriado-body"><p id="system-unavailable-message"></p></div>
            <div class="modal-feriado-footer"><p><i class="fas fa-lock"></i> Función no disponible.</p></div>
        </div>
    </div>

    <div id="notification-temp-container" class="fixed top-4 right-4 z-40 space-y-2"></div>

    <section id="login-section" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1 class="text-2xl font-bold text-white">Consultas y Turnos</h1>
                <p class="text-white text-opacity-90 mt-2">Acceso Personal</p>
            </div>
            <div class="login-body">
                <form id="login-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-user mr-2"></i>Usuario</label>
                        <input type="text" id="login-input" class="login-input" placeholder="Nombre Apellido" required list="usuarios-lista">
                        <datalist id="usuarios-lista">
                            <option value="Bazante Nadia Romina">
                            <option value="Boillat Cesar Enrique">
                            <option value="Cardozo Maria Raquel">
                            <option value="Cedron Noelia Aurora">
                            <option value="Corrales Alicia Mariela">
                            <option value="Escobar Monica Graciela">
                            <option value="Fioravante Romulo">
                            <option value="Gonzalez Alberto Misael">
                            <option value="Gonzalez Juan Jose">
                            <option value="Gudiño Natalia Esther">
                            <option value="Magnani Enzo Luciano">
                            <option value="Pablos Patricia">
                            <option value="Palacios Ana Gabriela">
                            <option value="Ortega Lucia Noemi">
                            <option value="Ramos Marcelo Gustavo">
                            <option value="Riveros Patricia Soledad">
                            <option value="Sosa Rita Cecilia">
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-key mr-2"></i>Clave</label>
                        <input type="password" id="login-password" class="login-input" placeholder="Tu clave" required>
                    </div>
                    <button type="submit" class="login-btn"><i class="fas fa-sign-in-alt mr-2"></i>Ingresar</button>
                </form>
            </div>
        </div>
    </section>
    
    <section id="dashboard-section" class="hidden min-h-screen">
        <header class="bg-white shadow-sm border-b sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center mr-3"><i class="fas fa-user-shield text-white"></i></div>
                        <div>
                            <h1 class="text-lg font-bold text-gray-800">Mis Casos</h1>
                            <span id="user-name-display" class="text-sm font-bold text-blue-700"></span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                         <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-lg"><span class="font-bold" id="contador-pendientes">0</span> pend.</div>
                         <button class="btn-salir bg-red-100 text-red-700 px-3 py-1 rounded text-sm"><i class="fas fa-power-off"></i></button>
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button id="btn-ver-casos" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition-all-smooth"><i class="fas fa-list mr-2"></i>Lista</button>
                    <button id="btn-ver-calendario" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all-smooth"><i class="fas fa-calendar-day mr-2"></i>Calendario</button>
                </div>
            </div>
        </header>
        
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 flex flex-wrap gap-3">
                <button id="btn-nueva-consulta" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700"><i class="fas fa-plus-circle mr-2"></i>Nueva Consulta-Turno</button>
                <button id="btn-marcar-resuelto" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 disabled:opacity-50" disabled><i class="fas fa-check-circle mr-2"></i>Resolver</button>
                <button id="btn-actualizar-consulta" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 disabled:opacity-50" disabled><i class="fas fa-edit mr-2"></i>Detalles Completos</button>
                <button id="btn-derivar-caso" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700 disabled:opacity-50" disabled><i class="fas fa-share-alt mr-2"></i>Derivar</button>
            </div>
            
            <div class="mb-4 relative">
                <input type="text" id="input-busqueda" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg outline-none" placeholder="Buscar...">
                <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                <button id="btn-limpiar-busqueda" class="absolute right-3 top-3.5 text-gray-400 hidden"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="bg-white rounded-xl shadow overflow-hidden mb-8">
                <div class="px-6 py-4 border-b flex justify-between">
                    <h2 class="text-lg font-bold text-gray-800">Listado de Casos</h2>
                    <button id="btn-exportar-pdf" class="text-red-600 text-sm hover:text-red-800 font-bold"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                </div>
                <div class="overflow-x-auto table-responsive">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ciudadano</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descripción</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Respuesta</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="casos-body" class="divide-y divide-gray-200"></tbody>
                    </table>
                    
                    <div id="pagination-container" class="pagination-container hidden">
                        <div class="pagination-info text-sm text-gray-500 mb-2">
                            <span id="pagination-start">0</span>-<span id="pagination-end">0</span> de <span id="pagination-total">0</span>
                        </div>
                        <div class="pagination-controls">
                            <button id="pagination-first" class="pagination-btn"><i class="fas fa-angle-double-left"></i></button>
                            <button id="pagination-prev" class="pagination-btn"><i class="fas fa-angle-left"></i></button>
                            <span id="pagination-numbers" class="flex gap-1"></span>
                            <button id="pagination-next" class="pagination-btn"><i class="fas fa-angle-right"></i></button>
                            <button id="pagination-last" class="pagination-btn"><i class="fas fa-angle-double-right"></i></button>
                        </div>
                    </div>

                    <div id="tabla-vacia" class="hidden p-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-4"></i><p>No tienes casos asignados.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <section id="calendario-section" class="hidden min-h-screen">
        <header class="bg-white shadow-sm border-b sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center mr-3"><i class="fas fa-calendar-alt text-white"></i></div>
                    <h1 class="text-lg font-bold text-gray-800">Mi Calendario</h1>
                </div>
                <button class="btn-salir bg-red-100 text-red-700 px-3 py-1 rounded text-sm"><i class="fas fa-power-off"></i></button>
            </div>
            <div class="px-4 pb-3 max-w-7xl mx-auto">
                <button id="btn-ver-casos-cal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm mr-2"><i class="fas fa-list mr-2"></i>Lista</button>
                <button id="btn-ver-calendario-cal" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm"><i class="fas fa-calendar-day mr-2"></i>Calendario</button>
            </div>
        </header>
        <div class="max-w-7xl mx-auto px-4 py-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Turnos de Hoy</h2>
            <div id="calendario-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
        </div>
    </section>

    <div id="modal-registro" class="modal hidden">
        <div class="bg-white rounded-xl w-full max-w-2xl mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
            <div class="bg-blue-800 text-white p-4 flex justify-between items-center font-bold sticky top-0 z-10">
                <span class="text-sm sm:text-base">Registrar Nueva Atención</span>
                <button id="btn-cerrar-modal" class="text-2xl leading-none">&times;</button>
            </div>
            <form id="form-interno" class="p-4 sm:p-6 space-y-4 sm:space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 modal-content-grid">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Nombre Completo *</label>
                        <input type="text" id="m-name" placeholder="Ej: Juan Pérez" required 
                               class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">DNI</label>
                        <input type="text" id="m-dni" placeholder="Ej: 12345678" maxlength="8" pattern="\d*"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                               class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Teléfono/WhatsApp</label>
                        <input type="text" id="m-telefono" placeholder="Ej: 3764123456" maxlength="10" pattern="\d*"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                               class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Tipo de Consulta *</label>
                        <select id="m-type" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                            <option value="Presencial">Presencial</option>
                            <option value="Telefónica">Telefónica</option>
                            <option value="WhatsApp">WhatsApp</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Descripción</label>
                    <textarea id="m-desc" placeholder="Detalles de la consulta..." 
                              class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none h-20 sm:h-24 text-sm"></textarea>
                </div>
                
                <div class="border-t pt-4">
                    <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-3"><i class="fas fa-calendar-alt mr-2"></i>Asignar Turno (Opcional)</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Seleccione Fecha</label>
                            <div class="bg-gray-50 p-3 sm:p-4 rounded-lg border">
                                <div class="flex justify-between items-center mb-3 sm:mb-4">
                                    <button type="button" id="prev-month" class="p-2 hover:bg-gray-200 rounded">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <h4 id="current-month" class="font-bold text-gray-800 text-sm sm:text-base">Diciembre 2024</h4>
                                    <button type="button" id="next-month" class="p-2 hover:bg-gray-200 rounded">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <div class="grid grid-cols-7 gap-1 mb-2">
                                    <div class="text-center text-xs font-bold text-gray-500">Lun</div>
                                    <div class="text-center text-xs font-bold text-gray-500">Mar</div>
                                    <div class="text-center text-xs font-bold text-gray-500">Mié</div>
                                    <div class="text-center text-xs font-bold text-gray-500">Jue</div>
                                    <div class="text-center text-xs font-bold text-gray-500">Vie</div>
                                    <div class="text-center text-xs font-bold text-gray-500">Sáb</div>
                                    <div class="text-center text-xs font-bold text-gray-500">Dom</div>
                                </div>
                                <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                            </div>
                            <input type="hidden" id="m-fecha-turno" value="">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Horarios Disponibles</label>
                            <div class="bg-gray-50 p-3 sm:p-4 rounded-lg border h-full">
                                <div id="horarios-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                    </div>
                                <div class="mt-4">
                                    <p id="info-capacidad" class="text-xs text-gray-600 mb-2">Cada horario tiene capacidad para 2 turnos simultáneos</p>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Horario Personalizado</label>
                                    <div class="flex gap-2">
                                        <input type="time" id="m-hora-personalizada" 
                                               class="flex-1 border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                               min="07:00" max="11:30">
                                        <button type="button" id="btn-usar-hora-personalizada" 
                                                class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 whitespace-nowrap transition">
                                            Usar
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="m-horario-turno" value="">
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <p id="turno-seleccionado" class="text-sm text-gray-700">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            <span id="turno-texto">No se ha asignado turno</span>
                        </p>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Usuario asignado</label>
                    <input type="text" id="m-user" class="w-full border p-2 rounded bg-gray-100 text-sm" readonly>
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition text-sm sm:text-base">
                    <i class="fas fa-save mr-2"></i> Guardar en Sistema
                </button>
            </form>
        </div>
    </div>

    <div id="modal-respuesta-cliente" class="modal hidden">
        <div class="bg-white rounded-xl w-full max-w-4xl mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
            <div class="bg-blue-800 text-white p-4 flex justify-between items-center font-bold sticky top-0 z-10">
                <span class="text-sm sm:text-base"><i class="fas fa-reply mr-2"></i>Respuesta al Cliente</span>
                <button id="btn-cerrar-respuesta-cliente" class="text-2xl leading-none">&times;</button>
            </div>
            
            <div class="p-4 sm:p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                            <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-user-circle mr-2 text-blue-600"></i>
                                Información del Cliente
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Nombre Completo</label>
                                    <p id="resp-nombre" class="p-3 bg-white rounded border text-sm font-medium"></p>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">DNI</label>
                                        <p id="resp-dni" class="p-3 bg-white rounded border text-sm"></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Teléfono</label>
                                        <p id="resp-telefono" class="p-3 bg-white rounded border text-sm"></p>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                                    <p id="resp-email" class="p-3 bg-white rounded border text-sm">-</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Descripción Inicial</label>
                                    <p id="resp-descripcion" class="p-3 bg-white rounded border text-sm h-24 overflow-y-auto"></p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="contador-tiempo" class="tiempo-transcurrido tiempo-normal">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-clock text-2xl mr-3"></i>
                                <div>
                                    <p class="text-sm font-semibold">Tiempo Transcurrido</p>
                                    <p id="tiempo-texto" class="text-2xl font-bold">0 días, 0 horas</p>
                                </div>
                            </div>
                            <p id="tiempo-detalle" class="text-xs">Desde el registro del caso</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                            <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-comment-dots mr-2 text-green-600"></i>
                                Enviar Respuesta
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Asunto</label>
                                    <select id="resp-asunto" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                                        <option value="confirmacion_turno">Confirmación de Turno</option>
                                        <option value="informacion_adicional">Información Adicional Solicitada</option>
                                        <option value="resolucion_caso">Resolución del Caso</option>
                                        <option value="derivacion">Derivación a Otro Área</option>
                                        <option value="otros">Otros</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Mensaje Personalizado</label>
                                    <textarea id="resp-mensaje" rows="6" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Escriba aquí el mensaje para el cliente..."></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Canal de Envío</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <button id="btn-enviar-whatsapp" class="p-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition flex items-center justify-center">
                                            <i class="fab fa-whatsapp mr-2 text-xl"></i> WhatsApp
                                        </button>
                                        <button id="btn-enviar-email" class="p-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center">
                                            <i class="fas fa-envelope mr-2 text-xl"></i> Correo
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <div class="flex items-start">
                                        <i class="fas fa-lightbulb text-yellow-500 mt-1 mr-3"></i>
                                        <div>
                                            <p class="text-sm font-semibold text-gray-800">Plantillas Rápidas</p>
                                            <div class="flex flex-wrap gap-2 mt-2">
                                                <button class="plantilla-rapida text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 transition" data-plantilla="confirmacion">
                                                    Confirmar turno
                                                </button>
                                                <button class="plantilla-rapida text-xs bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200 transition" data-plantilla="informacion">
                                                    Solicitar información
                                                </button>
                                                <button class="plantilla-rapida text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded hover:bg-purple-200 transition" data-plantilla="resolucion">
                                                    Caso resuelto
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                            <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-history mr-2 text-gray-600"></i>
                                Historial de Comunicaciones
                            </h3>
                            <div id="historial-respuestas" class="space-y-3 max-h-60 overflow-y-auto text-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-detalle" class="modal hidden">
        <div class="bg-white rounded-xl w-full max-w-2xl mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
            <div class="bg-blue-800 text-white p-4 flex justify-between items-center font-bold sticky top-0 z-10">
                <span class="text-sm sm:text-base"><i class="fas fa-eye mr-2"></i>Detalles Completos de la Consulta</span>
                <button id="btn-cerrar-detalle" class="text-2xl leading-none">&times;</button>
            </div>
            <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Ciudadano</label>
                        <p id="detalle-nombre" class="p-2 bg-gray-50 rounded text-sm font-medium"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">DNI</label>
                        <p id="detalle-dni" class="p-2 bg-gray-50 rounded text-sm"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Teléfono</label>
                        <p id="detalle-telefono" class="p-2 bg-gray-50 rounded text-sm flex items-center justify-between">
                            <span id="detalle-telefono-texto"></span>
                            <button id="btn-whatsapp-detalle" class="text-green-600 hover:text-green-800 ml-2">
                                <i class="fab fa-whatsapp text-lg"></i>
                            </button>
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Tipo de Consulta</label>
                        <p id="detalle-tipo" class="p-2 bg-gray-50 rounded text-sm font-bold text-blue-600"></p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Descripción Inicial</label>
                    <p id="detalle-descripcion" class="p-2 bg-gray-50 rounded min-h-20 text-sm"></p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Fecha Registro</label>
                        <p id="detalle-fecha" class="p-2 bg-gray-50 rounded text-sm"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Turno Asignado</label>
                        <p id="detalle-turno" class="p-2 bg-gray-50 rounded text-sm"></p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Estado Actual</label>
                        <p id="detalle-estado" class="p-2 bg-gray-50 rounded text-sm">
                            <span id="detalle-estado-texto" class="px-2 py-1 rounded-full text-[10px] font-bold"></span>
                        </p>
                    </div>
                </div>
                
                <div class="pt-4 border-t">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-semibold text-gray-700">Historial de Observaciones</label>
                        <span class="text-xs text-gray-500" id="contador-notas">0 observaciones</span>
                    </div>
                    <div id="detalle-observaciones" class="mb-4 max-h-48 overflow-y-auto p-3 bg-gray-50 rounded">
                        </div>
                    <div class="flex gap-2">
                        <textarea id="nueva-observacion" placeholder="Añadir una nueva observación, seguimiento o avance del caso..." 
                                  class="flex-1 border p-2 rounded text-sm" rows="3"></textarea>
                        <button id="btn-guardar-actualizacion" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 self-end transition">
                            Agregar
                        </button>
                    </div>
                </div>
                
                <div class="pt-4 border-t">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Cambiar Estado</label>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button class="btn-cambio-estado bg-yellow-500 text-white px-3 sm:px-4 py-2 rounded text-sm hover:bg-yellow-600 transition" data-estado="pendiente">
                            <i class="fas fa-clock mr-1"></i> Pendiente
                        </button>
                        <button class="btn-cambio-estado bg-blue-500 text-white px-3 sm:px-4 py-2 rounded text-sm hover:bg-blue-600 transition" data-estado="en_proceso">
                            <i class="fas fa-spinner mr-1"></i> En Proceso
                        </button>
                        <button class="btn-cambio-estado bg-green-500 text-white px-3 sm:px-4 py-2 rounded text-sm hover:bg-green-600 transition" data-estado="resuelta">
                            <i class="fas fa-check mr-1"></i> Resuelta
                        </button>
                        <button class="btn-cambio-estado bg-purple-500 text-white px-3 sm:px-4 py-2 rounded text-sm hover:bg-purple-600 transition" data-estado="derivado">
                            <i class="fas fa-share mr-1"></i> Derivada
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="modal-derivar" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded p-6 max-w-md w-full">
            <h3 class="font-bold mb-4">Derivar Caso</h3>
            <select id="select-usuario-derivar" class="w-full border p-2 mb-4 rounded"></select>
            <div class="flex justify-end gap-2">
                <button id="btn-cancelar-derivar" class="px-4 py-2 bg-gray-200 rounded">Cancelar</button>
                <button id="btn-confirmar-derivar" class="px-4 py-2 bg-purple-600 text-white rounded">Derivar</button>
            </div>
        </div>
    </div>

    <div id="modal-comprobante" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded p-6 max-w-md w-full">
            <h3 class="font-bold mb-4 text-center">Comprobante Turno</h3>
            <div class="space-y-2 mb-4">
                <p><strong>Nombre:</strong> <span id="comp-nombre"></span></p>
                <p><strong>DNI:</strong> <span id="comp-dni"></span></p>
                <p><strong>Fecha:</strong> <span id="comp-fecha"></span> <span id="comp-horario"></span></p>
            </div>
            <div class="flex justify-end gap-2">
                <button id="btn-cerrar-comprobante" class="px-4 py-2 bg-gray-200 rounded">Cerrar</button>
                <button id="btn-descargar-comprobante" class="px-4 py-2 bg-red-600 text-white rounded">PDF</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, push, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDgxLS98sk6GkLrjMu3BVS2cmZ9exdh4dY",
            authDomain: "atencion-publico-def6.firebaseapp.com",
            databaseURL: "https://atencion-publico-def6-default-rtdb.firebaseio.com",
            projectId: "atencion-publico-def6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // --- CALENDARIO VARS ---
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let selectedTime = null;
        let diasInactivos = [];
        let capacidadHoraria = {};
        
        // --- HELPER FUNCTIONS ---
        function formatDateTimeForDisplay(date) {
            if (!date) return '';
            const fecha = typeof date === 'string' ? new Date(date) : date;
            return new Intl.DateTimeFormat('es-AR', {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: false
            }).format(fecha);
        }

        function formatDateForDisplay(date) {
            if (!date) return '';
            const fecha = typeof date === 'string' ? parseLocalDate(date) : date;
            return new Intl.DateTimeFormat('es-AR', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            }).format(fecha);
        }
        
        function formatShortDateForDisplay(date) {
            if (!date) return '';
            const fecha = typeof date === 'string' ? parseLocalDate(date) : date;
            return new Intl.DateTimeFormat('es-AR', {
                year: 'numeric', month: '2-digit', day: '2-digit'
            }).format(fecha);
        }

        function parseLocalDate(dateStr) {
            if (!dateStr) return null;
            const separator = dateStr.includes('-') ? '-' : '/';
            const parts = dateStr.split(separator).map(Number);
            if (parts.length !== 3) return null;
            // YYYY-MM-DD
            if (parts[0] > 31) return new Date(parts[0], parts[1] - 1, parts[2]);
            // DD/MM/YYYY
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }
        
        function formatDateLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getBadgeColor(estado) {
            const colores = {
                'resuelta': 'bg-green-100 text-green-700',
                'en_proceso': 'bg-blue-100 text-blue-700',
                'derivado': 'bg-purple-100 text-purple-700',
                'pendiente': 'bg-yellow-100 text-yellow-700'
            };
            return colores[estado] || 'bg-gray-100 text-gray-700';
        }

        function normalizarTexto(str) {
            if (!str) return "";
            return str.toString().toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }
        
        // Feriados 2026
        const feriados2026 = [
            '2026-01-01', '2026-02-16', '2026-02-17', '2026-03-24', '2026-04-02', 
            '2026-04-03', '2026-05-01', '2026-05-25', '2026-06-20', '2026-07-09', 
            '2026-12-08', '2026-12-25', '2026-06-15', '2026-08-17', '2026-10-12', 
            '2026-11-23', '2026-03-23', '2026-07-10', '2026-12-07'
        ];

        function esDiaNoLaborable() {
            const hoy = new Date();
            const diaSemana = hoy.getDay(); 
            const fechaString = hoy.toISOString().split('T')[0]; 
            if (diaSemana === 0 || diaSemana === 6) return true;
            if (feriados2026.includes(fechaString)) return true;
            return false;
        }
        
        function esFechaDeFeria(fecha) {
            if (!fecha) return false;
            const mes = fecha.getMonth() + 1;
            const dia = fecha.getDate();
            if ((mes === 12 && dia >= 26) || (mes === 1 && dia <= 31)) return true;
            if (mes === 7 && dia >= 13 && dia <= 24) return true;
            return false;
        }

        // Listas Sincronizadas
        const listaUsuarios = [
            "Bazante Nadia Romina", "Boillat Cesar Enrique", "Cardozo Maria Raquel",
            "Cedron Noelia Aurora", "Corrales Alicia Mariela", "Escobar Monica Graciela",
            "Fioravante Romulo", "Gonzalez Alberto Misael", "Gonzalez Juan Jose",
            "Gudiño Natalia Esther", "Magnani Enzo Luciano", "Pablos Patricia",
            "Palacios Ana Gabriela", "Ortega Lucia Noemi", "Ramos Marcelo Gustavo",
            "Riveros Patricia Soledad", "Sosa Rita Cecilia"
        ];

        const clavesUsuarios = {
            "Bazante Nadia Romina": "bazante123",
            "Boillat Cesar Enrique": "boillat123",
            "Cardozo Maria Raquel": "cardozo123",
            "Cedron Noelia Aurora": "cedron123",
            "Corrales Alicia Mariela": "corrales123",
            "Escobar Monica Graciela": "escobar123",
            "Fioravante Romulo": "fioravante123",
            "Gonzalez Alberto Misael": "gonzalez123",
            "Gonzalez Juan Jose": "gonzalezjj123",
            "Gudiño Natalia Esther": "gudino123",
            "Magnani Enzo Luciano": "magnani123",
            "Pablos Patricia": "pablos123",
            "Palacios Ana Gabriela": "palacios123",
            "Ortega Lucia Noemi": "ortega123",
            "Ramos Marcelo Gustavo": "ramos123",
            "Riveros Patricia Soledad": "riveros123",
            "Sosa Rita Cecilia": "sosa123"
        };

        // Estado
        let usuarioActual = null;
        let allCases = []; 
        let casosAsignados = [];
        let casoSeleccionado = null;
        let casoParaResponder = null;
        let casoParaComprobante = null;
        let intervaloContadorRespuesta = null;
        let paginaActual = 1;
        let registrosPorPagina = 10;
        let terminoBusqueda = '';

        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const calendarioSection = document.getElementById('calendario-section');
        const casosBody = document.getElementById('casos-body');
        
        // Elementos Calendario Modal
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthElement = document.getElementById('current-month');
        const horariosContainer = document.getElementById('horarios-container');
        const turnoTexto = document.getElementById('turno-texto');
        
        document.addEventListener('DOMContentLoaded', () => {
            verificarSesion();
            setupEventListeners();
            cargarConfiguracionAgenda();
        });

        function setupEventListeners() {
            document.getElementById('login-form').addEventListener('submit', manejarLogin);
            
            // Navegación
            document.querySelectorAll('.btn-salir').forEach(b => b.addEventListener('click', cerrarSesion));
            document.getElementById('btn-ver-casos').addEventListener('click', () => cambiarVista('casos'));
            document.getElementById('btn-ver-calendario').addEventListener('click', () => cambiarVista('calendario'));
            document.getElementById('btn-ver-casos-cal').addEventListener('click', () => cambiarVista('casos'));
            document.getElementById('btn-ver-calendario-cal').addEventListener('click', () => cambiarVista('calendario'));
            
            // Acciones Casos
            document.getElementById('btn-marcar-resuelto').addEventListener('click', marcarResuelto);
            document.getElementById('btn-derivar-caso').addEventListener('click', () => abrirModal('modal-derivar'));
            document.getElementById('btn-actualizar-consulta').addEventListener('click', abrirModalDetalle);
            document.getElementById('btn-nueva-consulta').addEventListener('click', abrirModalRegistro);
            
            // Modales Cancelar/Cerrar
            const closeMap = {
                'btn-cerrar-respuesta-cliente': 'modal-respuesta-cliente',
                'btn-cerrar-detalle': 'modal-detalle',
                'btn-cancelar-derivar': 'modal-derivar',
                'btn-cerrar-comprobante': 'modal-comprobante',
                'btn-cerrar-modal': 'modal-registro'
            };
            Object.keys(closeMap).forEach(id => {
                document.getElementById(id).addEventListener('click', () => {
                    const modalId = closeMap[id];
                    document.getElementById(modalId).classList.add('hidden');
                    if (modalId === 'modal-respuesta-cliente' && intervaloContadorRespuesta) {
                        clearInterval(intervaloContadorRespuesta);
                        intervaloContadorRespuesta = null;
                    }
                });
            });

            // Funciones Modales Nuevas
            document.getElementById('btn-guardar-actualizacion').addEventListener('click', agregarNota);
            
            // Botones de cambio de estado en modal detalle
            document.querySelectorAll('.btn-cambio-estado').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const estado = e.target.closest('button').dataset.estado;
                    cambiarEstadoActual(estado);
                });
            });

            document.getElementById('btn-confirmar-derivar').addEventListener('click', derivarCaso);
            document.getElementById('btn-enviar-whatsapp').addEventListener('click', enviarWhatsapp);
            document.getElementById('btn-enviar-email').addEventListener('click', enviarEmail);
            document.getElementById('form-interno').addEventListener('submit', guardarNuevaConsulta);
            document.getElementById('btn-descargar-comprobante').addEventListener('click', descargarComprobante);
            
            // Buscador
            document.getElementById('input-busqueda').addEventListener('input', (e) => {
                terminoBusqueda = normalizarTexto(e.target.value);
                paginaActual = 1;
                renderizarCasos();
            });
            document.getElementById('btn-limpiar-busqueda').addEventListener('click', () => {
                 document.getElementById('input-busqueda').value = '';
                 terminoBusqueda = '';
                 renderizarCasos();
            });

            // Paginación
            document.getElementById('pagination-prev').addEventListener('click', () => cambiarPagina(paginaActual - 1));
            document.getElementById('pagination-next').addEventListener('click', () => cambiarPagina(paginaActual + 1));
            
            // Exportar
            document.getElementById('btn-exportar-pdf').addEventListener('click', exportarPDF);
            
            // Calendario Modal Navigation
            document.getElementById('prev-month').addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) { currentMonth = 11; currentYear--; }
                renderCalendarioModal();
            });
            document.getElementById('next-month').addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                renderCalendarioModal();
            });
            
            // Hora personalizada
            document.getElementById('btn-usar-hora-personalizada').addEventListener('click', usarHoraPersonalizada);

            llenarSelectDerivar();
            inicializarPlantillasRapidas();
        }
        
        // --- CONFIGURACIÓN AGENDA ---
        async function cargarConfiguracionAgenda() {
            onValue(ref(db, "config/diasInactivos"), (snap) => {
                diasInactivos = snap.val() || [];
            });
            onValue(ref(db, "config/capacidadHoraria"), (snap) => {
                capacidadHoraria = snap.val() || {};
                if (Object.keys(capacidadHoraria).length === 0) {
                     // Default fallback logic if empty
                     for (let hour = 7; hour <= 11; hour++) {
                        for (let minute = 0; minute < 60; minute += 30) {
                            if (hour === 11 && minute > 30) break;
                            const hora = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                            capacidadHoraria[hora] = 2;
                        }
                    }
                }
            });
        }

        // --- AUTH & DATA ---
        function verificarSesion() {
            const user = localStorage.getItem('defensoriaUsuario');
            if (user) iniciarSesion(user);
        }

        function manejarLogin(e) {
            e.preventDefault();
            const inputUser = document.getElementById('login-input').value.trim();
            const inputPass = document.getElementById('login-password').value.trim();
            const userMatch = listaUsuarios.find(u => normalizarTexto(u) === normalizarTexto(inputUser));
            if (userMatch && clavesUsuarios[userMatch] === inputPass) {
                localStorage.setItem('defensoriaUsuario', userMatch);
                iniciarSesion(userMatch);
            } else {
                mostrarNotificacion('Credenciales incorrectas', 'error');
            }
        }

        function iniciarSesion(user) {
            usuarioActual = user;
            document.getElementById('user-name-display').textContent = user;
            loginSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
            cargarCasos();
        }

        function cerrarSesion() {
            localStorage.removeItem('defensoriaUsuario');
            location.reload();
        }

        function cargarCasos() {
            const casosRef = ref(db, "atencion");
            onValue(casosRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    allCases = Object.entries(data).map(([id, val]) => ({ id, ...val }))
                        .sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
                    filtrarCasosUsuario();
                } else {
                    allCases = [];
                    renderizarCasos();
                }
            });
        }

        function filtrarCasosUsuario() {
            if (!usuarioActual) return;
            const miUsuarioNorm = normalizarTexto(usuarioActual);
            casosAsignados = allCases.filter(c => {
                if (!c.assignedUser) return false;
                return normalizarTexto(c.assignedUser) === miUsuarioNorm;
            });
            // Update KPI Pendientes
            document.getElementById('contador-pendientes').textContent = 
                casosAsignados.filter(c => c.estado === 'pendiente').length;
            renderizarCasos();
            renderizarCalendario();
        }

        function renderizarCasos() {
            casosBody.innerHTML = '';
            let filtrados = casosAsignados;
            if (terminoBusqueda) {
                filtrados = casosAsignados.filter(c => 
                    normalizarTexto(c.personName).includes(terminoBusqueda) ||
                    (c.dni && c.dni.includes(terminoBusqueda)) ||
                    normalizarTexto(c.description).includes(terminoBusqueda)
                );
            }

            const total = filtrados.length;
            const totalPaginas = Math.ceil(total / registrosPorPagina);
            if (paginaActual > totalPaginas) paginaActual = 1;
            
            const start = (paginaActual - 1) * registrosPorPagina;
            const end = start + registrosPorPagina;
            const paginaData = filtrados.slice(start, end);

            document.getElementById('pagination-container').classList.toggle('hidden', total === 0);
            document.getElementById('pagination-start').textContent = total > 0 ? start + 1 : 0;
            document.getElementById('pagination-end').textContent = Math.min(end, total);
            document.getElementById('pagination-total').textContent = total;
            document.getElementById('pagination-prev').disabled = paginaActual === 1;
            document.getElementById('pagination-next').disabled = paginaActual >= totalPaginas;

            if (total === 0) {
                document.getElementById('tabla-vacia').classList.remove('hidden');
                return;
            }
            document.getElementById('tabla-vacia').classList.add('hidden');

            paginaData.forEach(caso => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 cursor-pointer transition-colors border-b";
                if(casoSeleccionado === caso.id) tr.classList.add('bg-blue-100');
                
                let badgeClass = 'estado-proceso';
                if(caso.estado === 'pendiente') badgeClass = 'estado-pendiente';
                if(caso.estado === 'resuelta') badgeClass = 'estado-resuelto';

                const tieneRespuesta = caso.notas && caso.notas.some(n => n.tipo === 'comunicacion');
                
                tr.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="font-bold text-gray-800">${caso.personName || 'Sin Nombre'}</div>
                        <div class="text-xs text-gray-500">${caso.dni || ''} - ${caso.telefono || ''}</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 truncate max-w-xs">${caso.description || caso.type}</td>
                    <td class="px-4 py-3 text-sm">${new Date(caso.timestamp).toLocaleDateString()}</td>
                    <td class="px-4 py-3"><span class="estado-badge ${badgeClass}">${caso.estado}</span></td>
                    <td class="px-4 py-3">
                        <span class="estado-badge ${tieneRespuesta ? 'respuesta-enviada' : 'respuesta-pendiente'}">
                            ${tieneRespuesta ? 'Enviada' : 'Pendiente'}
                        </span>
                    </td>
                    <td class="px-4 py-3 flex gap-2">
                        <button class="btn-select text-blue-500 hover:text-blue-700" title="Ver detalles"><i class="fas fa-eye text-lg"></i></button>
                        <button class="btn-resp text-green-500 hover:text-green-700" title="Responder"><i class="fas fa-reply text-lg"></i></button>
                        ${caso.fechaTurno ? `<button class="btn-pdf text-red-500 hover:text-red-700" title="Comprobante PDF"><i class="fas fa-file-pdf text-lg"></i></button>` : ''}
                    </td>
                `;
                
                tr.querySelector('.btn-select').addEventListener('click', (e) => { e.stopPropagation(); seleccionarCaso(caso.id); abrirModalDetalle(); });
                tr.querySelector('.btn-resp').addEventListener('click', (e) => { e.stopPropagation(); abrirModalRespuesta(caso); });
                if(tr.querySelector('.btn-pdf')) tr.querySelector('.btn-pdf').addEventListener('click', (e) => { e.stopPropagation(); verComprobante(caso); });
                tr.addEventListener('click', () => { seleccionarCaso(caso.id); });
                casosBody.appendChild(tr);
            });
        }
        
        function cambiarPagina(pag) { paginaActual = pag; renderizarCasos(); }

        function seleccionarCaso(id) {
            casoSeleccionado = id;
            document.querySelectorAll('button:disabled').forEach(b => b.disabled = false);
            renderizarCasos();
        }

        // --- MODAL NUEVA ATENCIÓN (ESTILO INTERNO) ---
        function abrirModalRegistro() {
            if (esDiaNoLaborable()) {
                mostrarNotificacion('No se pueden registrar consultas en días no laborables.', 'error');
                return;
            }
            // Set usuario asignado al actual
            document.getElementById('m-user').value = usuarioActual;
            
            // Reiniciar inputs
            document.getElementById('form-interno').reset();
            document.getElementById('m-user').value = usuarioActual;
            selectedDate = null;
            selectedTime = null;
            document.getElementById('m-fecha-turno').value = '';
            document.getElementById('m-horario-turno').value = '';
            actualizarTextoSeleccionTurno();
            renderCalendarioModal();
            actualizarHorariosDisponibles();
            
            abrirModal('modal-registro');
        }

        function renderCalendarioModal() {
            calendarGrid.innerHTML = '';
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const firstDayIndex = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
            
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                              "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            currentMonthElement.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            for (let i = 0; i < firstDayIndex; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'h-8';
                calendarGrid.appendChild(emptyDiv);
            }
            
            const today = new Date();
            today.setHours(0,0,0,0);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day h-8 flex items-center justify-center text-sm rounded';
                
                const date = new Date(currentYear, currentMonth, day);
                const dateString = formatDateLocal(date);
                const dayOfWeek = date.getDay();
                
                const isToday = date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
                const isPast = date < today && !isToday;
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isInactivo = diasInactivos.includes(dateString);
                const isSelected = selectedDate && selectedDate.getFullYear() === currentYear && selectedDate.getMonth() === currentMonth && selectedDate.getDate() === day;
                
                if (isToday) dayElement.classList.add('bg-blue-100', 'text-blue-700', 'font-bold');
                if (isSelected) dayElement.classList.add('selected');
                
                if (isPast || isWeekend || isInactivo) {
                    dayElement.classList.add('disabled', 'text-gray-300');
                    if(isInactivo) dayElement.innerHTML = `<span class="line-through">${day}</span>`;
                    else dayElement.textContent = day;
                } else {
                    dayElement.textContent = day;
                    dayElement.addEventListener('click', () => seleccionarDia(day));
                }
                calendarGrid.appendChild(dayElement);
            }
        }
        
        function seleccionarDia(day) {
            const date = new Date(currentYear, currentMonth, day);
            const dateString = formatDateLocal(date);
            
            if (diasInactivos.includes(dateString)) {
                mostrarNotificacion('Día no laborable', 'error');
                return;
            }
            selectedDate = date;
            document.getElementById('m-fecha-turno').value = dateString;
            renderCalendarioModal();
            actualizarHorariosDisponibles();
            actualizarTextoSeleccionTurno();
        }
        
        function actualizarHorariosDisponibles() {
            horariosContainer.innerHTML = '';
            let horarios = [];
            
            if (selectedDate && esFechaDeFeria(selectedDate)) {
                 document.getElementById('info-capacidad').textContent = 'PERÍODO DE FERIA: 08:00 a 10:00 hs.';
                 for (let hour = 8; hour <= 10; hour++) {
                    for (let minute = 0; minute < 60; minute += 30) {
                        if (hour === 10 && minute > 0) break;
                        const hora = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        horarios.push({ hora, capacidad: 2 });
                    }
                }
            } else {
                document.getElementById('info-capacidad').textContent = 'Horarios normales.';
                Object.keys(capacidadHoraria).forEach(hora => {
                    const capacidad = capacidadHoraria[hora] || 2;
                    horarios.push({ hora, capacidad });
                });
            }
            
            horarios.forEach(({ hora, capacidad }) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'bg-white border border-gray-300 p-2 rounded text-sm hover:bg-blue-50 transition flex flex-col items-center justify-center';
                btn.innerHTML = `<span>${hora}</span><span class="text-xs text-gray-500">(${capacidad} cupos)</span>`;
                btn.dataset.hora = hora;
                btn.addEventListener('click', () => seleccionarHorario(hora));
                horariosContainer.appendChild(btn);
            });
        }
        
        function seleccionarHorario(hora) {
            selectedTime = hora;
            document.getElementById('m-horario-turno').value = hora;
            document.querySelectorAll('#horarios-container button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-white', 'text-gray-800');
            });
            const btnSel = document.querySelector(`button[data-hora="${hora}"]`);
            if(btnSel) {
                btnSel.classList.remove('bg-white', 'text-gray-800');
                btnSel.classList.add('bg-blue-600', 'text-white');
            }
            actualizarTextoSeleccionTurno();
        }
        
        function actualizarTextoSeleccionTurno() {
            if (selectedDate && selectedTime) {
                turnoTexto.textContent = `Turno asignado: ${formatDateForDisplay(selectedDate)} a las ${selectedTime} hs`;
                turnoTexto.parentElement.classList.replace('bg-blue-50', 'bg-green-50');
            } else if (selectedDate) {
                turnoTexto.textContent = `Fecha seleccionada: ${formatDateForDisplay(selectedDate)}. Falta hora.`;
                turnoTexto.parentElement.classList.replace('bg-green-50', 'bg-blue-50');
            } else {
                turnoTexto.textContent = 'No se ha asignado turno';
                turnoTexto.parentElement.classList.replace('bg-green-50', 'bg-blue-50');
            }
        }
        
        function usarHoraPersonalizada() {
            const val = document.getElementById('m-hora-personalizada').value;
            if(val) seleccionarHorario(val);
        }

        async function guardarNuevaConsulta(e) {
            e.preventDefault();
            const nuevoRegistro = {
                personName: document.getElementById('m-name').value.trim(),
                dni: document.getElementById('m-dni').value.trim(),
                telefono: document.getElementById('m-telefono').value.trim(),
                type: document.getElementById('m-type').value,
                assignedUser: usuarioActual,
                responsable: usuarioActual,
                description: document.getElementById('m-desc').value.trim(),
                estado: 'pendiente',
                timestamp: new Date().toISOString(),
                notas: [],
                origen: 'interno',
                fechaTurno: document.getElementById('m-fecha-turno').value || null,
                horarioTurno: document.getElementById('m-horario-turno').value || null
            };
            
            try {
                await push(ref(db, "atencion"), nuevoRegistro);
                document.getElementById('modal-registro').classList.add('hidden');
                mostrarNotificacion('Consulta creada exitosamente', 'success');
            } catch(err) {
                console.error(err);
                mostrarNotificacion('Error al guardar', 'error');
            }
        }

        // --- FUNCIONES MODALES ---

        function abrirModalRespuesta(caso) {
            casoParaResponder = caso;
            document.getElementById('resp-nombre').textContent = caso.personName || 'No registrado';
            document.getElementById('resp-dni').textContent = caso.dni || 'No registrado';
            document.getElementById('resp-telefono').textContent = caso.telefono || 'No registrado';
            document.getElementById('resp-email').textContent = caso.email || 'No registrado';
            document.getElementById('resp-descripcion').textContent = caso.description || 'Sin descripción';

            if (intervaloContadorRespuesta) clearInterval(intervaloContadorRespuesta);
            const actualizarContador = () => {
                const diff = new Date() - new Date(caso.timestamp);
                const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
                const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                document.getElementById('tiempo-texto').textContent = `${dias} días, ${horas} horas`;
                document.getElementById('tiempo-detalle').textContent = `Desde ${new Date(caso.timestamp).toLocaleDateString()}`;
                const contador = document.getElementById('contador-tiempo');
                contador.className = `tiempo-transcurrido ${dias < 2 ? 'tiempo-normal' : (dias < 7 ? 'tiempo-medio' : 'tiempo-alto')}`;
            };
            actualizarContador();
            intervaloContadorRespuesta = setInterval(actualizarContador, 60000);

            const histDiv = document.getElementById('historial-respuestas');
            histDiv.innerHTML = '';
            const comms = (caso.notas || []).filter(n => n.tipo === 'comunicacion');
            if (comms.length > 0) {
                comms.forEach(c => {
                   histDiv.innerHTML += `
                        <div class="bg-white rounded p-3 border mb-2">
                             <div class="flex justify-between items-start mb-1">
                                <span class="text-xs font-bold ${c.canal==='whatsapp'?'text-green-600':'text-blue-600'}">
                                    <i class="fas ${c.canal==='whatsapp'?'fa-whatsapp':'fa-envelope'} mr-1"></i> ${c.canal}
                                </span>
                                <span class="text-xs text-gray-500">${new Date(c.fecha).toLocaleString()}</span>
                             </div>
                             <p class="text-gray-800">${c.texto}</p>
                        </div>
                   `; 
                });
            } else {
                histDiv.innerHTML = '<div class="text-center py-4 text-gray-500">No hay comunicaciones previas.</div>';
            }
            document.getElementById('resp-mensaje').value = '';
            abrirModal('modal-respuesta-cliente');
        }

        function inicializarPlantillasRapidas() {
            document.querySelectorAll('.plantilla-rapida').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const plantilla = e.target.dataset.plantilla;
                    let mensaje = '';
                    switch(plantilla) {
                        case 'confirmacion': mensaje = 'Le confirmamos su turno asignado. Por favor, asegúrese de llegar con 10 minutos de anticipación.'; break;
                        case 'informacion': mensaje = 'Necesitamos que nos proporcione la siguiente información/documentación: [especificar].'; break;
                        case 'resolucion': mensaje = 'Nos complace informarle que su caso ha sido resuelto. Puede acercarse a retirar la documentación.'; break;
                    }
                    document.getElementById('resp-mensaje').value = mensaje;
                });
            });
        }

        async function enviarWhatsapp() {
            if(!casoParaResponder) return;
            const tel = document.getElementById('resp-telefono').textContent.replace(/\D/g,'');
            const msg = document.getElementById('resp-mensaje').value;
            const asunto = document.getElementById('resp-asunto').options[document.getElementById('resp-asunto').selectedIndex].text;
            
            if(!tel) return alert("Sin teléfono válido");
            if(!msg) return alert("Escriba un mensaje");

            const fullMsg = `*${asunto}*\n\n${msg}\n\nAtentamente,\nDefensoría Civil y Comercial N6`;
            window.open(`https://wa.me/${tel}?text=${encodeURIComponent(fullMsg)}`, '_blank');
            await registrarComunicacion(casoParaResponder.id, msg, 'whatsapp');
            document.getElementById('modal-respuesta-cliente').classList.add('hidden');
        }

        async function enviarEmail() {
             if(!casoParaResponder) return;
             const mail = document.getElementById('resp-email').textContent;
             const msg = document.getElementById('resp-mensaje').value;
             if(!mail || !mail.includes('@')) return alert("Email inválido");
             window.open(`mailto:${mail}?body=${encodeURIComponent(msg)}`, '_blank');
             await registrarComunicacion(casoParaResponder.id, msg, 'email');
             document.getElementById('modal-respuesta-cliente').classList.add('hidden');
        }

        async function registrarComunicacion(id, texto, canal) {
            const caso = allCases.find(c => c.id === id);
            const notas = caso.notas || [];
            notas.push({
                texto: texto, fecha: new Date().toISOString(), autor: usuarioActual, tipo: 'comunicacion', canal: canal
            });
            await update(ref(db, `atencion/${id}`), { notas });
        }

        function abrirModalDetalle() {
            if(!casoSeleccionado) return;
            const caso = allCases.find(c => c.id === casoSeleccionado);
            document.getElementById('detalle-nombre').textContent = caso.personName || 'No registrado';
            document.getElementById('detalle-dni').textContent = caso.dni || 'No registrado';
            document.getElementById('detalle-telefono-texto').textContent = caso.telefono || 'No registrado';
            document.getElementById('detalle-tipo').textContent = caso.type || '-';
            document.getElementById('detalle-descripcion').textContent = caso.description || '';
            document.getElementById('detalle-fecha').textContent = formatDateTimeForDisplay(new Date(caso.timestamp));
            document.getElementById('detalle-turno').textContent = caso.fechaTurno ? `${caso.fechaTurno} ${caso.horarioTurno||''}` : 'No asignado';
            
            const badgeColor = getBadgeColor(caso.estado);
            const estadoSpan = document.getElementById('detalle-estado-texto');
            estadoSpan.textContent = (caso.estado || 'pendiente').toUpperCase();
            estadoSpan.className = `px-2 py-1 rounded-full text-[10px] font-bold ${badgeColor}`;

            const btnWa = document.getElementById('btn-whatsapp-detalle');
            if(caso.telefono) {
                btnWa.style.display = 'inline-block';
                btnWa.onclick = () => window.open(`https://wa.me/${caso.telefono}`, '_blank');
            } else {
                btnWa.style.display = 'none';
            }

            const notasDiv = document.getElementById('detalle-observaciones');
            notasDiv.innerHTML = '';
            const notas = caso.notas || [];
            notas.sort((a,b) => new Date(b.fecha) - new Date(a.fecha));

            const totalNotas = notas.length + (caso.description ? 1 : 0);
            document.getElementById('contador-notas').textContent = `${totalNotas} observaciones`;

            if(caso.description) {
                 notasDiv.innerHTML += `
                    <div class="historial-item mb-3">
                        <p class="text-xs text-gray-500 mb-1"><i class="fas fa-file-alt mr-1"></i> Descripción Inicial</p>
                        <p class="text-sm">${caso.description}</p>
                    </div>`;
            }

            notas.forEach(n => {
                let extraClass = '';
                if(n.tipo === 'resuelta') extraClass = 'resuelto';
                if(n.tipo === 'derivado') extraClass = 'derivado';
                notasDiv.innerHTML += `
                    <div class="historial-item ${extraClass} mb-3">
                         <p class="text-xs text-gray-500 mb-1">
                            <i class="fas fa-sticky-note mr-1"></i> ${n.autor || 'Sistema'} - ${formatDateTimeForDisplay(n.fecha)}
                            ${n.tipo ? `<span class="ml-2 px-2 py-0.5 rounded text-xs bg-gray-200">${n.tipo.toUpperCase()}</span>` : ''}
                         </p>
                         <p class="text-sm">${n.texto}</p>
                    </div>
                `;
            });
            if(totalNotas === 0) notasDiv.innerHTML = '<p class="text-center text-gray-500 text-sm py-4">Sin observaciones.</p>';
            abrirModal('modal-detalle');
        }

        async function agregarNota() {
            if(!casoSeleccionado) return;
            const texto = document.getElementById('nueva-observacion').value.trim();
            if(!texto) return;
            const caso = allCases.find(c => c.id === casoSeleccionado);
            const notas = caso.notas || [];
            notas.push({ texto, fecha: new Date().toISOString(), autor: usuarioActual, tipo: 'nota' });
            await update(ref(db, `atencion/${casoSeleccionado}`), { notas });
            document.getElementById('nueva-observacion').value = '';
            abrirModalDetalle(); 
            mostrarNotificacion('Nota agregada', 'success');
        }

        async function cambiarEstadoActual(nuevoEstado) {
            if(!casoSeleccionado) return;
            const caso = allCases.find(c => c.id === casoSeleccionado);
            const notas = caso.notas || [];
            notas.push({ texto: `Estado cambiado a: ${nuevoEstado}`, fecha: new Date().toISOString(), autor: usuarioActual, tipo: nuevoEstado });
            const updateData = { estado: nuevoEstado, notas };
            if(nuevoEstado === 'resuelta') updateData.resueltoPor = usuarioActual;
            await update(ref(db, `atencion/${casoSeleccionado}`), updateData);
            abrirModalDetalle(); 
            mostrarNotificacion(`Estado actualizado a ${nuevoEstado}`, 'success');
        }

        async function marcarResuelto() {
            if(!casoSeleccionado) return;
            if(confirm("¿Marcar caso como Resuelto?")) {
                await cambiarEstadoActual('resuelta');
                mostrarNotificacion('Caso Resuelto', 'success');
            }
        }

        function llenarSelectDerivar() {
            const sel = document.getElementById('select-usuario-derivar');
            listaUsuarios.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u; opt.textContent = u; sel.appendChild(opt);
            });
        }

        async function derivarCaso() {
            const target = document.getElementById('select-usuario-derivar').value;
            if(!casoSeleccionado || !target) return;
            const caso = allCases.find(c => c.id === casoSeleccionado);
            const notas = caso.notas || [];
            notas.push({ texto: `Derivado a ${target}`, fecha: new Date().toISOString(), autor: usuarioActual, tipo: 'derivado' });
            await update(ref(db, `atencion/${casoSeleccionado}`), { assignedUser: target, estado: 'derivado', notas });
            document.getElementById('modal-derivar').classList.add('hidden');
            mostrarNotificacion(`Derivado a ${target}`, 'success');
        }

        function verComprobante(caso) {
            casoParaComprobante = caso;
            document.getElementById('comp-nombre').textContent = caso.personName;
            document.getElementById('comp-dni').textContent = caso.dni;
            const fechaTurnoFormateada = caso.fechaTurno ? formatShortDateForDisplay(caso.fechaTurno) : '';
            document.getElementById('comp-fecha').textContent = fechaTurnoFormateada;
            document.getElementById('comp-horario').textContent = caso.horarioTurno;
            abrirModal('modal-comprobante');
        }
        
        function descargarComprobante() {
            if(!casoParaComprobante) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            // Encabezado
            doc.setFontSize(16); doc.setTextColor(0, 0, 128);
            doc.text('Defensoría Civil y Comercial 6', 105, 20, { align: 'center' });
            doc.setFontSize(14); doc.setTextColor(0, 0, 0);
            doc.text('COMPROBANTE DE TURNO', 105, 30, { align: 'center' });
            // Línea separadora
            doc.setDrawColor(0, 0, 128); doc.setLineWidth(0.5); doc.line(20, 35, 190, 35);
            // Datos
            doc.setFontSize(12);
            let y = 50;
            const datos = [
                { label: 'Ciudadano:', value: casoParaComprobante.personName || '-' },
                { label: 'DNI:', value: casoParaComprobante.dni || '-' },
                { label: 'Fecha:', value: casoParaComprobante.fechaTurno ? `${formatShortDateForDisplay(casoParaComprobante.fechaTurno)}` : '-' },
                { label: 'Hora:', value: casoParaComprobante.horarioTurno || '-' },
                { label: 'Atendido por:', value: casoParaComprobante.assignedUser || '-' }
            ];
            datos.forEach(dato => {
                doc.setFont('helvetica', 'bold'); doc.text(dato.label, 20, y);
                doc.setFont('helvetica', 'normal'); doc.text(dato.value, 60, y);
                y += 10;
            });
            doc.save(`Turno_${casoParaComprobante.dni}.pdf`);
        }

        function exportarPDF() {
            if (casosAsignados.length === 0) {
                mostrarNotificacion('No hay casos para exportar', 'error');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            // Encabezado
            doc.setFontSize(16); doc.setTextColor(0, 0, 128);
            doc.text('Defensoría Civil y Comercial 6', 105, 15, { align: 'center' });
            doc.setFontSize(12); doc.setTextColor(0, 0, 0);
            doc.text(`Mis Casos Asignados: ${usuarioActual}`, 105, 22, { align: 'center' });
            doc.text(`Generado: ${formatDateTimeForDisplay(new Date())}`, 105, 28, { align: 'center' });
            
            // Tabla
            const datosTabla = casosAsignados.map(r => [
                r.timestamp ? formatShortDateForDisplay(new Date(r.timestamp)) : '',
                r.personName?.substring(0, 20) || '',
                r.dni || '',
                (r.type || '').substring(0, 15),
                r.estado || ''
            ]);

            doc.autoTable({
                head: [['Fecha', 'Nombre', 'DNI', 'Tipo', 'Estado']],
                body: datosTabla,
                startY: 35,
                margin: { left: 10, right: 10 },
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [59, 130, 246], textColor: 255 },
                alternateRowStyles: { fillColor: [240, 240, 240] }
            });
            doc.save(`Mis_Casos_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function renderizarCalendario() {
            const grid = document.getElementById('calendario-grid');
            grid.innerHTML = '';
            const hoy = new Date().toISOString().split('T')[0];
            const turnosHoy = casosAsignados.filter(c => c.fechaTurno === hoy);
            if(turnosHoy.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full text-center">No tienes turnos para hoy.</p>';
                return;
            }
            turnosHoy.sort((a,b) => (a.horarioTurno || '').localeCompare(b.horarioTurno || ''));
            turnosHoy.forEach(c => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded shadow border-l-4 border-green-500 hover:shadow-lg transition-shadow cursor-pointer";
                card.innerHTML = `
                    <p class="font-bold text-lg text-green-700">${c.horarioTurno || 'Sin Hora'}</p>
                    <p class="font-semibold">${c.personName}</p>
                    <p class="text-xs text-gray-500">${c.type}</p>
                `;
                card.onclick = () => { cambiarVista('casos'); };
                grid.appendChild(card);
            });
        }

        // --- UTILIDADES UI ---
        function cambiarVista(vista) {
            dashboardSection.classList.toggle('hidden', vista !== 'casos');
            calendarioSection.classList.toggle('hidden', vista !== 'calendario');
            const activeClass = ['bg-blue-600', 'text-white'];
            const inactiveClass = ['bg-gray-200', 'text-gray-700'];
            const setBtn = (id, active) => {
                const el = document.getElementById(id);
                if(active) { el.classList.add(...activeClass); el.classList.remove(...inactiveClass); } 
                else { el.classList.add(...inactiveClass); el.classList.remove(...activeClass); }
            };
            setBtn('btn-ver-casos', vista === 'casos');
            setBtn('btn-ver-calendario', vista === 'calendario');
            setBtn('btn-ver-casos-cal', vista === 'casos');
            setBtn('btn-ver-calendario-cal', vista === 'calendario');
        }

        function abrirModal(id) { document.getElementById(id).classList.remove('hidden'); }
        
        function mostrarNotificacion(msg, type='info') {
            const div = document.createElement('div');
            div.className = `p-3 rounded shadow text-white mb-2 ${type==='error'?'bg-red-500':(type==='success'?'bg-green-500':'bg-blue-500')}`;
            div.textContent = msg;
            document.getElementById('notification-temp-container').appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
    </script>
</body>
</html>
