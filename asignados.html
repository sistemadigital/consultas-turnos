<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Casos Asignados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* ---------------------------------------------------- */
        /* ESTILOS GENERALES Y MODALES                          */
        /* ---------------------------------------------------- */
        
        .modal-feriado-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(5px); z-index: 99999; display: flex;
            align-items: center; justify-content: center; padding: 1rem;
            animation: fadeInOverlay 0.3s ease-out;
        }

        .modal-feriado {
            background: white; width: 100%; max-width: 480px;
            border-radius: 16px; border: 1px solid #fecaca;
            box-shadow: 0 20px 25px -5px rgba(220, 38, 38, 0.15);
            animation: floatUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-feriado-header {
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
            color: white; padding: 20px 24px; display: flex;
            align-items: center; justify-content: space-between;
        }

        .modal-feriado-header h3 { font-size: 1.25rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 12px; }
        .modal-feriado-body { padding: 32px 24px; text-align: center; background: #fff; }
        .modal-feriado-footer { padding: 16px 24px; background: #fef2f2; border-top: 1px solid #fee2e2; text-align: center; }
        
        .login-container { min-height: 100vh; background: white; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); width: 100%; max-width: 420px; overflow: hidden; }
        .login-header { background: linear-gradient(to right, #1e3a8a, #3b82f6); color: white; padding: 25px 30px; text-align: center; }
        .login-body { padding: 35px 30px; }
        
        .login-input { width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s; }
        .login-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none; }
        
        .login-btn { width: 100%; background: linear-gradient(to right, #1e3a8a, #3b82f6); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3); }

        .estado-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; display: inline-block; }
        .estado-pendiente { background: #fef3c7; color: #92400e; }
        .estado-proceso { background: #dbeafe; color: #1e40af; }
        .estado-resuelto { background: #d1fae5; color: #065f46; }
        .estado-derivado { background: #f3e8ff; color: #5b21b6; }
        .respuesta-pendiente { background: #fee2e2; color: #dc2626; }
        .respuesta-enviada { background: #d1fae5; color: #065f46; }

        .hidden { display: none !important; }
        .pulse-new { animation: pulseNew 2s infinite; }
        @keyframes pulseNew { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        @keyframes floatUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }
        
        /* Modal Respuesta */
        #modal-respuesta-cliente { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        #modal-respuesta-cliente:not(.hidden) { display: flex !important; }
        
        .tiempo-transcurrido { padding: 12px; border-radius: 10px; font-weight: bold; text-align: center; transition: all 0.3s; }
        .tiempo-normal { background-color: #dbeafe; color: #1e40af; border: 2px solid #93c5fd; }
        .tiempo-medio { background-color: #fef3c7; color: #92400e; border: 2px solid #fbbf24; }
        .tiempo-alto { background-color: #fee2e2; color: #991b1b; border: 2px solid #fca5a5; }
        .historial-item { border-left: 3px solid #3b82f6; padding-left: 10px; background: white; padding: 8px; border-radius: 4px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* Paginación */
        .pagination-container { display: flex; flex-direction: column; align-items: center; padding: 1rem; border-top: 1px solid #e5e7eb; background-color: #f9fafb; }
        .pagination-controls { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .pagination-btn { padding: 0.375rem 0.75rem; border: 1px solid #d1d5db; background: white; border-radius: 0.375rem; cursor: pointer; }
        .pagination-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        @media (max-width: 768px) { .table-responsive { overflow-x: auto; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <div id="system-unavailable-overlay" class="modal-feriado-overlay hidden">
        <div class="modal-feriado">
            <div class="modal-feriado-header">
                <h3><i class="fas fa-calendar-times"></i> Atención: Día Inhábil</h3>
                <button id="modal-feriado-close" class="text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-feriado-body"><p id="system-unavailable-message"></p></div>
            <div class="modal-feriado-footer"><p><i class="fas fa-lock"></i> Función no disponible.</p></div>
        </div>
    </div>

    <div id="notification-temp-container" class="fixed top-4 right-4 z-40 space-y-2"></div>

    <section id="login-section" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1 class="text-2xl font-bold text-white">Consultas y Turnos</h1>
                <p class="text-white text-opacity-90 mt-2">Acceso Personal</p>
            </div>
            <div class="login-body">
                <form id="login-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-user mr-2"></i>Usuario</label>
                        <input type="text" id="login-input" class="login-input" placeholder="Nombre Apellido" required list="usuarios-lista">
                        <datalist id="usuarios-lista">
                            <option value="Bazante Nadia Romina">
                            <option value="Boillat Cesar Enrique">
                            <option value="Cardozo Maria Raquel">
                            <option value="Cedron Noelia Aurora">
                            <option value="Corrales Alicia Mariela">
                            <option value="Escobar Monica Graciela">
                            <option value="Fioravante Romulo">
                            <option value="Gonzalez Alberto Misael">
                            <option value="Gonzalez Juan Jose">
                            <option value="Gudiño Natalia Esther">
                            <option value="Magnani Enzo Luciano">
                            <option value="Pablos Patricia">
                            <option value="Palacios Ana Gabriela">
                            <option value="Ortega Lucia Noemi">
                            <option value="Ramos Marcelo Gustavo">
                            <option value="Riveros Patricia Soledad">
                            <option value="Sosa Rita Cecilia">
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-key mr-2"></i>Clave</label>
                        <input type="password" id="login-password" class="login-input" placeholder="Tu clave" required>
                    </div>
                    <button type="submit" class="login-btn"><i class="fas fa-sign-in-alt mr-2"></i>Ingresar</button>
                </form>
            </div>
        </div>
    </section>
    
    <section id="dashboard-section" class="hidden min-h-screen">
        <header class="bg-white shadow-sm border-b sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center mr-3"><i class="fas fa-user-shield text-white"></i></div>
                        <div>
                            <h1 class="text-lg font-bold text-gray-800">Mis Casos</h1>
                            <span id="user-name-display" class="text-sm font-bold text-blue-700"></span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                         <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-lg"><span class="font-bold" id="contador-pendientes">0</span> pend.</div>
                         <button class="btn-salir bg-red-100 text-red-700 px-3 py-1 rounded text-sm"><i class="fas fa-power-off"></i></button>
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button id="btn-ver-casos" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition-all-smooth"><i class="fas fa-list mr-2"></i>Lista</button>
                    <button id="btn-ver-calendario" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all-smooth"><i class="fas fa-calendar-day mr-2"></i>Calendario</button>
                </div>
            </div>
        </header>
        
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 flex flex-wrap gap-3">
                <button id="btn-nueva-consulta" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700"><i class="fas fa-plus-circle mr-2"></i>Nuevo</button>
                <button id="btn-marcar-resuelto" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 disabled:opacity-50" disabled><i class="fas fa-check-circle mr-2"></i>Resolver</button>
                <button id="btn-actualizar-consulta" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 disabled:opacity-50" disabled><i class="fas fa-edit mr-2"></i>Detalles/Notas</button>
                <button id="btn-derivar-caso" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700 disabled:opacity-50" disabled><i class="fas fa-share-alt mr-2"></i>Derivar</button>
            </div>
            
            <div class="mb-4 relative">
                <input type="text" id="input-busqueda" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg outline-none" placeholder="Buscar...">
                <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                <button id="btn-limpiar-busqueda" class="absolute right-3 top-3.5 text-gray-400 hidden"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="bg-white rounded-xl shadow overflow-hidden mb-8">
                <div class="px-6 py-4 border-b flex justify-between">
                    <h2 class="text-lg font-bold text-gray-800">Listado de Casos</h2>
                    <button id="btn-exportar-pdf" class="text-red-600 text-sm"><i class="fas fa-file-pdf"></i> PDF</button>
                </div>
                <div class="overflow-x-auto table-responsive">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ciudadano</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descripción</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Respuesta</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="casos-body" class="divide-y divide-gray-200"></tbody>
                    </table>
                    
                    <div id="pagination-container" class="pagination-container hidden">
                        <div class="pagination-info text-sm text-gray-500 mb-2">
                            <span id="pagination-start">0</span>-<span id="pagination-end">0</span> de <span id="pagination-total">0</span>
                        </div>
                        <div class="pagination-controls">
                            <button id="pagination-first" class="pagination-btn"><i class="fas fa-angle-double-left"></i></button>
                            <button id="pagination-prev" class="pagination-btn"><i class="fas fa-angle-left"></i></button>
                            <span id="pagination-numbers" class="flex gap-1"></span>
                            <button id="pagination-next" class="pagination-btn"><i class="fas fa-angle-right"></i></button>
                            <button id="pagination-last" class="pagination-btn"><i class="fas fa-angle-double-right"></i></button>
                        </div>
                    </div>

                    <div id="tabla-vacia" class="hidden p-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-4"></i><p>No tienes casos asignados.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <section id="calendario-section" class="hidden min-h-screen">
        <header class="bg-white shadow-sm border-b sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center mr-3"><i class="fas fa-calendar-alt text-white"></i></div>
                    <h1 class="text-lg font-bold text-gray-800">Mi Calendario</h1>
                </div>
                <button class="btn-salir bg-red-100 text-red-700 px-3 py-1 rounded text-sm"><i class="fas fa-power-off"></i></button>
            </div>
            <div class="px-4 pb-3 max-w-7xl mx-auto">
                <button id="btn-ver-casos-cal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm mr-2"><i class="fas fa-list mr-2"></i>Lista</button>
                <button id="btn-ver-calendario-cal" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm"><i class="fas fa-calendar-day mr-2"></i>Calendario</button>
            </div>
        </header>
        <div class="max-w-7xl mx-auto px-4 py-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Turnos de Hoy</h2>
            <div id="calendario-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
        </div>
    </section>

    <div id="modal-respuesta-cliente" class="hidden">
        <div class="bg-white rounded-xl w-full max-w-4xl mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
            <div class="bg-blue-800 text-white p-4 flex justify-between font-bold sticky top-0">
                <span>Respuesta al Cliente</span>
                <button id="btn-cerrar-respuesta-cliente">&times;</button>
            </div>
            <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-bold mb-4">Datos del Cliente</h3>
                    <p class="text-sm"><strong>Nombre:</strong> <span id="resp-nombre"></span></p>
                    <p class="text-sm"><strong>DNI:</strong> <span id="resp-dni"></span></p>
                    <p class="text-sm"><strong>Tel:</strong> <span id="resp-telefono"></span></p>
                    <p class="text-sm"><strong>Email:</strong> <span id="resp-email"></span></p>
                    <p class="text-sm mt-2"><strong>Descripción:</strong></p>
                    <p id="resp-descripcion" class="text-sm bg-gray-50 p-2 rounded"></p>
                    <div id="contador-tiempo" class="mt-4 tiempo-transcurrido tiempo-normal">
                        <p id="tiempo-texto">Calculando...</p>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold mb-4">Enviar Respuesta</h3>
                    <select id="resp-asunto" class="w-full border p-2 mb-2 rounded"><option value="confirmacion_turno">Confirmación Turno</option><option value="info">Información</option></select>
                    <textarea id="resp-mensaje" rows="4" class="w-full border p-2 mb-2 rounded" placeholder="Mensaje..."></textarea>
                    <div class="flex gap-2 mb-4">
                        <button id="btn-enviar-whatsapp" class="bg-green-600 text-white px-3 py-2 rounded flex-1"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                        <button id="btn-enviar-email" class="bg-blue-600 text-white px-3 py-2 rounded flex-1"><i class="fas fa-envelope"></i> Email</button>
                    </div>
                    <div class="bg-gray-50 p-2 rounded max-h-40 overflow-y-auto">
                        <h4 class="text-xs font-bold mb-2">Historial</h4>
                        <div id="historial-respuestas" class="text-xs space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-detalle" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="bg-blue-600 text-white p-4 flex justify-between">
                <h3 class="font-bold">Detalles / Notas Internas</h3>
                <button id="btn-cerrar-detalle">&times;</button>
            </div>
            <div class="p-6">
                <p><strong>Ciudadano:</strong> <span id="detalle-nombre"></span></p>
                <p><strong>Desc:</strong> <span id="detalle-descripcion"></span></p>
                <hr class="my-4">
                <h4 class="font-bold mb-2">Notas Anteriores</h4>
                <div id="detalle-observaciones" class="bg-gray-50 p-2 mb-4 max-h-40 overflow-y-auto text-sm"></div>
                <textarea id="nueva-observacion" rows="3" class="w-full border p-2 rounded" placeholder="Nueva nota interna..."></textarea>
                <div class="flex justify-end mt-4 gap-2">
                    <button id="btn-cancelar-detalle" class="px-4 py-2 bg-gray-200 rounded">Cerrar</button>
                    <button id="btn-guardar-actualizacion" class="px-4 py-2 bg-blue-600 text-white rounded">Guardar Nota</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="modal-derivar" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded p-6 max-w-md w-full">
            <h3 class="font-bold mb-4">Derivar Caso</h3>
            <select id="select-usuario-derivar" class="w-full border p-2 mb-4 rounded"></select>
            <div class="flex justify-end gap-2">
                <button id="btn-cancelar-derivar" class="px-4 py-2 bg-gray-200 rounded">Cancelar</button>
                <button id="btn-confirmar-derivar" class="px-4 py-2 bg-purple-600 text-white rounded">Derivar</button>
            </div>
        </div>
    </div>

    <div id="modal-comprobante" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded p-6 max-w-md w-full">
            <h3 class="font-bold mb-4 text-center">Comprobante Turno</h3>
            <div class="space-y-2 mb-4">
                <p><strong>Nombre:</strong> <span id="comp-nombre"></span></p>
                <p><strong>DNI:</strong> <span id="comp-dni"></span></p>
                <p><strong>Fecha:</strong> <span id="comp-fecha"></span> <span id="comp-horario"></span></p>
            </div>
            <div class="flex justify-end gap-2">
                <button id="btn-cerrar-comprobante" class="px-4 py-2 bg-gray-200 rounded">Cerrar</button>
                <button id="btn-descargar-comprobante" class="px-4 py-2 bg-red-600 text-white rounded">PDF</button>
            </div>
        </div>
    </div>

    <div id="modal-nueva-consulta" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="bg-green-600 text-white p-4 flex justify-between">
                <h3 class="font-bold">Nueva Consulta</h3>
                <button id="btn-cerrar-nueva-consulta">&times;</button>
            </div>
            <form id="form-nueva-consulta" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="input-nombre" placeholder="Nombre *" class="border p-2 rounded" required>
                <input type="text" id="input-dni" placeholder="DNI" class="border p-2 rounded">
                <input type="text" id="input-telefono" placeholder="Teléfono" class="border p-2 rounded">
                <select id="select-tipo-consulta" class="border p-2 rounded">
                    <option value="Presencial">Presencial</option>
                    <option value="Telefónica">Telefónica</option>
                    <option value="WhatsApp">WhatsApp</option>
                </select>
                <textarea id="textarea-descripcion" placeholder="Descripción" class="border p-2 rounded md:col-span-2"></textarea>
                
                <div class="md:col-span-2 border p-4 rounded bg-gray-50">
                    <p class="font-bold mb-2">Asignar Turno (Opcional)</p>
                    <div class="flex gap-2 mb-2">
                        <input type="date" id="input-fecha-turno" class="border p-2 rounded">
                        <select id="input-horario-turno" class="border p-2 rounded">
                            <option value="">Hora...</option>
                            <option>07:00</option><option>07:30</option><option>08:00</option><option>08:30</option>
                            <option>09:00</option><option>09:30</option><option>10:00</option><option>10:30</option><option>11:00</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="bg-green-600 text-white py-2 rounded md:col-span-2 font-bold">Guardar</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDgxLS98sk6GkLrjMu3BVS2cmZ9exdh4dY",
            authDomain: "atencion-publico-def6.firebaseapp.com",
            databaseURL: "https://atencion-publico-def6-default-rtdb.firebaseio.com",
            projectId: "atencion-publico-def6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // --- NORMALIZACIÓN DE TEXTO (LA CLAVE DE LA SOLUCIÓN) ---
        function normalizarTexto(str) {
            if (!str) return "";
            return str.toString()
                      .toLowerCase()
                      .trim()
                      .normalize("NFD")
                      .replace(/[\u0300-\u036f]/g, ""); // Quita tildes pero deja la ñ si es base
        }

        // Listas Sincronizadas con Interno.html (Sin tildes visuales para evitar confusión)
        const listaUsuarios = [
            "Bazante Nadia Romina", "Boillat Cesar Enrique", "Cardozo Maria Raquel",
            "Cedron Noelia Aurora", "Corrales Alicia Mariela", "Escobar Monica Graciela",
            "Fioravante Romulo", "Gonzalez Alberto Misael", "Gonzalez Juan Jose",
            "Gudiño Natalia Esther", "Magnani Enzo Luciano", "Pablos Patricia",
            "Palacios Ana Gabriela", "Ortega Lucia Noemi", "Ramos Marcelo Gustavo",
            "Riveros Patricia Soledad", "Sosa Rita Cecilia"
        ];

        const clavesUsuarios = {
            "Bazante Nadia Romina": "bazante123",
            "Boillat Cesar Enrique": "boillat123",
            "Cardozo Maria Raquel": "cardozo123",
            "Cedron Noelia Aurora": "cedron123",
            "Corrales Alicia Mariela": "corrales123",
            "Escobar Monica Graciela": "escobar123",
            "Fioravante Romulo": "fioravante123",
            "Gonzalez Alberto Misael": "gonzalez123",
            "Gonzalez Juan Jose": "gonzalezjj123",
            "Gudiño Natalia Esther": "gudino123",
            "Magnani Enzo Luciano": "magnani123",
            "Pablos Patricia": "pablos123",
            "Palacios Ana Gabriela": "palacios123",
            "Ortega Lucia Noemi": "ortega123",
            "Ramos Marcelo Gustavo": "ramos123",
            "Riveros Patricia Soledad": "riveros123",
            "Sosa Rita Cecilia": "sosa123"
        };

        // Estado
        let usuarioActual = null;
        let allCases = []; 
        let casosAsignados = [];
        let casoSeleccionado = null;
        let casoSeleccionadoDetalle = null;
        let casoParaResponder = null;
        let casoParaComprobante = null;
        let intervaloContadorRespuesta = null;
        let paginaActual = 1;
        let registrosPorPagina = 10;
        let terminoBusqueda = '';

        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const calendarioSection = document.getElementById('calendario-section');
        const casosBody = document.getElementById('casos-body');
        
        document.addEventListener('DOMContentLoaded', () => {
            verificarSesion();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('login-form').addEventListener('submit', manejarLogin);
            
            // Navegación
            document.querySelectorAll('.btn-salir').forEach(b => b.addEventListener('click', cerrarSesion));
            document.getElementById('btn-ver-casos').addEventListener('click', () => cambiarVista('casos'));
            document.getElementById('btn-ver-calendario').addEventListener('click', () => cambiarVista('calendario'));
            document.getElementById('btn-ver-casos-cal').addEventListener('click', () => cambiarVista('casos'));
            document.getElementById('btn-ver-calendario-cal').addEventListener('click', () => cambiarVista('calendario'));
            
            // Acciones Casos
            document.getElementById('btn-marcar-resuelto').addEventListener('click', marcarResuelto);
            document.getElementById('btn-derivar-caso').addEventListener('click', () => abrirModal('modal-derivar'));
            document.getElementById('btn-actualizar-consulta').addEventListener('click', abrirModalDetalle);
            document.getElementById('btn-nueva-consulta').addEventListener('click', () => abrirModal('modal-nueva-consulta'));
            
            // Modales Cancelar/Cerrar
            const closeMap = {
                'btn-cerrar-respuesta-cliente': 'modal-respuesta-cliente',
                'btn-cerrar-detalle': 'modal-detalle',
                'btn-cancelar-detalle': 'modal-detalle',
                'btn-cancelar-derivar': 'modal-derivar',
                'btn-cerrar-comprobante': 'modal-comprobante',
                'btn-cerrar-nueva-consulta': 'modal-nueva-consulta'
            };
            Object.keys(closeMap).forEach(id => {
                document.getElementById(id).addEventListener('click', () => cerrarModal(closeMap[id]));
            });

            // Funciones Modales
            document.getElementById('btn-guardar-actualizacion').addEventListener('click', guardarNota);
            document.getElementById('btn-confirmar-derivar').addEventListener('click', derivarCaso);
            document.getElementById('btn-enviar-whatsapp').addEventListener('click', enviarWhatsapp);
            document.getElementById('btn-enviar-email').addEventListener('click', enviarEmail);
            document.getElementById('form-nueva-consulta').addEventListener('submit', guardarNuevaConsulta);
            document.getElementById('btn-descargar-comprobante').addEventListener('click', descargarComprobante);
            
            // Buscador
            document.getElementById('input-busqueda').addEventListener('input', (e) => {
                terminoBusqueda = normalizarTexto(e.target.value);
                paginaActual = 1;
                renderizarCasos();
            });
            document.getElementById('btn-limpiar-busqueda').addEventListener('click', () => {
                 document.getElementById('input-busqueda').value = '';
                 terminoBusqueda = '';
                 renderizarCasos();
            });

            // Paginación
            document.getElementById('pagination-prev').addEventListener('click', () => cambiarPagina(paginaActual - 1));
            document.getElementById('pagination-next').addEventListener('click', () => cambiarPagina(paginaActual + 1));
            
            // Exportar
            document.getElementById('btn-exportar-pdf').addEventListener('click', exportarPDF);
            
            llenarSelectDerivar();
        }

        // --- AUTH & DATA ---
        function verificarSesion() {
            const user = localStorage.getItem('defensoriaUsuario');
            if (user) iniciarSesion(user);
        }

        function manejarLogin(e) {
            e.preventDefault();
            const inputUser = document.getElementById('login-input').value.trim();
            const inputPass = document.getElementById('login-password').value.trim();
            
            // Buscar usuario normalizando nombres para ser flexible
            const userMatch = listaUsuarios.find(u => normalizarTexto(u) === normalizarTexto(inputUser));
            
            if (userMatch && clavesUsuarios[userMatch] === inputPass) {
                localStorage.setItem('defensoriaUsuario', userMatch);
                iniciarSesion(userMatch);
            } else {
                mostrarNotificacion('Credenciales incorrectas', 'error');
            }
        }

        function iniciarSesion(user) {
            usuarioActual = user;
            document.getElementById('user-name-display').textContent = user;
            loginSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
            cargarCasos();
        }

        function cerrarSesion() {
            localStorage.removeItem('defensoriaUsuario');
            location.reload();
        }

        // --- LOGICA DE DATOS (FIREBASE) ---
        function cargarCasos() {
            const casosRef = ref(db, "atencion");
            onValue(casosRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    allCases = Object.entries(data).map(([id, val]) => ({ id, ...val }))
                        .sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
                    
                    filtrarCasosUsuario();
                } else {
                    allCases = [];
                    renderizarCasos();
                }
            });
        }

        // ***** LA FUNCIÓN CRÍTICA CORREGIDA *****
        function filtrarCasosUsuario() {
            if (!usuarioActual) return;
            
            const miUsuarioNorm = normalizarTexto(usuarioActual);
            
            casosAsignados = allCases.filter(c => {
                if (!c.assignedUser) return false;
                // Compara ignorando tildes y mayúsculas
                return normalizarTexto(c.assignedUser) === miUsuarioNorm;
            });
            
            document.getElementById('contador-pendientes').textContent = 
                casosAsignados.filter(c => c.estado === 'pendiente').length;
                
            renderizarCasos();
            renderizarCalendario();
        }

        function renderizarCasos() {
            casosBody.innerHTML = '';
            
            // Filtrado por buscador local
            let filtrados = casosAsignados;
            if (terminoBusqueda) {
                filtrados = casosAsignados.filter(c => 
                    normalizarTexto(c.personName).includes(terminoBusqueda) ||
                    (c.dni && c.dni.includes(terminoBusqueda)) ||
                    normalizarTexto(c.description).includes(terminoBusqueda)
                );
            }

            // Paginación
            const total = filtrados.length;
            const totalPaginas = Math.ceil(total / registrosPorPagina);
            if (paginaActual > totalPaginas) paginaActual = 1;
            
            const start = (paginaActual - 1) * registrosPorPagina;
            const end = start + registrosPorPagina;
            const paginaData = filtrados.slice(start, end);

            // Actualizar UI Paginación
            document.getElementById('pagination-container').classList.toggle('hidden', total === 0);
            document.getElementById('pagination-start').textContent = total > 0 ? start + 1 : 0;
            document.getElementById('pagination-end').textContent = Math.min(end, total);
            document.getElementById('pagination-total').textContent = total;
            document.getElementById('pagination-prev').disabled = paginaActual === 1;
            document.getElementById('pagination-next').disabled = paginaActual >= totalPaginas;

            if (total === 0) {
                document.getElementById('tabla-vacia').classList.remove('hidden');
                return;
            }
            document.getElementById('tabla-vacia').classList.add('hidden');

            paginaData.forEach(caso => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 cursor-pointer transition-colors border-b";
                if(casoSeleccionado === caso.id) tr.classList.add('bg-blue-100');
                
                // Color Estado
                let badgeClass = 'estado-proceso';
                if(caso.estado === 'pendiente') badgeClass = 'estado-pendiente';
                if(caso.estado === 'resuelta') badgeClass = 'estado-resuelto';

                const tieneRespuesta = caso.respuestas && caso.respuestas.length > 0;
                
                tr.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="font-bold text-gray-800">${caso.personName || 'Sin Nombre'}</div>
                        <div class="text-xs text-gray-500">${caso.dni || ''} - ${caso.telefono || ''}</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 truncate max-w-xs">${caso.description || caso.type}</td>
                    <td class="px-4 py-3 text-sm">${new Date(caso.timestamp).toLocaleDateString()}</td>
                    <td class="px-4 py-3"><span class="estado-badge ${badgeClass}">${caso.estado}</span></td>
                    <td class="px-4 py-3">
                        <span class="estado-badge ${tieneRespuesta ? 'respuesta-enviada' : 'respuesta-pendiente'}">
                            ${tieneRespuesta ? 'Enviada' : 'Pendiente'}
                        </span>
                    </td>
                    <td class="px-4 py-3 flex gap-2">
                        <button class="btn-select text-blue-600 hover:text-blue-800" title="Seleccionar"><i class="fas fa-check-circle"></i></button>
                        <button class="btn-resp text-purple-600 hover:text-purple-800" title="Responder"><i class="fas fa-reply"></i></button>
                        ${caso.fechaTurno ? `<button class="btn-pdf text-red-600 hover:text-red-800"><i class="fas fa-file-pdf"></i></button>` : ''}
                    </td>
                `;
                
                // Eventos de fila
                tr.querySelector('.btn-select').addEventListener('click', (e) => { e.stopPropagation(); seleccionarCaso(caso.id); });
                tr.querySelector('.btn-resp').addEventListener('click', (e) => { e.stopPropagation(); abrirModalRespuesta(caso); });
                if(tr.querySelector('.btn-pdf')) tr.querySelector('.btn-pdf').addEventListener('click', (e) => { e.stopPropagation(); verComprobante(caso); });
                
                tr.addEventListener('click', () => seleccionarCaso(caso.id));
                casosBody.appendChild(tr);
            });
        }
        
        function cambiarPagina(pag) {
            paginaActual = pag;
            renderizarCasos();
        }

        function seleccionarCaso(id) {
            casoSeleccionado = id;
            document.querySelectorAll('button:disabled').forEach(b => b.disabled = false);
            renderizarCasos(); // Para actualizar el bg de la fila
        }

        // --- FUNCIONES MODALES ---

        // 1. Respuesta
        function abrirModalRespuesta(caso) {
            casoParaResponder = caso;
            document.getElementById('resp-nombre').textContent = caso.personName;
            document.getElementById('resp-dni').textContent = caso.dni;
            document.getElementById('resp-telefono').textContent = caso.telefono;
            document.getElementById('resp-email').textContent = caso.email || '-';
            document.getElementById('resp-descripcion').textContent = caso.description;
            
            // Historial
            const histDiv = document.getElementById('historial-respuestas');
            histDiv.innerHTML = '';
            if(caso.respuestas) {
                caso.respuestas.forEach(r => {
                    histDiv.innerHTML += `<div class="border-l-2 border-blue-500 pl-2 mb-2"><p class="font-bold">${r.modo}</p><p>${r.mensaje}</p></div>`;
                });
            } else {
                histDiv.innerHTML = 'Sin respuestas previas.';
            }

            // Tiempo
            if(intervaloContadorRespuesta) clearInterval(intervaloContadorRespuesta);
            intervaloContadorRespuesta = setInterval(() => {
                const diff = new Date() - new Date(caso.timestamp);
                const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
                document.getElementById('tiempo-texto').textContent = `${dias} días transcurridos`;
            }, 1000);

            abrirModal('modal-respuesta-cliente');
        }

        async function enviarWhatsapp() {
            if(!casoParaResponder) return;
            const tel = document.getElementById('resp-telefono').textContent.replace(/\D/g,'');
            const msg = document.getElementById('resp-mensaje').value;
            if(!tel) return alert("Sin teléfono");
            
            window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`, '_blank');
            await registrarRespuesta(casoParaResponder.id, msg, 'WhatsApp');
            cerrarModal('modal-respuesta-cliente');
        }

        async function enviarEmail() {
            if(!casoParaResponder) return;
            const mail = document.getElementById('resp-email').textContent;
            const msg = document.getElementById('resp-mensaje').value;
            if(!mail || !mail.includes('@')) return alert("Email inválido");
            
            window.open(`mailto:${mail}?body=${encodeURIComponent(msg)}`, '_blank');
            await registrarRespuesta(casoParaResponder.id, msg, 'Email');
            cerrarModal('modal-respuesta-cliente');
        }

        async function registrarRespuesta(id, mensaje, modo) {
            const casoRef = ref(db, `atencion/${id}`);
            // Obtenemos snapshot actual para no sobrescribir arrays
            const caso = allCases.find(c => c.id === id);
            const respuestas = caso.respuestas || [];
            respuestas.push({
                fecha: new Date().toISOString(),
                usuario: usuarioActual,
                mensaje, modo
            });
            await update(casoRef, { respuestas });
        }

        // 2. Detalle / Notas
        function abrirModalDetalle() {
            if(!casoSeleccionado) return;
            const caso = allCases.find(c => c.id === casoSeleccionado);
            casoSeleccionadoDetalle = caso;
            
            document.getElementById('detalle-nombre').textContent = caso.personName;
            document.getElementById('detalle-descripcion').textContent = caso.description;
            
            const notasDiv = document.getElementById('detalle-observaciones');
            notasDiv.innerHTML = '';
            if(caso.notas) {
                caso.notas.forEach(n => {
                    notasDiv.innerHTML += `<div class="mb-2 text-xs border-b"><span class="font-bold">${n.usuario}</span>: ${n.texto}</div>`;
                });
            } else {
                notasDiv.innerHTML = 'Sin notas.';
            }
            abrirModal('modal-detalle');
        }

        async function guardarNota() {
            if(!casoSeleccionadoDetalle) return;
            const texto = document.getElementById('nueva-observacion').value;
            if(!texto) return;
            
            const notas = casoSeleccionadoDetalle.notas || [];
            notas.push({
                fecha: new Date().toISOString(),
                usuario: usuarioActual,
                texto
            });
            
            await update(ref(db, `atencion/${casoSeleccionadoDetalle.id}`), { notas });
            document.getElementById('nueva-observacion').value = '';
            cerrarModal('modal-detalle');
        }

        // 3. Acciones Rápidas
        async function marcarResuelto() {
            if(!casoSeleccionado) return;
            if(confirm("¿Marcar caso como Resuelto?")) {
                await update(ref(db, `atencion/${casoSeleccionado}`), { estado: 'resuelta', resueltoPor: usuarioActual });
                mostrarNotificacion('Caso Resuelto', 'success');
            }
        }

        function llenarSelectDerivar() {
            const sel = document.getElementById('select-usuario-derivar');
            listaUsuarios.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                sel.appendChild(opt);
            });
        }

        async function derivarCaso() {
            const target = document.getElementById('select-usuario-derivar').value;
            if(!casoSeleccionado || !target) return;
            
            await update(ref(db, `atencion/${casoSeleccionado}`), { assignedUser: target, estado: 'derivado' });
            cerrarModal('modal-derivar');
            mostrarNotificacion(`Derivado a ${target}`, 'success');
        }
        
        // 4. Nueva Consulta
        async function guardarNuevaConsulta(e) {
            e.preventDefault();
            const data = {
                personName: document.getElementById('input-nombre').value,
                dni: document.getElementById('input-dni').value,
                telefono: document.getElementById('input-telefono').value,
                type: document.getElementById('select-tipo-consulta').value,
                description: document.getElementById('textarea-descripcion').value,
                assignedUser: usuarioActual,
                estado: 'pendiente',
                timestamp: new Date().toISOString(),
                // Campos opcionales de turno
                fechaTurno: document.getElementById('input-fecha-turno').value || null,
                horarioTurno: document.getElementById('input-horario-turno').value || null
            };
            
            await push(ref(db, "atencion"), data);
            cerrarModal('modal-nueva-consulta');
            document.getElementById('form-nueva-consulta').reset();
            mostrarNotificacion('Consulta creada', 'success');
        }

        // 5. Comprobante PDF
        function verComprobante(caso) {
            casoParaComprobante = caso;
            document.getElementById('comp-nombre').textContent = caso.personName;
            document.getElementById('comp-dni').textContent = caso.dni;
            document.getElementById('comp-fecha').textContent = caso.fechaTurno;
            document.getElementById('comp-horario').textContent = caso.horarioTurno;
            abrirModal('modal-comprobante');
        }
        
        function descargarComprobante() {
            if(!casoParaComprobante) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Defensoría Civil y Comercial N6", 105, 20, null, null, 'center');
            doc.setFontSize(14);
            doc.text("COMPROBANTE DE TURNO", 105, 30, null, null, 'center');
            
            doc.setFontSize(12);
            doc.text(`Nombre: ${casoParaComprobante.personName}`, 20, 50);
            doc.text(`DNI: ${casoParaComprobante.dni}`, 20, 60);
            doc.text(`Fecha: ${casoParaComprobante.fechaTurno} - Hora: ${casoParaComprobante.horarioTurno}`, 20, 70);
            doc.text(`Atendido por: ${casoParaComprobante.assignedUser}`, 20, 80);
            
            doc.save(`Turno_${casoParaComprobante.dni}.pdf`);
        }

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 10;
            doc.text(`Reporte de Casos - ${usuarioActual}`, 10, y);
            y += 10;
            
            casosAsignados.forEach(c => {
                if(y > 280) { doc.addPage(); y = 10; }
                doc.setFontSize(10);
                doc.text(`${c.timestamp.split('T')[0]} - ${c.personName} - ${c.estado}`, 10, y);
                y += 7;
            });
            doc.save('mis_casos.pdf');
        }

        // --- CALENDARIO ---
        function renderizarCalendario() {
            const grid = document.getElementById('calendario-grid');
            grid.innerHTML = '';
            const hoy = new Date().toISOString().split('T')[0];
            
            const turnosHoy = casosAsignados.filter(c => c.fechaTurno === hoy);
            
            if(turnosHoy.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full text-center">No tienes turnos para hoy.</p>';
                return;
            }
            
            turnosHoy.sort((a,b) => (a.horarioTurno || '').localeCompare(b.horarioTurno || ''));
            
            turnosHoy.forEach(c => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded shadow border-l-4 border-green-500 hover:shadow-lg transition-shadow cursor-pointer";
                card.innerHTML = `
                    <p class="font-bold text-lg text-green-700">${c.horarioTurno || 'Sin Hora'}</p>
                    <p class="font-semibold">${c.personName}</p>
                    <p class="text-xs text-gray-500">${c.type}</p>
                `;
                card.onclick = () => {
                    cambiarVista('casos');
                    // Pequeño hack para filtrar por ese caso si quisiéramos, por ahora solo vuelve a lista
                };
                grid.appendChild(card);
            });
        }

        // --- UTILIDADES UI ---
        function cambiarVista(vista) {
            dashboardSection.classList.toggle('hidden', vista !== 'casos');
            calendarioSection.classList.toggle('hidden', vista !== 'calendario');
            
            // Actualizar botones visualmente
            const activeClass = ['bg-blue-600', 'text-white'];
            const inactiveClass = ['bg-gray-200', 'text-gray-700'];
            
            const setBtn = (id, active) => {
                const el = document.getElementById(id);
                if(active) {
                    el.classList.add(...activeClass); el.classList.remove(...inactiveClass);
                } else {
                    el.classList.add(...inactiveClass); el.classList.remove(...activeClass);
                }
            };
            
            setBtn('btn-ver-casos', vista === 'casos');
            setBtn('btn-ver-calendario', vista === 'calendario');
            setBtn('btn-ver-casos-cal', vista === 'casos');
            setBtn('btn-ver-calendario-cal', vista === 'calendario');
        }

        function abrirModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function cerrarModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function mostrarNotificacion(msg, type='info') {
            const div = document.createElement('div');
            div.className = `p-3 rounded shadow text-white mb-2 ${type==='error'?'bg-red-500':(type==='success'?'bg-green-500':'bg-blue-500')}`;
            div.textContent = msg;
            document.getElementById('notification-temp-container').appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

    </script>
</body>
</html>
